<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>نظام الحضور</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Cairo', 'sans-serif'] },
          colors: {
            dark: {
              bg: '#0f172a',
              card: '#1e293b',
              input: '#334155'
            }
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .loader-sm { border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid #3b82f6; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .dark ::-webkit-scrollbar { width: 8px; height: 8px; }
    .dark ::-webkit-scrollbar-track { background: #1e293b; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background: white; color: black; }
      .dark body { background: white; color: black; }
      aside, nav, button, .mobile-header, .no-print { display: none !important; }
      main { margin: 0 !important; width: 100% !important; padding: 0 !important; }
      .max-w-6xl { max-width: none !important; }
      .dark .bg-gray-50, .dark .bg-white, .dark .bg-gray-800 { background-color: white !important; color: black !important; }
      td, th { border: 1px solid #ddd !important; }
      .print-only { display: block !important; }
    }
    .print-only { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    
    // --- إعدادات Supabase ---
    const SUPABASE_URL = "https://peuzohchnkpcesoatjdz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBldXpvaGNobmtwY2Vzb2F0amR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDM2MDYsImV4cCI6MjA4NzY3OTYwNn0.TFkjH9bRs5Rxa6gYvBlFpRXmAU28rri-RzeXH59gxQI";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- محرك الاتصال الجديد ---
    const runServer = async (action, payload = {}) => {
      try {
        if (action === 'login') {
            const res = await supabaseClient.from('users_data').select('*').eq('national_id', payload.nationalId).maybeSingle();
            if (res.error || !res.data) {
                return { status: 'error', message: 'الرقم القومي غير مسجل' };
            }
            if (!payload.password) {
                if (!res.data.password || res.data.password.trim() === '') {
                    return { status: 'create_password', role: res.data.role, name: res.data.full_name };
                }
                return { status: 'require_password', role: res.data.role, name: res.data.full_name };
            }
            if (res.data.password !== payload.password) {
                return { status: 'error', message: 'كلمة المرور غير صحيحة' };
            }
            return { status: 'success', role: res.data.role, name: res.data.full_name };
        }

        if (action === 'registerPassword' || action === 'changePassword') {
            const res = await supabaseClient.from('users_data').update({ password: payload.newPassword }).eq('national_id', payload.nationalId);
            if (res.error) {
                return { status: 'error', message: 'الطالب غير موجود' };
            }
            if (action === 'registerPassword') {
                const userRes = await supabaseClient.from('users_data').select('role, full_name').eq('national_id', payload.nationalId).single();
                return { status: 'success', message: 'تم التحديث', role: userRes.data.role, name: userRes.data.full_name };
            }
            return { status: 'success', message: 'تم تحديث كلمة المرور' };
        }

        if (action === 'changeModeratorPassword') {
            const res = await supabaseClient.from('users_data').update({ password: payload.newPassword }).eq('national_id', payload.nationalId).in('role', ['admin', 'moderator']);
            if (res.error) {
                return { status: 'error', message: 'المدير غير موجود' };
            }
            return { status: 'success', message: 'تم تحديث كلمة المرور بنجاح' };
        }

        if (action === 'getStudentData') {
            const res = await supabaseClient.from('users_data').select('id, course_enrollments(courses(university, course_name))').eq('national_id', payload.nationalId).single();
            if (res.error || !res.data) return { status: 'error', courses: [] };
            const coursesList = res.data.course_enrollments.map(e => e.courses.university + " " + e.courses.course_name);
            return { status: 'success', courses: coursesList };
        }

        if (action === 'scanAttendance') {
            let stuRes = await supabaseClient.from('users_data').select('id, full_name').eq('national_id', payload.nationalId).single();
            if (stuRes.error || !stuRes.data) return { status: 'error', message: 'الطالب غير موجود' };
            let student = stuRes.data;

            let sessRes = await supabaseClient.from('sessions').select('*, users_data!creator_id(full_name)').or(`qr_code.eq.${payload.qrData},pin_code.eq.${payload.qrData}`).maybeSingle();
            if (sessRes.error || !sessRes.data) return { status: 'error', message: 'الرمز غير صحيح أو الجلسة غير موجودة' };
            let sessionData = sessRes.data;

            if (!sessionData.is_active) return { status: 'error', message: 'تم إغلاق الجلسة' };

            let createdTime = new Date(sessionData.created_at);
            if (((new Date() - createdTime) / 1000 / 60) > sessionData.duration_minutes) {
                await supabaseClient.from('sessions').update({ is_active: false }).eq('id', sessionData.id);
                return { status: 'error', message: 'انتهى الوقت المحدد للجلسة' };
            }

            let enrollRes = await supabaseClient.from('course_enrollments').select('id').eq('course_id', sessionData.course_id).eq('student_id', student.id).maybeSingle();
            if (enrollRes.error || !enrollRes.data) return { status: 'error', message: 'غير مسجل في هذا المقرر' };

            // حساب الغيابات السابقة
            let prevSessRes = await supabaseClient.from('sessions').select('session_name, created_at').eq('course_id', sessionData.course_id).lt('created_at', sessionData.created_at);
            let prevSessions = prevSessRes.data || [];
            let uniquePrevNames = [...new Set(prevSessions.map(s => s.session_name))];
            
            if (uniquePrevNames.length > 0) {
                let attRes = await supabaseClient.from('attendance_logs').select('session_name').eq('student_id', student.id).eq('course_id', sessionData.course_id).in('session_name', uniquePrevNames);
                let attendedNames = new Set((attRes.data || []).map(a => a.session_name));
                let absences = uniquePrevNames.length - attendedNames.size;
                if (absences >= 4) {
                    return { status: 'error', message: 'عذراً، لقد تم حرمانك من المقرر لتجاوز نسبة الغياب.' };
                }
            }

            // التحقق من عدم تسجيل الحضور مسبقاً
            let existRes = await supabaseClient.from('attendance_logs').select('scanned_by, users_data!scanned_by(full_name)').eq('course_id', sessionData.course_id).eq('session_name', sessionData.session_name).eq('student_id', student.id).maybeSingle();
            if (existRes.data) {
                let creatorName = sessionData.users_data ? sessionData.users_data.full_name : 'غير معروف';
                let scannerName = existRes.data.users_data ? existRes.data.users_data.full_name : 'مدير آخر';
                if (existRes.data.scanned_by === sessionData.creator_id) {
                    return { status: 'error', message: `تم تسجيل الحضور مسبقاً مع ${creatorName}` };
                } else {
                    return { status: 'error', message: `مسجل حضور بالفعل مع ${scannerName}` };
                }
            }

            await supabaseClient.from('attendance_logs').insert({ course_id: sessionData.course_id, session_name: sessionData.session_name, student_id: student.id, scanned_by: sessionData.creator_id });
            return { status: 'success', message: 'تم تسجيل الحضور بنجاح' };
        }

        if (action === 'getStudentHistory') {
            const cRes = await supabaseClient.from('courses').select('id').eq('university', payload.uni).eq('course_name', payload.course).single();
            const sRes = await supabaseClient.from('users_data').select('id').eq('national_id', payload.nationalId).single();
            if (cRes.error || sRes.error) return { status: 'error', message: 'خطأ في جلب البيانات' };

            const allSess = await supabaseClient.from('sessions').select('session_name, created_at').eq('course_id', cRes.data.id).order('created_at', { ascending: true });
            const orderedNames = [...new Set((allSess.data || []).map(s => s.session_name))];

            const attRes = await supabaseClient.from('attendance_logs').select('session_name, scanned_at, users_data!scanned_by(full_name)').eq('student_id', sRes.data.id).eq('course_id', cRes.data.id);
            const attendance = attRes.data || [];

            let presentCount = 0; let absentCount = 0; let formattedSessions = [];
            
            orderedNames.forEach(sName => {
                const record = attendance.find(a => a.session_name === sName);
                if (record) {
                    presentCount++;
                    const dObj = new Date(record.scanned_at);
                    const manager = record.users_data ? record.users_data.full_name : '';
                    const tStr = `${dObj.toLocaleString('ar-EG', {timeZone: 'Africa/Cairo'})} - (مع ${manager})`;
                    formattedSessions.push({ name: sName, status: 'حضور', time: tStr, color: 'green' });
                } else {
                    absentCount++;
                    const sInfo = allSess.data.find(x => x.session_name === sName);
                    const tStr = sInfo ? new Date(sInfo.created_at).toLocaleString('ar-EG', {timeZone: 'Africa/Cairo'}) : '-';
                    formattedSessions.push({ name: sName, status: 'غياب', time: tStr, color: 'red' });
                }
            });

            return { status: 'success', data: { sessions: formattedSessions, presentCount, absentCount } };
        }

        if (action === 'getStudentWarnings') {
            const sRes = await supabaseClient.from('users_data').select('id').eq('national_id', payload.nationalId).single();
            if (sRes.error) return { status: 'success', warnings: [] };
            
            const eRes = await supabaseClient.from('course_enrollments').select('course_id, courses(university, course_name)').eq('student_id', sRes.data.id);
            const enrollments = eRes.data || [];
            if (enrollments.length === 0) return { status: 'success', warnings: [] };

            const cIds = enrollments.map(e => e.course_id);
            const allSessRes = await supabaseClient.from('sessions').select('course_id, session_name').in('course_id', cIds);
            const attRes = await supabaseClient.from('attendance_logs').select('course_id, session_name').eq('student_id', sRes.data.id).in('course_id', cIds);

            let warnings = [];
            enrollments.forEach(en => {
                const cName = en.courses.university + " " + en.courses.course_name;
                const cSessions = (allSessRes.data || []).filter(s => s.course_id === en.course_id);
                const uniqueNames = [...new Set(cSessions.map(s => s.session_name))];
                let absCount = 0;
                
                uniqueNames.forEach(sName => {
                    const attended = (attRes.data || []).some(a => a.course_id === en.course_id && a.session_name === sName);
                    if (!attended) absCount++;
                });

                if (absCount >= 3) {
                    warnings.push({ course: cName, absentCount: absCount, type: absCount >= 4 ? 'deprived' : 'warning' });
                }
            });
            return { status: 'success', warnings };
        }

        if (action === 'adminAction') {
            const { type, role, name, uni, course, courseName } = payload;
            let uRes = await supabaseClient.from('users_data').select('id').eq('full_name', name).maybeSingle();
            let adminUuid = uRes.data ? uRes.data.id : null;

            if (type === 'getAdminData') {
                const cRes = await supabaseClient.from('courses').select('*');
                let allowedCourses = cRes.data || [];
                
                if (role === 'moderator' && adminUuid) {
                    const managerRes = await supabaseClient.from('course_managers').select('course_id').eq('manager_id', adminUuid);
                    const managedIds = (managerRes.data || []).map(m => m.course_id);
                    allowedCourses = allowedCourses.filter(c => managedIds.includes(c.id));
                }

                const tree = {};
                allowedCourses.forEach(c => {
                    if (!tree[c.university]) tree[c.university] = [];
                    tree[c.university].push(c.course_name);
                });

                const modRes = await supabaseClient.from('users_data').select('national_id, full_name').eq('role', 'moderator');
                const moderators = (modRes.data || []).map(m => ({ name: m.full_name, id: m.national_id }));
                const materials = [...new Set((cRes.data || []).map(c => c.course_name))];
                return { status: 'success', data: tree, materials, moderators };
            }

            if (type === 'getCourseModerators') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (cRes.error) return { status: 'success', courseModerators: [] };
                
                const sRes = await supabaseClient.from('sessions').select('users_data!creator_id(full_name)').eq('course_id', cRes.data.id);
                let mods = new Set();
                (sRes.data || []).forEach(s => {
                    if (s.users_data && s.users_data.full_name !== 'المدير العام' && s.users_data.full_name !== 'admin') {
                        mods.add(s.users_data.full_name);
                    }
                });
                return { status: 'success', courseModerators: Array.from(mods) };
            }

            if (type === 'addModerator') {
                await supabaseClient.from('users_data').insert({ national_id: payload.id, full_name: name, password: payload.password, role: 'moderator' });
                return { status: 'success' };
            }

            if (type === 'deleteModerator') {
                await supabaseClient.from('users_data').delete().eq('national_id', payload.id).eq('role', 'moderator');
                return { status: 'success' };
            }

            if (type === 'addCourse') {
                let courseRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', courseName).maybeSingle();
                let courseId;
                if (courseRes.error || !courseRes.data) {
                    const insRes = await supabaseClient.from('courses').insert({ university: uni, course_name: courseName }).select('id').single();
                    if (insRes.error) return { status: 'error', message: 'حدث خطأ أثناء إنشاء المقرر' };
                    courseId = insRes.data.id;
                } else {
                    courseId = courseRes.data.id;
                }
                if (adminUuid) {
                    await supabaseClient.from('course_managers').upsert({ course_id: courseId, manager_id: adminUuid }, { onConflict: 'course_id, manager_id' });
                }
                return { status: 'success' };
            }

            if (type === 'deleteCourse') {
                if (role === 'admin') {
                    await supabaseClient.from('courses').delete().eq('university', uni).eq('course_name', courseName);
                } else if (adminUuid) {
                    const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', courseName).single();
                    if (cRes.data) {
                        await supabaseClient.from('sessions').delete().eq('course_id', cRes.data.id).eq('creator_id', adminUuid);
                        await supabaseClient.from('course_managers').delete().eq('course_id', cRes.data.id).eq('manager_id', adminUuid);
                        const remainingManagers = await supabaseClient.from('course_managers').select('manager_id').eq('course_id', cRes.data.id);
                        if (remainingManagers.data && remainingManagers.data.length === 0) {
                            await supabaseClient.from('courses').delete().eq('id', cRes.data.id);
                        }
                    }
                }
                return { status: 'success' };
            }

            if (type === 'getLastSession') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (cRes.error) return { status: 'success', lastSession: 'لا يوجد' };
                
                let q = supabaseClient.from('sessions').select('session_name').eq('course_id', cRes.data.id);
                if (role === 'moderator' && adminUuid) q = q.eq('creator_id', adminUuid);
                
                const sRes = await q;
                const count = new Set((sRes.data || []).map(s => s.session_name)).size;
                return { status: 'success', lastSession: count > 0 ? "الجلسة " + count : 'لا يوجد' };
            }

            if (type === 'createSession' || type === 'changeQR') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (cRes.error) return { status: 'error', message: 'المقرر غير موجود' };
                let cId = cRes.data.id;

                const pinCode = Math.floor(100000 + Math.random() * 900000).toString();
                let targetSessionName = payload.sessionNameOverride;

                if (type === 'createSession') {
                    let q = supabaseClient.from('sessions').select('session_name').eq('course_id', cId);
                    if (role === 'moderator' && adminUuid) q = q.eq('creator_id', adminUuid);
                    
                    const sRes = await q;
                    const count = new Set((sRes.data || []).map(s => s.session_name)).size;
                    targetSessionName = "الجلسة " + (count + 1);
                    
                    const qrData = `${uni}|separator|${course}|separator|${targetSessionName}|separator|${pinCode}`;
                    await supabaseClient.from('sessions').insert({
                        course_id: cId, session_name: targetSessionName, qr_code: qrData, pin_code: pinCode, duration_minutes: payload.duration, creator_id: adminUuid
                    });
                    return { status: 'success', qrData, sessionName: targetSessionName, pinCode };
                }

                if (type === 'changeQR') {
                    const qrData = `${uni}|separator|${course}|separator|${targetSessionName}|separator|${pinCode}`;
                    let query = supabaseClient.from('sessions').update({
                        duration_minutes: payload.duration, qr_code: qrData, pin_code: pinCode, is_active: true, created_at: new Date().toISOString()
                    });
                    
                    // إذا تم توفير qrCode الأصلي، نستخدمه لتحديد الجلسة بدقة
                    if (payload.originalQrCode) {
                        query = query.eq('qr_code', payload.originalQrCode);
                    } else {
                        // للتوافق مع الإصدارات السابقة
                        query = query.eq('course_id', cId).eq('session_name', targetSessionName);
                        if (role === 'moderator' && adminUuid) query = query.eq('creator_id', adminUuid);
                    }
                    
                    await query;
                    return { status: 'success', qrData, sessionName: targetSessionName, pinCode };
                }
            }

            if (type === 'getSessionDetails') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (cRes.error) return { status: 'error' };
                
                let q = supabaseClient.from('sessions').select('id, session_name, is_active, qr_code, created_at, duration_minutes, creator_id, users_data!creator_id(full_name)').eq('course_id', cRes.data.id);
                if (role === 'moderator' && adminUuid) q = q.eq('creator_id', adminUuid);
                const sRes = await q;
                
                const countRes = await supabaseClient.from('course_enrollments').select('*', {count: 'exact', head: true}).eq('course_id', cRes.data.id);
                let totalStu = countRes.count || 0;

                let stats = [];
                for(let s of (sRes.data || [])) {
                    let attRes = await supabaseClient.from('attendance_logs').select('*', {count: 'exact', head: true}).eq('course_id', cRes.data.id).eq('session_name', s.session_name);
                    let present = attRes.count || 0;
                    
                    let cTime = new Date(s.created_at);
                    let now = new Date();
                    let minutesPassed = (now - cTime) / 1000 / 60;
                    let isActuallyActive = s.is_active && minutesPassed <= s.duration_minutes;
                    
                    let qStatus = isActuallyActive ? 'يعمل' : 'لا يعمل';
                    
                    stats.push({
                        session: s.session_name,
                        present,
                        absent: totalStu - present,
                        qrStatus: qStatus,
                        qrCode: s.qr_code,
                        creationDate: cTime.toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' }),
                        creator: s.users_data ? s.users_data.full_name : 'غير معروف',
                        creatorId: s.creator_id,
                        isActive: s.is_active,
                        duration: s.duration_minutes,
                        createdAt: s.created_at
                    });
                }
                stats.sort((a,b) => a.session.localeCompare(b.session, 'ar', {numeric: true}));
                return { status: 'success', sessions: stats };
            }

            if (type === 'toggleQR') {
                await supabaseClient.from('sessions').update({ is_active: payload.newStatus === 'يعمل' }).eq('qr_code', payload.qrCode);
                return { status: 'success' };
            }

            if (type === 'deleteSession') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (cRes.data) {
                    if (role === 'admin') {
                        await supabaseClient.from('sessions').delete().eq('course_id', cRes.data.id).eq('session_name', payload.sessionName);
                    } else if (adminUuid) {
                        await supabaseClient.from('attendance_logs').delete().eq('course_id', cRes.data.id).eq('session_name', payload.sessionName).eq('scanned_by', adminUuid);
                        await supabaseClient.from('sessions').delete().eq('course_id', cRes.data.id).eq('session_name', payload.sessionName).eq('creator_id', adminUuid);
                        
                        const remainingSessions = await supabaseClient.from('sessions').select('id').eq('course_id', cRes.data.id).eq('session_name', payload.sessionName);
                        if (remainingSessions.data && remainingSessions.data.length === 0) {
                            // لا يوجد جلسات بهذا الاسم
                        }
                    }
                }
                return { status: 'success' };
            }

            if (type === 'getCourseStudents') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (cRes.error) return { status: 'error' };
                const eRes = await supabaseClient.from('course_enrollments').select('users_data(full_name, national_id, password)').eq('course_id', cRes.data.id);
                const students = (eRes.data || []).map((e, idx) => ({ name: e.users_data.full_name, id: e.users_data.national_id, pass: e.users_data.password, rowIndex: idx }));
                return { status: 'success', students };
            }

            if (type === 'manageStudent') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (cRes.error) return { status: 'error' };
                const cId = cRes.data.id;
                
                const { actionType, studentData } = payload;
                if (actionType === 'add' || actionType === 'edit') {
                    let uRes = await supabaseClient.from('users_data').select('id').eq('national_id', studentData.id).maybeSingle();
                    let uId;
                    if (!uRes.data) {
                        let ins = await supabaseClient.from('users_data').insert({ national_id: studentData.id, full_name: studentData.name, password: studentData.pass || '', role: 'student' }).select('id').single();
                        if (ins.error) return { status: 'error' };
                        uId = ins.data.id;
                    } else {
                        uId = uRes.data.id;
                        if (actionType === 'edit') await supabaseClient.from('users_data').update({ full_name: studentData.name, password: studentData.pass || '' }).eq('id', uId);
                    }
                    if (actionType === 'add') await supabaseClient.from('course_enrollments').upsert({ course_id: cId, student_id: uId });
                } else if (actionType === 'delete') {
                    let uRes = await supabaseClient.from('users_data').select('id').eq('national_id', studentData.id).single();
                    if (uRes.data) await supabaseClient.from('course_enrollments').delete().eq('course_id', cId).eq('student_id', uRes.data.id);
                }
                return { status: 'success' };
            }

            if (type === 'batchAddStudents') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (cRes.error) return { status: 'error', message: 'المقرر غير موجود' };
                const cId = cRes.data.id;
                const students = payload.students;
                let added = 0;
                for (let stu of students) {
                    if (!stu.name || !stu.id) continue;
                    let uRes = await supabaseClient.from('users_data').select('id').eq('national_id', stu.id).maybeSingle();
                    let uId;
                    if (!uRes.data) {
                        let ins = await supabaseClient.from('users_data').insert({ national_id: stu.id, full_name: stu.name, password: stu.pass || '', role: 'student' }).select('id').single();
                        if (ins.error) continue;
                        uId = ins.data.id;
                    } else {
                        uId = uRes.data.id;
                    }
                    await supabaseClient.from('course_enrollments').upsert({ course_id: cId, student_id: uId });
                    added++;
                }
                return { status: 'success', message: `تمت إضافة ${added} طالب بنجاح` };
            }

            if (type === 'getCourseWarnings') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (cRes.error) return { status: 'error' };
                
                const eRes = await supabaseClient.from('course_enrollments').select('users_data(full_name, national_id, id)').eq('course_id', cRes.data.id);
                const sRes = await supabaseClient.from('sessions').select('session_name').eq('course_id', cRes.data.id);
                const uniqueNames = [...new Set((sRes.data || []).map(s=>s.session_name))];
                const attRes = await supabaseClient.from('attendance_logs').select('student_id, session_name').eq('course_id', cRes.data.id);
                
                let warnings = [];
                (eRes.data || []).forEach(e => {
                    let absCount = 0;
                    uniqueNames.forEach(sn => {
                        const attended = (attRes.data || []).some(a => a.student_id === e.users_data.id && a.session_name === sn);
                        if (!attended) absCount++;
                    });
                    if (payload.warningType === 'warning' && absCount === 3) warnings.push({ name: e.users_data.full_name, id: e.users_data.national_id, absentCount: absCount });
                    else if (payload.warningType === 'deprived' && absCount >= 4) warnings.push({ name: e.users_data.full_name, id: e.users_data.national_id, absentCount: absCount });
                });
                return { status: 'success', warnings };
            }
        }

        if (action === 'getCourseReport') {
            const cRes = await supabaseClient.from('courses').select('id').eq('university', payload.uni).eq('course_name', payload.course).single();
            if (cRes.error) return { status: 'error' };
            const sRes = await supabaseClient.from('sessions').select('session_name').eq('course_id', cRes.data.id);
            const uniqueNames = [...new Set((sRes.data || []).map(s => s.session_name))];
            // ترتيب أسماء الجلسات أبجدياً
            uniqueNames.sort((a, b) => a.localeCompare(b, 'ar', { numeric: true }));
            
            const eRes = await supabaseClient.from('course_enrollments').select('users_data(id, full_name, national_id)').eq('course_id', cRes.data.id);
            const attRes = await supabaseClient.from('attendance_logs').select('student_id, session_name, scanned_at, users_data!scanned_by(full_name)').eq('course_id', cRes.data.id);
            
            const headers = ["اسم الطالب", "حضور", "غياب", "الرقم القومي", ...uniqueNames];
            const rows = (eRes.data || []).map(e => {
                let p = 0, a = 0;
                const stu = e.users_data;
                const statusCols = uniqueNames.map(sn => {
                    const rec = (attRes.data || []).find(x => x.student_id === stu.id && x.session_name === sn);
                    if (rec) {
                        p++;
                        return "✓";
                    }
                    a++;
                    return "✗";
                });
                return [stu.full_name, p, a, stu.national_id, ...statusCols];
            }).sort((a,b) => String(a[0]).localeCompare(String(b[0]), 'ar'));
            
            return { status: 'success', headers, rows, count: rows.length };
        }

        if (action === 'getIsolatedCourseReport') {
            const { uni, course, targetModerator } = payload;
            const uRes = await supabaseClient.from('users_data').select('id').eq('full_name', targetModerator).maybeSingle();
            const modId = uRes.data ? uRes.data.id : null;

            const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
            if (cRes.error) return { status: 'error' };

            // جلب جلسات هذا المدير فقط
            const sRes = await supabaseClient.from('sessions').select('session_name, created_at').eq('course_id', cRes.data.id).eq('creator_id', modId);
            let orderedNames = [...new Set((sRes.data||[]).map(s => s.session_name))];
            // ترتيب أبجدي
            orderedNames.sort((a, b) => a.localeCompare(b, 'ar', { numeric: true }));
            
            const eRes = await supabaseClient.from('course_enrollments').select('users_data(id, full_name, national_id)').eq('course_id', cRes.data.id);
            
            let q = supabaseClient.from('attendance_logs').select('student_id, session_name, scanned_at, users_data!scanned_by(full_name)').eq('course_id', cRes.data.id).in('session_name', orderedNames);
            if (modId) q = q.eq('scanned_by', modId);
            const attRes = await q;

            const headers = ["اسم الطالب", "حضور", "غياب", "الرقم القومي", ...orderedNames];
            const rows = (eRes.data || []).map(e => {
                let p = 0, a = 0;
                const stu = e.users_data;
                const statusCols = orderedNames.map(sn => {
                    const rec = (attRes.data || []).find(x => x.student_id === stu.id && x.session_name === sn);
                    if (rec) {
                        p++;
                        return "✓";
                    }
                    a++;
                    return "✗";
                });
                return [stu.full_name, p, a, stu.national_id, ...statusCols];
            }).sort((a,b) => String(a[0]).localeCompare(String(b[0]), 'ar'));
            
            return { status: 'success', headers, rows, count: rows.length };
        }

        if (action === 'getSessionReport') {
            const { uni, course, session } = payload;
            const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
            if (cRes.error) return { status: 'error' };

            const eRes = await supabaseClient.from('course_enrollments').select('users_data(id, full_name, national_id)').eq('course_id', cRes.data.id);
            const attRes = await supabaseClient.from('attendance_logs').select('student_id, scanned_at, users_data!scanned_by(full_name)').eq('course_id', cRes.data.id).eq('session_name', session);

            const report = (eRes.data || []).map(e => {
                const stu = e.users_data;
                const rec = (attRes.data || []).find(x => x.student_id === stu.id);
                if (rec) {
                    const mName = rec.users_data ? rec.users_data.full_name : '';
                    return { name: stu.full_name, id: stu.national_id, status: 'حضور', time: `${new Date(rec.scanned_at).toLocaleString('ar-EG', {timeZone: 'Africa/Cairo'})} - (مع ${mName})`, color: 'green', rowIndex: stu.id, rawVal: 'present' };
                }
                return { name: stu.full_name, id: stu.national_id, status: 'غياب', time: '-', color: 'red', rowIndex: stu.id, rawVal: '' };
            }).sort((a,b) => a.name.localeCompare(b.name, 'ar'));

            return { status: 'success', report };
        }

        if (action === 'getStudentSearchReport') {
            const cRes = await supabaseClient.from('courses').select('id').eq('university', payload.uni).eq('course_name', payload.course).single();
            if (cRes.error) return { status: 'error' };

            const eRes = await supabaseClient.from('course_enrollments').select('users_data!inner(id, full_name, national_id)').eq('course_id', cRes.data.id).or(`full_name.ilike.%${payload.query}%,national_id.ilike.%${payload.query}%`, { foreignTable: 'users_data' });
            const sRes = await supabaseClient.from('sessions').select('session_name').eq('course_id', cRes.data.id);
            let orderedNames = [...new Set((sRes.data||[]).map(s => s.session_name))];
            orderedNames.sort((a, b) => a.localeCompare(b, 'ar', { numeric: true }));

            const stuIds = (eRes.data||[]).map(e => e.users_data.id);
            const attRes = await supabaseClient.from('attendance_logs').select('student_id, session_name').eq('course_id', cRes.data.id).in('student_id', stuIds);

            const results = (eRes.data || []).map(e => {
                const stu = e.users_data;
                let p = 0, a = 0;
                const sessInfo = orderedNames.map(sn => {
                    const isPres = (attRes.data||[]).some(x => x.student_id === stu.id && x.session_name === sn);
                    if (isPres) p++; else a++;
                    return { name: sn, val: isPres ? 'حضور' : 'غياب' };
                });
                return { name: stu.full_name, id: stu.national_id, present: p, absent: a, sessions: sessInfo, rowIndex: stu.id };
            });
            return { status: 'success', results, sessionHeaders: orderedNames };
        }

        if (action === 'updateAttendanceCell') {
            const { uni, course, rowIndex: stuId, status, sessionName, editorName, editorRole } = payload;
            const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
            if (cRes.error) return { status: 'error' };

            let uRes = await supabaseClient.from('users_data').select('id').eq('full_name', editorName).maybeSingle();
            let editorId = uRes.data ? uRes.data.id : stuId;

            if (status === 'present') {
                await supabaseClient.from('attendance_logs').insert({ course_id: cRes.data.id, session_name: sessionName, student_id: stuId, scanned_by: editorId });
                // تحديد نوع المحرر لعرضه في الرسالة
                const roleLabel = editorRole === 'admin' ? 'مسؤول النظام' : 'مدير';
                return { status: 'success', newValue: `${new Date().toLocaleString('ar-EG', {timeZone: 'Africa/Cairo'})} - (مع ${roleLabel} - تعديل يدوي)` };
            } else {
                await supabaseClient.from('attendance_logs').delete().eq('course_id', cRes.data.id).eq('session_name', sessionName).eq('student_id', stuId);
                return { status: 'success', newValue: '' };
            }
        }

        return { status: 'error', message: 'الإجراء غير مدعوم' };
      } catch (err) {
        console.error('Database Error:', err);
        return { status: 'error', message: 'تعذر الاتصال بالخادم السحابي' };
      }
    };

    // --- Hooks ---
    const useTheme = () => {
        const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'light');
        useEffect(() => {
            const root = window.document.documentElement;
            if (theme === 'dark') {
                root.classList.add('dark');
            } else {
                root.classList.remove('dark');
            }
            localStorage.setItem('theme', theme);
        }, [theme]);
        const toggleTheme = () => setTheme(prev => prev === 'dark' ? 'light' : 'dark');
        return { theme, toggleTheme };
    };

    // --- Custom UI Components ---
    const ThemeToggle = ({ theme, toggleTheme, className }) => (
        <button onClick={toggleTheme} className={`p-2 rounded-full transition-colors ${theme==='dark' ? 'bg-gray-700 text-yellow-400 hover:bg-gray-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'} ${className}`}>
            {theme === 'dark' ? 
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg> 
                : 
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            }
        </button>
    );

    const FullScreenLoader = ({ text }) => (
      <div className="fixed inset-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm flex flex-col justify-center items-center z-[100] fade-in">
        <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <span className="text-gray-700 dark:text-gray-200 font-bold">{text || 'جاري التحميل...'}</span>
      </div>
    );

    const Button = ({ children, onClick, loading, className, disabled, ...props }) => (
        <button 
            onClick={onClick} 
            disabled={loading || disabled} 
            className={`${className} ${loading || disabled ? 'opacity-70 cursor-not-allowed' : ''} flex items-center justify-center gap-2 transition-transform active:scale-95`}
            {...props}
        >
            {loading && <div className="loader-sm border-t-white"></div>}
            {children}
        </button>
    );

    const Modal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm fade-in overflow-y-auto">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden my-8 border border-gray-100 dark:border-gray-700">
            <div className="flex justify-between items-center p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
              <h3 className="text-lg font-bold text-gray-800 dark:text-gray-100">{title}</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 text-2xl font-bold">&times;</button>
            </div>
            <div className="p-6 max-h-[75vh] overflow-y-auto text-gray-800 dark:text-gray-200">{children}</div>
          </div>
        </div>
      );
    };

    const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, confirmText, cancelText, type = 'danger', loading }) => {
      if (!isOpen) return null;
      const btnColor = type === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700';
      return (
        <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm fade-in">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden p-6 text-center border border-gray-100 dark:border-gray-700">
            <h3 className="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">{title}</h3>
            <p className="text-gray-600 dark:text-gray-300 mb-6 whitespace-pre-wrap">{message}</p>
            <div className="flex gap-3 justify-center">
              <Button loading={loading} onClick={onConfirm} className={`${btnColor} text-white px-6 py-2 rounded-xl font-bold min-w-[100px]`}>{confirmText || 'تأكيد'}</Button>
              <button onClick={onClose} disabled={loading} className="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 px-6 py-2 rounded-xl font-bold hover:bg-gray-200 dark:hover:bg-gray-600 min-w-[100px]">{cancelText || 'إلغاء'}</button>
            </div>
          </div>
        </div>
      );
    };

    const Toast = ({ type, message, onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, [onClose]);
      const colors = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
      return (
        <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[110] ${colors} text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 fade-in`}>
          <span className="font-bold text-sm">{message}</span>
          <button onClick={onClose} className="opacity-80 hover:opacity-100">&times;</button>
        </div>
      );
    };

    const useConfirm = () => {
        const [config, setConfig] = useState(null);
        const confirm = (props) => { return new Promise((resolve) => { setConfig({ ...props, resolve }); }); };
        const handleConfirm = () => { config.resolve(true); setConfig(null); };
        const handleCancel = () => { config.resolve(false); setConfig(null); };
        return { confirm, config, handleConfirm, handleCancel };
    };

    // --- Main Screens ---
    const LoginScreen = ({ onLogin, theme, toggleTheme }) => {
        const [id, setId] = useState('');
        const [password, setPassword] = useState('');
        const [step, setStep] = useState(1);
        const [showPass, setShowPass] = useState(false);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [userName, setUserName] = useState('');
        const [role, setRole] = useState('');

        const handleCheckId = async (e) => {
            e.preventDefault();
            if(id.length < 5) { setError('الرقم غير صحيح'); return; }
            setLoading(true); setError('');
            try {
                const res = await runServer('login', { nationalId: id });
                if(res.status === 'success' && (res.role === 'admin' || res.role === 'moderator')) onLogin(res);
                else if(res.status !== 'error') {
                    setUserName(res.name); setRole(res.role);
                    setStep(res.status === 'create_password' ? 3 : 2);
                } else setError(res.message);
            } catch(e) { setError('فشل الاتصال'); }
            setLoading(false);
        };

        const handleSubmit = async () => {
            setLoading(true);
            const action = step === 3 ? 'registerPassword' : 'login';
            const payload = step === 3 ? { nationalId: id, newPassword: password } : { nationalId: id, password };
            try {
                const res = await runServer(action, payload);
                if(res.status === 'success') {
                    const user = { role: res.role || role || 'student', name: res.name || userName, id };
                    localStorage.setItem('sys_user', JSON.stringify(user));
                    onLogin(user);
                } else setError(res.message);
            } catch(e) { setError('حدث خطأ'); }
            setLoading(false);
        };

        return (
            <div className="min-h-screen bg-gray-100 dark:bg-gray-950 flex items-center justify-center p-4 relative">
                <div className="absolute top-4 left-4">
                    <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
                </div>
                {loading && <FullScreenLoader />}
  
                <div className="bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl shadow-xl overflow-hidden border border-gray-100 dark:border-gray-700">
                    <div className="bg-blue-600 dark:bg-blue-700 p-8 text-center text-white">
                        <h1 className="text-2xl font-bold mb-2">نظام الحضور</h1>
                    </div>
                    <div className="p-8">
                        {error && <div className="bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 p-3 rounded-lg mb-4 text-sm font-bold text-center">{error}</div>}
                        
                        {step === 1 ? (
                            <form onSubmit={handleCheckId}>
                                <label className="block text-gray-700 dark:text-gray-300 font-bold mb-2 text-sm">الرقم القومي</label>
                                <input type="number" value={id} onChange={e=>setId(e.target.value)} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none transition-colors" required />
                                <Button loading={loading} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-md shadow-blue-200 dark:shadow-none">التالي</Button>
                            </form>
                        ) : (
                            <div>
                                <div className="text-center mb-6">
                                    <p className="text-gray-500 dark:text-gray-400 text-sm">مرحباً</p>
                                    <h2 className="text-xl font-bold text-gray-800 dark:text-white">{userName}</h2>
                                    {step === 3 && <span className="bg-orange-100 text-orange-800 dark:bg-orange-900/50 dark:text-orange-200 text-xs px-2 py-1 rounded">تعيين كلمة مرور جديدة</span>}
                                </div>
                                <div className="relative mb-4">
                                    <input type={showPass ? "text" : "password"} value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-colors" placeholder="كلمة المرور" />
                                    <button onClick={()=>setShowPass(!showPass)} className="absolute left-3 top-3 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 text-sm font-bold">{showPass ? 'إخفاء' : 'إظهار'}</button>
                                </div>
                                <Button loading={loading} onClick={handleSubmit} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition mb-3 shadow-md shadow-blue-200 dark:shadow-none">{step === 3 ? 'حفظ ودخول' : 'دخول'}</Button>
                                <button onClick={()=>setStep(1)} className="w-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-sm">رجوع</button>
                            </div>
                        )}
                        
                        <div className="mt-8 pt-4 border-t dark:border-gray-700 text-center space-y-3">
                            {step === 2 && <p className="text-xs text-red-500 dark:text-red-400 font-bold bg-red-50 dark:bg-red-900/20 p-2 rounded">نسيت كلمة المرور؟ تواصل معنا لاستعادتها</p>}
                            <div className="flex justify-center gap-3">
                                <a href="https://wa.me/201113515751" target="_blank" className="flex items-center gap-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-4 py-2 rounded-full font-bold hover:bg-green-200 dark:hover:bg-green-900/50 transition shadow-sm">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" className="w-5 h-5" /> واتساب
                                </a>
                                <a href="https://t.me/Dr_Abdallah_Sabry" target="_blank" className="flex items-center gap-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-4 py-2 rounded-full font-bold hover:bg-blue-200 dark:hover:bg-blue-900/50 transition shadow-sm">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" className="w-5 h-5" /> تليجرام
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const StudentDashboard = ({ user, onLogout, theme, toggleTheme }) => {
        const [view, setView] = useState('home');
        const [showScanner, setShowScanner] = useState(false);
        const [toast, setToast] = useState(null);
        const { confirm, config: confirmConfig, handleConfirm, handleCancel } = useConfirm();
        const [courses, setCourses] = useState([]);
        const [selCourse, setSelCourse] = useState('');
        const [history, setHistory] = useState(null);
        const [warningsList, setWarningsList] = useState([]);
        const [loadingHistory, setLoadingHistory] = useState(false);
        const [loadingWarnings, setLoadingWarnings] = useState(false);
        const [showEditPass, setShowEditPass] = useState(false);
        const [newPass, setNewPass] = useState('');
        const [loadingPass, setLoadingPass] = useState(false);

        useEffect(() => {
            runServer('getStudentData', { nationalId: user.id }).then(res => {
                if(res.status === 'success') setCourses(res.courses);
            });
            fetchWarnings();
        }, []);

        const fetchWarnings = () => {
            setLoadingWarnings(true);
            runServer('getStudentWarnings', { nationalId: user.id }).then(res => {
                setLoadingWarnings(false);
                if (res.status === 'success') setWarningsList(res.warnings);
            });
        };

        const handleScan = (decodedText) => {
            setShowScanner(false);
            setToast({ type: 'info', message: 'جاري التسجيل...' });
            runServer('scanAttendance', { nationalId: user.id, qrData: decodedText }).then(res => {
                setToast({ type: res.status, message: res.message });
                fetchWarnings();
            });
        };
        
        const fetchHistory = () => {
             if(!selCourse) return;
             setLoadingHistory(true);
             const [uni, ...rest] = selCourse.split(" ");
             runServer('getStudentHistory', { nationalId: user.id, uni, course: rest.join(" ") }).then(res => {
                 setLoadingHistory(false);
                 if(res.status === 'success') setHistory(res.data);
             });
        };

        const handleChangePassword = async () => {
             const ok = await confirm({ title: 'تأكيد التعديل', message: 'هل أنت متأكد من تغيير كلمة المرور؟', confirmText: 'نعم، تعديل', type: 'primary' });
             if(ok) {
                 setLoadingPass(true);
                 runServer('changePassword', { nationalId: user.id, newPassword: newPass }).then(res => {
                     setLoadingPass(false); setToast({ type: res.status, message: res.message });
                     if(res.status==='success') setShowEditPass(false);
                 });
             }
        };

        const printHistory = () => {
            const printWindow = window.open('', '_blank');
            if (!printWindow) return;
            const courseName = selCourse || 'المقرر';
            const studentName = user.name;
            const rows = history?.sessions.map(s => `
                <tr>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center;">${s.name}</td>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center; color:${s.color==='green'?'green':'red'}; font-weight:bold;">${s.status}</td>
                    <td style="border:1px solid #ddd; padding:8px; text-align:center;">${s.time}</td>
                </tr>
            `).join('');
            printWindow.document.write(`
                <html dir="rtl">
                <head><title>سجل حضور الطالب</title>
                <style>body { font-family: 'Cairo', sans-serif; padding:20px; } table { width:100%; border-collapse:collapse; } th { background:#f2f2f2; }</style>
                </head>
                <body>
                    <h2 style="text-align:center;">سجل حضور الطالب: ${studentName}</h2>
                    <h3 style="text-align:center;">المقرر: ${courseName}</h3>
                    <table>
                        <thead><tr><th>الجلسة</th><th>الحالة</th><th>التوقيت</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        };

        return (
            <div className="min-h-screen pb-24 bg-gray-50 dark:bg-gray-950 transition-colors">
                {toast && <Toast {...toast} onClose={()=>setToast(null)} />}
                <ConfirmationModal isOpen={!!confirmConfig} onClose={handleCancel} onConfirm={handleConfirm} {...confirmConfig} />
                
                <header className="bg-blue-700 dark:bg-blue-900 text-white p-6 rounded-b-3xl shadow-lg mb-6 transition-colors">
                    <div className="flex justify-between items-start">
                        <div>
                            <h1 className="text-2xl font-bold">{user.name}</h1>
                            <p className="text-blue-200 text-sm">طالب - {user.id}</p>
                        </div>
                        <div className="flex gap-2">
                             <ThemeToggle theme={theme} toggleTheme={toggleTheme} className="bg-white/10 text-white hover:bg-white/20" />
                            <button onClick={()=>{localStorage.removeItem('sys_user'); onLogout()}} className="bg-white/20 p-2 rounded-full hover:bg-white/30 transition">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div className="mt-4 flex items-center gap-2">
                         <span className="text-sm bg-blue-800 dark:bg-blue-950 px-2 py-1 rounded">كلمة المرور: ••••••</span>
                         <button onClick={()=>setShowEditPass(true)} className="text-xs bg-white text-blue-700 px-2 py-1 rounded font-bold hover:bg-gray-100 transition shadow-sm">تعديل</button>
                    </div>
                </header>

                <main className="px-4 max-w-lg mx-auto">
                    {view === 'home' && (
                        <div className="space-y-4 fade-in">
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                                <div className="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg className="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                                <h3 className="font-bold text-lg mb-2 text-gray-800 dark:text-gray-100">تسجيل الحضور بالكاميرا</h3>
                                <button onClick={()=>setShowScanner(true)} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 dark:shadow-none active:scale-95 transition">فتح الكاميرا المباشرة للمسح</button>
                            </div>

                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                                <h3 className="font-bold text-gray-800 dark:text-gray-100 mb-3">إدخال الرقم السري يدوياً</h3>
                                <div className="flex gap-2">
                                    <input type="number" id="homeManualPinInput" placeholder="رقم الجلسة (6 أرقام)" className="flex-1 bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-white border border-gray-300 dark:border-gray-600 rounded-xl p-3 text-center tracking-widest font-bold outline-none focus:border-blue-500" />
                                    <button onClick={() => {
                                        const pin = document.getElementById('homeManualPinInput').value;
                                        if(pin && pin.length >= 4) handleScan(pin);
                                        else alert('يرجى إدخال الرقم بشكل صحيح');
                                    }} className="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700 transition">تسجيل</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'history' && (
                        <div className="fade-in space-y-4">
                             <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700">
                                <label className="block text-sm font-bold mb-2 text-gray-700 dark:text-gray-300">اختر المقرر</label>
                                <div className="flex gap-2 w-full">
                                    <select value={selCourse} onChange={e=>setSelCourse(e.target.value)} className="flex-1 min-w-0 w-full truncate border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white p-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-400">
                                        <option value="">...</option>
                                        {courses.map(c=><option key={c} value={c}>{c}</option>)}
                                    </select>
                                    <Button loading={loadingHistory} onClick={fetchHistory} className="bg-blue-600 text-white px-6 rounded-lg font-bold">عرض</Button>
                                    {history && (
                                        <button onClick={printHistory} className="bg-green-600 text-white px-4 rounded-lg font-bold">طباعة</button>
                                    )}
                                </div>
                             </div>
                             
                              {history && (
                                 <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700">
                                     <div className="flex justify-between mb-4 bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border dark:border-gray-600">
                                         <div className="text-center">
                                             <span className="block text-xl font-bold text-green-600 dark:text-green-400">{history.presentCount}</span>
                                             <span className="text-xs text-gray-500 dark:text-gray-400 font-bold">حضور</span>
                                         </div>
                                         <div className="text-center">
                                             <span className="block text-xl font-bold text-red-600 dark:text-red-400">{history.absentCount}</span>
                                             <span className="text-xs text-gray-500 dark:text-gray-400 font-bold">غياب</span>
                                         </div>
                                     </div>
                                     <div className="space-y-2">
                                         {history.sessions.map((s,i) => (
                                             <div key={i} className={`flex justify-between p-3 rounded-lg border-r-4 ${s.color==='green'?'border-green-500 bg-green-50 dark:bg-green-900/10':'border-red-500 bg-red-50 dark:bg-red-900/10'}`}>
                                                 <div>
                                                     <p className="font-bold text-sm text-gray-800 dark:text-gray-200">{s.name}</p>
                                                     <p className="text-[10px] text-gray-500 dark:text-gray-400">{s.time}</p>
                                                 </div>
                                                 <span className={`text-[10px] font-bold px-2 py-1 rounded h-fit ${s.color==='green'?'bg-green-200 text-green-800 dark:bg-green-900 dark:text-green-200':'bg-red-200 text-red-800 dark:bg-red-900 dark:text-red-200'}`}>
                                                     {s.status}
                                                 </span>
                                             </div>
                                         ))}
                                     </div>
                                 </div>
                             )}
                        </div>
                    )}

                    {view === 'warnings' && (
                        <div className="fade-in space-y-4">
                            {loadingWarnings && <div className="text-center p-4"><span className="loader-sm border-t-blue-600"></span></div>}
                            {!loadingWarnings && warningsList.length === 0 && (
                                <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                                    <div className="w-16 h-16 bg-green-50 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-4 text-green-500">
                                        <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path></svg>
                                    </div>
                                    <h3 className="font-bold text-lg text-gray-800 dark:text-gray-100">سجلك ممتاز</h3>
                                    <p className="text-sm text-gray-500 dark:text-gray-400 mt-2">لا يوجد لديك أي إنذارات غياب حالياً.</p>
                                </div>
                            )}
                            {warningsList.map((w, i) => (
                                <div key={i} className={`p-6 rounded-2xl shadow-sm border ${w.type === 'warning' ? 'bg-yellow-50 border-yellow-200 dark:bg-yellow-900/20 dark:border-yellow-700/50' : 'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-700/50'}`}>
                                    <div className="flex items-center gap-3 mb-3">
                                        {w.type === 'warning' ? 
                                            <svg className="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                            :
                                            <svg className="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        }
                                        <h3 className={`font-bold text-lg ${w.type === 'warning' ? 'text-yellow-800 dark:text-yellow-400' : 'text-red-800 dark:text-red-400'}`}>
                                            {w.type === 'warning' ? 'إنذار غياب' : 'حرمان من المقرر'}
                                        </h3>
                                    </div>
                                    <p className="font-bold text-gray-800 dark:text-gray-200 mb-1">{w.course}</p>
                                    <p className="text-sm font-bold opacity-80 mb-2 text-gray-600 dark:text-gray-400">إجمالي الغياب: {w.absentCount} جلسات</p>
                                    {/* رسالة التنبيه داخل البطاقة */}
                                    {w.type === 'warning' && (
                                        <p className="text-xs font-bold text-yellow-700 dark:text-yellow-300 bg-yellow-100 dark:bg-yellow-900/40 p-2 rounded-lg mt-2">
                                            ⚠️ يرجى الانتباه! غياب جلسة أخرى سيؤدي إلى حرمانك نهائياً من هذا المقرر.
                                        </p>
                                    )}
                                    {w.type === 'deprived' && (
                                        <p className="text-xs font-bold text-red-700 dark:text-red-300 bg-red-100 dark:bg-red-900/40 p-2 rounded-lg mt-2">
                                            ⛔ لقد تم حرمانك من هذا المقرر لتجاوز نسبة الغياب المسموح بها، ولن يقبل النظام تسجيلك في الجلسات القادمة.
                                        </p>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </main>
                
                <Modal isOpen={showEditPass} onClose={()=>setShowEditPass(false)} title="تغيير كلمة المرور">
                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">يرجى إدخال كلمة المرور الجديدة أدناه.</p>
                    <input type="password" value={newPass} onChange={e=>setNewPass(e.target.value)} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-400" placeholder="كلمة المرور الجديدة" />
                    <Button loading={loadingPass} onClick={handleChangePassword} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">تحديث كلمة المرور</Button>
                </Modal>
                
                {showScanner && (
                     <div className="fixed inset-0 z-[120] bg-black flex flex-col items-center justify-center p-4">
                         <div className="text-white font-bold mb-6 bg-white/20 px-6 py-2 rounded-full backdrop-blur-sm shadow-lg">وجه الكاميرا نحو الرمز</div>
                         
                         <div id="reader" className="w-full max-w-sm bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-white/30 min-h-[250px] relative mb-4">
                         </div>
                         
                         <ScannerController onScan={handleScan} />

                         <button onClick={()=>setShowScanner(false)} className="mt-8 bg-red-600/90 text-white px-10 py-3 rounded-full font-bold shadow-lg hover:bg-red-700 transition z-[130]">إلغاء و إغلاق</button>
                     </div>
                )}

                <nav className="fixed bottom-0 w-full bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex justify-around p-2 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                    <button onClick={()=>setView('home')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${view==='home'?'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20':'text-gray-400'}`}>
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        <span className="text-[10px] font-bold">الرئيسية</span>
                    </button>
                    <button onClick={()=>setView('history')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${view==='history'?'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20':'text-gray-400'}`}>
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span className="text-[10px] font-bold">السجل</span>
                    </button>
                    <button onClick={()=>{setView('warnings'); fetchWarnings();}} className={`flex flex-col items-center p-2 rounded-xl transition-colors relative ${view==='warnings'?'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20':'text-gray-400'}`}>
                        {warningsList.length > 0 && <span className="absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <span className="text-[10px] font-bold">الإنذارات</span>
                    </button>
                </nav>
            </div>
        );
    };

    const ScannerController = ({ onScan }) => {
        const [zoomCap, setZoomCap] = useState(null);
        const [zoomVal, setZoomVal] = useState(1);
        const [camError, setCamError] = useState('');
        const trackRef = useRef(null);

        useEffect(() => {
            let scanner;
            let isMounted = true;

            const startCamera = async () => {
                try {
                    scanner = new Html5Qrcode("reader");
                    await scanner.start(
                        { facingMode: "environment" }, 
                        { fps: 15, qrbox: { width: 250, height: 250 } }, 
                        (txt) => { if (isMounted) scanner.stop().then(() => onScan(txt)).catch(e => console.log(e)); }, 
                        () => {}
                    );

                    setTimeout(() => {
                        try {
                            const videoElement = document.querySelector("#reader video");
                            if (videoElement && videoElement.srcObject) {
                                const track = videoElement.srcObject.getVideoTracks()[0];
                                if (track && track.getCapabilities) {
                                    const capabilities = track.getCapabilities();
                                    if (capabilities && capabilities.zoom) {
                                        trackRef.current = track;
                                        setZoomCap(capabilities.zoom);
                                        setZoomVal(capabilities.zoom.min || 1);
                                    }
                                }
                            }
                        } catch (err) {}
                    }, 1000);
                } catch (err) {
                    if (isMounted) setCamError('الكاميرا غير متاحة، يرجى استخدام الإدخال اليدوي.');
                }
            };
            setTimeout(startCamera, 500);

            return () => { isMounted = false; try { if(scanner && scanner.isScanning) scanner.stop(); } catch(e){} };
        }, [onScan]);

        return (
            <div className="w-full flex flex-col items-center px-4">
                {camError && <div className="bg-yellow-100 text-yellow-800 p-3 rounded-xl mt-4 text-xs font-bold text-center w-full max-w-sm">⚠️ {camError}</div>}
                {zoomCap && !camError && (
                    <div className="w-full max-w-sm mt-4">
                        <div className="bg-white dark:bg-gray-800 p-3 rounded-xl flex items-center gap-3">
                            <span className="text-gray-500 text-xs font-bold">🔍 -</span>
                            <input type="range" min={zoomCap.min} max={zoomCap.max} step={zoomCap.step || 0.1} value={zoomVal} onChange={(e) => {
                                setZoomVal(Number(e.target.value));
                                try { if (trackRef.current) trackRef.current.applyConstraints({ advanced: [{ zoom: Number(e.target.value) }] }); } catch(err) {}
                            }} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                            <span className="text-gray-500 text-xs font-bold">+</span>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const AdminDashboard = ({ user, onLogout, theme, toggleTheme }) => {
        const [view, setView] = useState('createSession');
        const [uniData, setUniData] = useState({});
        const [materials, setMaterials] = useState([]);
        const [moderators, setModerators] = useState([]);
        const [toast, setToast] = useState(null);
        const [isSidebarOpen, setSidebarOpen] = useState(false);
        const [showEditPass, setShowEditPass] = useState(false);
        const [newPass, setNewPass] = useState('');
        const [loadingPass, setLoadingPass] = useState(false);
        const { confirm, config: confirmConfig, handleConfirm, handleCancel } = useConfirm();

        const refreshData = () => {
             runServer('adminAction', { type: 'getAdminData', role: user.role, name: user.name }).then(res => { 
                 if(res.status==='success') { setUniData(res.data); setMaterials(res.materials); setModerators(res.moderators); } 
             });
        };

        useEffect(() => { refreshData(); }, []);

        const handlePassChange = async () => {
             setLoadingPass(true);
             runServer('changeModeratorPassword', { nationalId: user.id, newPassword: newPass }).then(res => {
                 setLoadingPass(false); setToast({ type: res.status, message: res.message });
                 if(res.status==='success') setShowEditPass(false);
             });
        };

        const renderContent = () => {
            const props = { uniData, materials, moderators, showToast: setToast, confirm, refresh: refreshData, user };
            switch(view) {
                case 'createSession': return <AdminCreateSession {...props} />;
                case 'manageCourses': return <AdminManageCourses {...props} />;
                case 'manageSessions': return <AdminManageSessions {...props} />;
                case 'manageStudents': return <AdminManageStudents {...props} />;
                case 'warningsReport': return <AdminWarningsReport {...props} />;
                case 'reportCourse': return <AdminReportCourse {...props} />;
                case 'isolatedReport': return <AdminIsolatedReport {...props} />;
                case 'reportSession': return <AdminReportSession {...props} />;
                case 'reportStudent': return <AdminReportStudent {...props} />;
                case 'manageModerators': return <AdminManageModerators {...props} />;
                default: return <div>تحميل...</div>;
            }
        };

        return (
            <div className="min-h-screen bg-gray-50 dark:bg-gray-950 flex flex-col md:flex-row transition-colors">
                {toast && <Toast {...toast} onClose={()=>setToast(null)} />}
                <ConfirmationModal isOpen={!!confirmConfig} onClose={handleCancel} onConfirm={handleConfirm} {...confirmConfig} />
                
                <div className="md:hidden bg-gray-900 text-white p-4 flex justify-between items-center shadow-md sticky top-0 z-30 mobile-header">
                    <div className="flex items-center gap-3">
                        <button onClick={() => setSidebarOpen(true)} className="p-1 rounded hover:bg-white/10">
                             <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <span className="font-bold text-lg">لوحة الإدارة</span>
                     </div>
                    <ThemeToggle theme={theme} toggleTheme={toggleTheme} className="bg-white/10 text-white hover:bg-white/20" />
                </div>

                {isSidebarOpen && <div className="fixed inset-0 bg-black/60 z-40 md:hidden backdrop-blur-sm fade-in" onClick={() => setSidebarOpen(false)}></div>}

                <aside className={`bg-gray-900 text-white w-64 flex-shrink-0 h-screen fixed md:sticky top-0 right-0 z-50 transition-transform duration-300 ease-in-out shadow-2xl overflow-y-auto ${isSidebarOpen ? 'translate-x-0' : 'translate-x-full md:translate-x-0'}`}>
                    <div className="p-6 border-b border-gray-800 flex justify-between items-center">
                        <div>
                            <h1 className="font-bold text-xl tracking-wide">الإدارة الذكية</h1>
                             <p className="text-[10px] text-blue-400 font-bold mt-1">{user.name}</p>
                        </div>
                        <button onClick={()=>setSidebarOpen(false)} className="md:hidden text-gray-400 hover:text-white"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    </div>
                   
                    <nav className="p-3 space-y-2">
                        <div className="md:block hidden px-3 mb-2">
                             <ThemeToggle theme={theme} toggleTheme={toggleTheme} className="w-full justify-center bg-gray-800 hover:bg-gray-700" />
                         </div>
                        <MenuItem label="إنشاء جلسة" icon="M12 4v16m8-8H4" active={view==='createSession'} onClick={()=>{setView('createSession'); setSidebarOpen(false);}} />
                        <MenuItem label="إدارة الجلسات و QR" icon="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" active={view==='manageSessions'} onClick={()=>{setView('manageSessions'); setSidebarOpen(false);}} />
                        <MenuItem label="إدارة المقررات" icon="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" active={view==='manageCourses'} onClick={()=>{setView('manageCourses'); setSidebarOpen(false);}} />
                        <MenuItem label="إدارة الطلاب" icon="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" active={view==='manageStudents'} onClick={()=>{setView('manageStudents'); setSidebarOpen(false);}} />
                        <MenuItem label="إدارة الإنذارات" icon="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" active={view==='warningsReport'} onClick={()=>{setView('warningsReport'); setSidebarOpen(false);}} />

                        <div className="pt-6 pb-2 px-3 text-[10px] text-gray-500 font-bold uppercase tracking-widest">المتابعة والتقارير</div>
                        <MenuItem label="تقرير مقرر كامل" icon="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" active={view==='reportCourse'} onClick={()=>{setView('reportCourse'); setSidebarOpen(false);}} />
                        <MenuItem label="تقرير منفصل" icon="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" active={view==='isolatedReport'} onClick={()=>{setView('isolatedReport'); setSidebarOpen(false);}} />
                        <MenuItem label="تقرير جلسة" icon="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" active={view==='reportSession'} onClick={()=>{setView('reportSession'); setSidebarOpen(false);}} />
                        <MenuItem label="بحث عن طالب" icon="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" active={view==='reportStudent'} onClick={()=>{setView('reportStudent'); setSidebarOpen(false);}} />

                        {user.role === 'admin' && (
                            <>
                                <div className="pt-6 pb-2 px-3 text-[10px] text-orange-500 font-bold uppercase tracking-widest">صلاحيات المدير</div>
                                <MenuItem label="إدارة المديرين" icon="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" active={view==='manageModerators'} onClick={()=>{setView('manageModerators'); setSidebarOpen(false);}} />
                            </>
                        )}
                    </nav>
                    <div className="p-4 mt-auto border-t border-gray-800 space-y-2">
                        {user.role === 'moderator' && <button onClick={()=>setShowEditPass(true)} className="w-full text-xs text-blue-400 py-2 hover:bg-gray-800 rounded">تغيير كلمة المرور</button>}
                        <button onClick={async ()=>{ const ok = await confirm({title:'تنبيه', message:'تسجيل الخروج؟', confirmText:'خروج'}); if(ok) { localStorage.removeItem('sys_user'); onLogout() }}} className="w-full bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white py-2.5 rounded-xl font-bold text-sm transition-all duration-300">تسجيل خروج</button>
                    </div>
                </aside>

                <main className="flex-1 p-4 md:p-8 overflow-x-hidden w-full">
                    <div className="max-w-6xl mx-auto">
                        {renderContent()}
                    </div>
                </main>

                <Modal isOpen={showEditPass} onClose={()=>setShowEditPass(false)} title="تغيير كلمة المرور الخاصة بك">
                    <input type="password" value={newPass} onChange={e=>setNewPass(e.target.value)} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-400" placeholder="كلمة المرور الجديدة" />
                    <Button loading={loadingPass} onClick={handlePassChange} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">حفظ التغييرات</Button>
                </Modal>
            </div>
        );
    };

    const MenuItem = ({ label, icon, active, onClick }) => (
        <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/40' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}>
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={icon}></path></svg>
            <span className="font-bold text-sm">{label}</span>
        </button>
    );

    const AdminCreateSession = ({ uniData, showToast, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [duration, setDuration] = useState(30);
        const [lastSession, setLastSession] = useState('-');
        const [qrData, setQrData] = useState(null);
        const [loadingInfo, setLoadingInfo] = useState(false);
        const [creating, setCreating] = useState(false);

        useEffect(() => {
            if(course) {
                setLoadingInfo(true);
                runServer('adminAction', { type: 'getLastSession', uni, course, name: user.name, role: user.role }).then(res => {
                   setLoadingInfo(false);
                   if(res.status==='success') setLastSession(res.lastSession);
                });
            }
        }, [course, uni, user.name, user.role]);

        const handleCreate = async () => {
             if(!course) return;
             setCreating(true);
             const res = await runServer('adminAction', { type: 'createSession', uni, course, duration, name: user.name, role: user.role });
             setCreating(false);
             if(res.status === 'success') {
                 setQrData({ ...res, uni, course });
                 showToast({ type: 'success', message: 'تم إنشاء الجلسة بنجاح' });
             }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-2xl mx-auto fade-in">
                <h2 className="text-2xl font-bold mb-8 text-gray-800 dark:text-gray-100 flex items-center gap-3">
                    <span className="bg-blue-600 w-2 h-8 rounded-full"></span>
                    إنشاء جلسة جديدة
                </h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label className="block font-bold text-sm mb-2 text-gray-700 dark:text-gray-300">الجامعة</label>
                        <select className="w-full flex-1 min-w-0 truncate border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none focus:border-blue-500 transition" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}>
                            <option value="حكومي">جامعة حكومية</option>
                            <option value="أهلية">جامعة أهلية</option>
                        </select>
                    </div>
                    <div>
                         <label className="block font-bold text-sm mb-2 text-gray-700 dark:text-gray-300 flex justify-between">
                            المقرر 
                            {loadingInfo && <span className="loader-sm"></span>}
                            <span className="text-[10px] text-blue-500 font-bold">({lastSession})</span>
                         </label>
                         <select className="w-full flex-1 min-w-0 truncate border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none focus:border-blue-500 transition" value={course} onChange={e=>setCourse(e.target.value)}>
                            <option value="">اختر المقرر...</option>
                            {(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}
                         </select>
                    </div>
                </div>
                <div className="mb-8">
                    <label className="block font-bold text-sm mb-2 text-gray-700 dark:text-gray-300">مدة تسجيل الحضور (بالدقائق)</label>
                    <input type="number" className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none focus:border-blue-500 transition" value={duration} onChange={e=>setDuration(e.target.value)} />
                </div>
                
                {!qrData ? (
                    <Button loading={creating} onClick={handleCreate} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 dark:shadow-none">إنشاء الجلسة وتوليد الرمز</Button>
                ) : (
                    <div className="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-3xl text-center fade-in">
                        <div className="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 py-1 px-4 rounded-full text-xs font-bold inline-block mb-4">تم الإنشاء بنجاح</div>
                        <h3 className="text-xl font-bold text-blue-900 dark:text-blue-100 mb-4">{qrData.sessionName}</h3>
                        
                        <div className="flex justify-center mb-4">
                             <div className="bg-white p-4 rounded-2xl shadow-sm border-2 border-blue-100">
                                <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrData.qrData)}`} className="w-48 h-48" alt="QR" />
                             </div>
                        </div>
                        
                        <div className="bg-white dark:bg-gray-800 p-3 rounded-xl inline-block mb-6 border-2 border-dashed border-blue-300 dark:border-blue-700">
                            <p className="text-xs text-gray-500 dark:text-gray-400 mb-1 font-bold">رقم تسجيل الحضور (للطالب الذي لا تعمل كاميرته):</p>
                            <p className="text-3xl font-bold tracking-[0.3em] text-blue-600 dark:text-blue-400">{qrData.pinCode || qrData.qrData.split('|separator|').pop()}</p>
                        </div>

                        <p className="text-xs text-gray-500 dark:text-gray-400 mb-6">هذا الرمز صالح لمدة {duration} دقيقة من الآن.</p>
                        <div className="flex gap-3 justify-center">
                            <button onClick={()=>window.open(`https://api.qrserver.com/v1/create-qr-code/?size=800x800&data=${encodeURIComponent(qrData.qrData)}`, '_blank')} className="bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-md transition hover:bg-blue-700">عرض بملء الشاشة</button>
                            <button onClick={()=>setQrData(null)} className="bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-200 border border-gray-200 dark:border-gray-600 px-6 py-2.5 rounded-xl font-bold text-sm shadow-sm transition hover:bg-gray-50 dark:hover:bg-gray-600">إغلاق</button>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const AdminManageCourses = ({ uniData, materials, refresh, showToast, confirm, user }) => {
        const [newCourse, setNewCourse] = useState('');
        const [uni, setUni] = useState('حكومي');
        const [loadingAdd, setLoadingAdd] = useState(false);

        const handleAdd = async () => {
             if(!newCourse) return;
             setLoadingAdd(true);
             const res = await runServer('adminAction', { type: 'addCourse', uni, courseName: newCourse, name: user.name, role: user.role });
             setLoadingAdd(false);
             if(res.status === 'success') { showToast({type:'success', message:'تم إضافة المقرر بنجاح'}); setNewCourse(''); refresh(); }
             else showToast({type:'error', message: res.message});
        };

        const handleDelete = async (courseName) => {
             const ok = await confirm({ title:'حذف مقرر', message: `هل تريد حذف ${courseName}؟ ${user.role === 'admin' ? '(سيتم الحذف نهائياً للجميع)' : '(سيتم حذفه من حسابك فقط)'}` });
             if(ok) {
                 const res = await runServer('adminAction', { type: 'deleteCourse', uni, courseName, role: user.role, name: user.name });
                 if(res.status==='success') { showToast({type:'success', message:'تم الحذف بنجاح'}); refresh(); }
             }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-3xl mx-auto fade-in">
                 <h2 className="text-2xl font-bold mb-8 text-gray-800 dark:text-gray-100">إدارة المقررات الدراسية</h2>
                 <div className="flex flex-col sm:flex-row gap-3 mb-8 w-full">
                     <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none w-full sm:w-auto" value={uni} onChange={e=>setUni(e.target.value)}><option value="حكومي">حكومي</option><option value="أهلية">أهلية</option></select>
                     <input type="text" list="materials-list" className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 min-w-0 w-full outline-none focus:border-blue-400 transition" placeholder="اسم المقرر الجديد" value={newCourse} onChange={e=>setNewCourse(e.target.value)} />
                     <datalist id="materials-list">
                        {materials.map(m=><option key={m} value={m} />)}
                     </datalist>
                     <Button loading={loadingAdd} onClick={handleAdd} className="bg-green-600 text-white px-8 rounded-2xl font-bold w-full sm:w-auto">إضافة</Button>
                 </div>
                 <div className="space-y-3">
                     {(uniData[uni]||[]).length === 0 && <p className="text-center text-gray-400 py-10">لا يوجد مقررات مسجلة لهذه الجامعة.</p>}
                     {(uniData[uni]||[]).map(c => (
                         <div key={c} className="group flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-700/30 rounded-2xl border border-transparent hover:border-gray-200 dark:hover:border-gray-600 transition">
                             <div>
                                <span className="font-bold text-gray-700 dark:text-gray-200">{c}</span>
                                <p className="text-[10px] text-gray-400 mt-1 uppercase">COURSE DATA</p>
                             </div>
                             <button onClick={()=>handleDelete(c)} className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition p-2 bg-white dark:bg-gray-700 rounded-xl shadow-sm">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                             </button>
                         </div>
                     ))}
                 </div>
            </div>
        );
    };

    const AdminManageStudents = ({ uniData, showToast, confirm, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [students, setStudents] = useState([]);
        const [loading, setLoading] = useState(false);
        const [showModal, setShowModal] = useState(false);
        const [showBatchModal, setShowBatchModal] = useState(false);
        const [editMode, setEditMode] = useState(false);
        const [studentForm, setStudentForm] = useState({ name: '', id: '', pass: '', rowIndex: null });
        const [batchText, setBatchText] = useState('');

        const load = useCallback(() => {
            if (course) {
                setLoading(true);
                runServer('adminAction', { type: 'getCourseStudents', uni, course }).then(res => {
                    setLoading(false);
                    if (res.status === 'success') {
                        const sorted = res.students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                        setStudents(sorted);
                    }
                });
            } else {
                setStudents([]);
            }
        }, [uni, course]);

        useEffect(load, [course, load]);

        const handleSubmit = async () => {
            if (!studentForm.name || !studentForm.id) return;
            setLoading(true);
            const res = await runServer('adminAction', { type: 'manageStudent', uni, course, actionType: editMode ? 'edit' : 'add', studentData: studentForm });
            setLoading(false);
            if (res.status === 'success') {
                showToast({ type: 'success', message: editMode ? 'تم التعديل' : 'تمت الإضافة بنجاح' });
                setShowModal(false);
                load();
            }
        };

        const handleDelete = async (stu) => {
            const ok = await confirm({ title: 'تأكيد الحذف', message: `حذف الطالب ${stu.name} من المقرر نهائياً؟` });
            if (ok) {
                const res = await runServer('adminAction', { type: 'manageStudent', uni, course, actionType: 'delete', studentData: stu });
                if (res.status === 'success') {
                    showToast({ type: 'success', message: 'تم الحذف' });
                    load();
                }
            }
        };

        const handleBatchAdd = async () => {
            if (!batchText.trim()) return;
            const lines = batchText.trim().split('\n');
            const studentsToAdd = [];
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                // البحث عن أول 14 رقم متتالي
                const match = line.match(/(\d{14})/);
                if (!match) continue;
                const nationalId = match[1];
                const idIndex = match.index;
                let name = line.substring(0, idIndex).trim();
                let pass = line.substring(idIndex + 14).trim();
                if (name && nationalId) {
                    studentsToAdd.push({ name, id: nationalId, pass });
                }
            }
            if (studentsToAdd.length === 0) {
                showToast({ type: 'error', message: 'لم يتم العثور على بيانات صالحة (تأكد من وجود الرقم القومي 14 رقم)' });
                return;
            }
            const ok = await confirm({ title: 'تأكيد الإضافة الجماعية', message: `هل تريد إضافة ${studentsToAdd.length} طالب دفعة واحدة؟`, type: 'primary' });
            if (!ok) return;
            setLoading(true);
            const res = await runServer('adminAction', { type: 'batchAddStudents', uni, course, students: studentsToAdd });
            setLoading(false);
            if (res.status === 'success') {
                showToast({ type: 'success', message: res.message });
                setShowBatchModal(false);
                setBatchText('');
                load();
            } else {
                showToast({ type: 'error', message: res.message || 'حدث خطأ' });
            }
        };

        const getGender = (id) => {
            if (!id || String(id).length !== 14) return 'غير محدد';
            const digit = parseInt(String(id).charAt(12));
            return digit % 2 === 0 ? 'أنثى' : 'ذكر';
        };

        const getStats = () => {
            let male = 0, female = 0;
            students.forEach(s => {
                if (getGender(s.id) === 'ذكر') male++;
                else if (getGender(s.id) === 'أنثى') female++;
            });
            return { total: students.length, male, female };
        };
        const stats = getStats();

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in w-full">
                <div className="flex flex-wrap gap-4 mb-6 no-print items-center border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e => { setUni(e.target.value); setCourse(''); }}>
                        <option value="حكومي">حكومي</option><option value="أهلية">أهلية</option>
                    </select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e => setCourse(e.target.value)}>
                            <option value="">اختر المقرر...</option>
                            {(uniData[uni] || []).map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    {course && (
                        <div className="flex gap-2 flex-wrap">
                            <Button onClick={() => { setEditMode(false); setStudentForm({ name: '', id: '', pass: '' }); setShowModal(true); }} className="bg-green-600 text-white px-4 rounded-2xl font-bold">إضافة طالب</Button>
                            <Button onClick={() => setShowBatchModal(true)} className="bg-purple-600 text-white px-4 rounded-2xl font-bold">إضافة دفعة</Button>
                            <button onClick={() => window.print()} className="bg-gray-800 text-white px-4 rounded-2xl font-bold">طباعة</button>
                        </div>
                    )}
                </div>

                {course && (
                    <div className="fade-in">
                        <div className="print-only text-center mb-6">
                            <h2 className="text-xl font-bold">كشف أسماء الطلاب</h2>
                            <p className="text-gray-600">{course} - {uni}</p>
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-6 text-center no-print">
                            <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800"><span className="block text-2xl font-bold text-blue-600 dark:text-blue-400">{stats.total}</span><span className="text-xs text-blue-500">إجمالي الطلاب</span></div>
                            <div className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800"><span className="block text-2xl font-bold text-indigo-600 dark:text-indigo-400">{stats.male}</span><span className="text-xs text-indigo-500">ذكور</span></div>
                            <div className="bg-pink-50 dark:bg-pink-900/20 p-4 rounded-xl border border-pink-100 dark:border-pink-800"><span className="block text-2xl font-bold text-pink-600 dark:text-pink-400">{stats.female}</span><span className="text-xs text-pink-500">إناث</span></div>
                        </div>

                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-center border-collapse">
                                <thead>
                                    <tr className="bg-gray-50 dark:bg-gray-700/50 text-gray-400 font-bold uppercase tracking-wider text-[10px]">
                                        <th className="p-3 border-b dark:border-gray-600">م</th>
                                        <th className="p-3 border-b dark:border-gray-600 text-right">اسم الطالب</th>
                                        <th className="p-3 border-b dark:border-gray-600">النوع</th>
                                        <th className="p-3 border-b dark:border-gray-600">الرقم القومي</th>
                                        <th className="p-3 border-b dark:border-gray-600 no-print">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {students.map((stu, i) => (
                                        <tr key={i} className="hover:bg-gray-50/50 dark:hover:bg-gray-700/30 transition">
                                            <td className="p-3 border-b dark:border-gray-600 text-gray-400">{i + 1}</td>
                                            <td className="p-3 border-b dark:border-gray-600 font-bold text-gray-700 dark:text-gray-200 text-right">{stu.name}</td>
                                            <td className="p-3 border-b dark:border-gray-600 text-xs font-bold text-gray-500 dark:text-gray-400">{getGender(stu.id)}</td>
                                            <td className="p-3 border-b dark:border-gray-600 text-gray-500 font-mono tracking-widest">{stu.id}</td>
                                            <td className="p-3 border-b dark:border-gray-600 no-print">
                                                <div className="flex justify-center gap-2">
                                                    <button onClick={() => { setEditMode(true); setStudentForm({ ...stu, pass: stu.pass || '' }); setShowModal(true); }} className="text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30 p-2 rounded-lg transition"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                                                    <button onClick={() => handleDelete(stu)} className="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-2 rounded-lg transition"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                    {students.length === 0 && <tr><td colSpan="5" className="p-6 text-gray-400">لا يوجد طلاب مسجلين</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                <Modal isOpen={showModal} onClose={() => setShowModal(false)} title={editMode ? "تعديل بيانات الطالب" : "إضافة طالب جديد"}>
                    <input type="text" placeholder="اسم الطالب (رباعي)" value={studentForm.name} onChange={e => setStudentForm({ ...studentForm, name: e.target.value })} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-400" />
                    <input type="number" placeholder="الرقم القومي (14 رقم)" value={studentForm.id} onChange={e => setStudentForm({ ...studentForm, id: e.target.value })} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-400" />
                    <input type="text" placeholder="كلمة المرور (اختياري)" value={studentForm.pass} onChange={e => setStudentForm({ ...studentForm, pass: e.target.value })} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-400" />
                    <Button loading={loading} onClick={handleSubmit} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">{editMode ? 'حفظ التعديلات' : 'إضافة للقائمة'}</Button>
                </Modal>

                <Modal isOpen={showBatchModal} onClose={() => setShowBatchModal(false)} title="إضافة دفعة طلاب">
                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-2">أدخل بيانات الطلاب كل طالب في سطر منفصل، بالصيغة: الاسم ثم الرقم القومي (14 رقم) ثم كلمة المرور (اختياري) - مثال: أحمد محمد علي 12345678901234 12345</p>
                    <textarea rows="10" className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-400 font-mono text-sm" value={batchText} onChange={e => setBatchText(e.target.value)} placeholder="أحمد محمد علي 12345678901234 12345&#10;محمد سعيد 12345678901235"></textarea>
                    <Button loading={loading} onClick={handleBatchAdd} className="w-full bg-purple-600 text-white py-3 rounded-xl font-bold">إضافة الدفعة</Button>
                </Modal>
            </div>
        );
    };

    const AdminWarningsReport = ({ uniData, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [wType, setWType] = useState('warning');
        const [warnings, setWarnings] = useState([]);
        const [loading, setLoading] = useState(false);
        const [searched, setSearched] = useState(false);

        const load = () => {
            if (!course) return;
            setLoading(true);
            runServer('adminAction', { type: 'getCourseWarnings', uni, course, warningType: wType, role: user.role, name: user.name }).then(res => {
                setLoading(false);
                setSearched(true);
                if (res.status === 'success') setWarnings(res.warnings);
            });
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in w-full">
                <div className="flex flex-wrap gap-4 mb-6 no-print items-center border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e => { setUni(e.target.value); setCourse(''); setSearched(false); }}>
                        <option value="حكومي">حكومي</option><option value="أهلية">أهلية</option>
                    </select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e => {setCourse(e.target.value); setSearched(false);}}>
                            <option value="">اختر المقرر...</option>
                            {(uniData[uni] || []).map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={wType} onChange={e => {setWType(e.target.value); setSearched(false);}}>
                        <option value="warning">إنذار غياب (3 غيابات)</option>
                        <option value="deprived">حرمان (4 غيابات أو أكثر)</option>
                    </select>
                    <Button loading={loading} onClick={load} className="bg-blue-600 text-white px-8 rounded-2xl font-bold">بحث</Button>
                    <button onClick={() => window.print()} className="bg-gray-800 text-white px-6 rounded-2xl font-bold">طباعة</button>
                </div>

                {searched && (
                    <div className="fade-in">
                        <div className="mb-4 text-center print-only">
                            <h2 className="text-xl font-bold">{wType === 'warning' ? 'كشف إنذارات الغياب' : 'كشف المحرومين من المقرر'}</h2>
                            <p className="text-gray-500">{course} - {uni}</p>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-center border-collapse">
                                <thead>
                                    <tr className={`font-bold uppercase tracking-wider text-[10px] text-white ${wType === 'warning' ? 'bg-yellow-500' : 'bg-red-600'}`}>
                                        <th className="p-3 border-b border-white/20">م</th>
                                        <th className="p-3 border-b border-white/20 text-right">اسم الطالب</th>
                                        <th className="p-3 border-b border-white/20">الرقم القومي</th>
                                        <th className="p-3 border-b border-white/20">إجمالي الغياب</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {warnings.map((w, i) => (
                                        <tr key={i} className={`transition ${wType === 'warning' ? 'hover:bg-yellow-50 dark:hover:bg-yellow-900/10' : 'hover:bg-red-50 dark:hover:bg-red-900/10'}`}>
                                            <td className="p-3 border-b dark:border-gray-700 text-gray-400">{i + 1}</td>
                                            <td className="p-3 border-b dark:border-gray-700 font-bold text-gray-700 dark:text-gray-200 text-right">{w.name}</td>
                                            <td className="p-3 border-b dark:border-gray-700 text-gray-500">{w.id}</td>
                                            <td className="p-3 border-b dark:border-gray-700 font-bold text-lg">{w.absentCount}</td>
                                        </tr>
                                    ))}
                                    {warnings.length === 0 && <tr><td colSpan="4" className="p-6 text-gray-400">لا يوجد بيانات لهذه الحالة</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const AdminManageModerators = ({ moderators, refresh, showToast, confirm }) => {
        const [name, setName] = useState('');
        const [id, setId] = useState('');
        const [password, setPassword] = useState('');
        const [loadingAdd, setLoadingAdd] = useState(false);

        const handleAdd = async () => {
             if(!name || !id || !password) return;
             setLoadingAdd(true);
             const res = await runServer('adminAction', { type: 'addModerator', name, id, password });
             setLoadingAdd(false);
             if(res.status === 'success') { showToast({type:'success', message:'تم إضافة المدير بنجاح'}); setName(''); setId(''); setPassword(''); refresh(); }
        };

        const handleDelete = async (m) => {
             if(await confirm({title:'تأكيد الحذف',message:`حذف المدير ${m.name}؟`})){
                 runServer('adminAction',{type:'deleteModerator',id:m.id}).then(()=>refresh())
             }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-4xl mx-auto fade-in">
                 <h2 className="text-2xl font-bold mb-8 text-gray-800 dark:text-gray-100">إدارة المديرين والمساعدين</h2>
                 <div className="flex flex-col sm:flex-row gap-3 mb-8">
                     <input type="text" className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 outline-none focus:border-blue-400" placeholder="الاسم (مثال: د. أحمد)" value={name} onChange={e=>setName(e.target.value)} />
                     <input type="number" className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 outline-none focus:border-blue-400" placeholder="الرقم القومي" value={id} onChange={e=>setId(e.target.value)} />
                     <input type="text" className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 outline-none focus:border-blue-400" placeholder="كلمة المرور الافتراضية" value={password} onChange={e=>setPassword(e.target.value)} />
                     <Button loading={loadingAdd} onClick={handleAdd} className="bg-green-600 text-white px-8 rounded-2xl font-bold">إنشاء مدير</Button>
                 </div>
                 <div className="overflow-x-auto">
                    <table className="w-full text-sm text-center">
                        <thead className="text-gray-400 dark:text-gray-500 font-bold border-b dark:border-gray-700 pb-4">
                            <tr><th className="pb-4">اسم المدير</th><th className="pb-4">الرقم القومي</th><th className="pb-4">إجراءات</th></tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50 dark:divide-gray-700">
                            {moderators.length === 0 && <tr><td colSpan="3" className="py-10 text-gray-400">لا يوجد مديرين مسجلين</td></tr>}
                            {moderators.map(m => (
                                <tr key={m.id} className="hover:bg-gray-50/50 dark:hover:bg-gray-700/30 transition">
                                    <td className="py-4 font-bold text-gray-700 dark:text-gray-200">{m.name}</td>
                                    <td className="py-4 text-gray-400 dark:text-gray-500">{m.id}</td>
                                    <td className="py-4">
                                        <button onClick={()=>handleDelete(m)} className="text-red-400 hover:text-red-600 font-bold">حذف نهائي</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                 </div>
            </div>
        );
    };

    const AdminManageSessions = ({ uniData, showToast, confirm, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [sessions, setSessions] = useState([]);
        const [loading, setLoading] = useState(false);
        const [manageQR, setManageQR] = useState(null);
        
        const load = useCallback(() => {
             if(course) {
                 setLoading(true);
                 runServer('adminAction', { type: 'getSessionDetails', uni, course, role: user.role, name: user.name }).then(res => { 
                     setLoading(false);
                     if(res.status==='success') setSessions(res.sessions); 
                 });
             }
        }, [uni, course, user.role, user.name]);

        useEffect(load, [course, load]);
        
        const handleDelete = async (s) => {
            const msg = user.role === 'admin' 
                ? `هل أنت متأكد من حذف ${s.session} نهائياً للجميع؟`
                : `هل أنت متأكد من حذف ${s.session} الخاصة بك فقط؟ (لن يتم مسح حضور المديرين الآخرين في نفس الجلسة)`;

            const ok = await confirm({ title:'حذف جلسة', message: msg, confirmText:'نعم، حذف' });
            if(ok) {
                 await runServer('adminAction', { type: 'deleteSession', uni, course, sessionName: s.session, role: user.role, name: user.name });
                 showToast({ type:'success', message: 'تم الحذف بنجاح' });
                 load();
            }
        };

        const handleStopSession = async (s) => {
             const ok = await confirm({ title:'إيقاف الجلسة', message: 'هل تريد إيقاف عمل الرمز يدوياً؟', confirmText:'إيقاف' });
             if(ok) {
                await runServer('adminAction', { type: 'toggleQR', qrCode: s.qrCode, newStatus: 'لا يعمل' });
                showToast({ type:'info', message: 'تم إيقاف الجلسة' });
                setManageQR(null);
                load();
             }
        };

        const handleChangeTime = async (s) => {
            const newTime = prompt("أدخل الوقت الجديد بالدقائق:", "30");
            if(!newTime) return;
            const res = await runServer('adminAction', { type: 'changeQR', uni, course, duration: newTime, sessionNameOverride: s.session, name: user.name, role: user.role });
            if(res && res.status === 'success') {
                showToast({ type: 'success', message: 'تم تحديث وقت الجلسة' });
                setManageQR(null);
                load();
            }
        };

        const handleCreateNewQR = async (s) => {
            const newTime = prompt("أدخل وقت الرمز الجديد بالدقائق:", "30");
            if(!newTime) return;
            const res = await runServer('adminAction', { type: 'changeQR', uni, course, duration: newTime, sessionNameOverride: s.session, name: user.name, role: user.role });
            if(res && res.status === 'success') {
                showToast({ type: 'success', message: 'تم تفعيل رمز جديد' });
                setManageQR(null);
                load();
            }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in w-full">
                <div className="flex flex-col md:flex-row gap-4 mb-8 items-center border-b dark:border-gray-700 pb-6 w-full">
                     <select className="w-full md:w-auto border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}>
                         <option value="حكومي">حكومي</option>
                         <option value="أهلية">أهلية</option>
                     </select>
                     <select className="w-full md:w-auto border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 min-w-0 truncate outline-none" value={course} onChange={e=>setCourse(e.target.value)}>
                        <option value="">اختر المقرر...</option>
                        {(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}
                    </select>
                    {loading && <div className="loader-sm"></div>}
                </div>
                
                <div className="overflow-x-auto w-full">
                    <table className="w-full text-sm text-center">
                        <thead className="text-gray-400 dark:text-gray-500 font-bold">
                            <tr>
                                <th className="pb-4 min-w-[100px]">الجلسة</th>
                                {user.role === 'admin' && <th className="pb-4 min-w-[100px]">المنشئ</th>}
                                <th className="pb-4 min-w-[120px]">الإنشاء</th>
                                <th className="pb-4">الحضور</th>
                                <th className="pb-4 min-w-[100px]">الحالة</th>
                                <th className="pb-4 min-w-[150px]">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50 dark:divide-gray-700">
                            {sessions.length === 0 && <tr><td colSpan={user.role === 'admin' ? 6 : 5} className="py-10 text-gray-400">لا يوجد بيانات</td></tr>}
                            {sessions.map((s, idx) => (
                                <tr key={idx} className="hover:bg-gray-50/50 dark:hover:bg-gray-700/30 transition">
                                    <td className="py-4 font-bold text-gray-700 dark:text-gray-200">{s.session}</td>
                                    {user.role === 'admin' && <td className="py-4 text-xs font-bold text-blue-500">{s.creator}</td>}
                                    <td className="py-4 text-xs text-gray-400 dark:text-gray-500">{s.creationDate}</td>
                                    <td className="py-4">
                                        <span className="text-green-600 dark:text-green-400 font-bold bg-green-50 dark:bg-green-900/20 px-3 py-1 rounded-lg">{s.present}</span>
                                    </td>
                                    <td className="py-4">
                                        <span className={`px-3 py-1 rounded-lg text-[10px] font-bold ${s.qrStatus === 'يعمل' ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'}`}>
                                            {s.qrStatus}
                                        </span>
                                    </td>
                                    <td className="py-4 flex justify-center gap-2">
                                         <button onClick={()=>setManageQR(s)} className="text-blue-600 dark:text-blue-400 font-bold text-xs bg-blue-50 dark:bg-blue-900/20 px-4 py-2 rounded-xl transition hover:bg-blue-100 dark:hover:bg-blue-900/40 shadow-sm border border-blue-100 dark:border-blue-900/30">إدارة QR</button>
                                         <button onClick={()=>handleDelete(s)} className="text-red-400 hover:text-red-600 p-2 transition">
                                             <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                         </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>

                <Modal isOpen={!!manageQR} onClose={()=>setManageQR(null)} title={`إدارة QR - ${manageQR?.session}`}>
                    {manageQR && (
                        <div className="text-center p-4 fade-in">
                            <div className="mb-6">
                                <span className={`px-4 py-1.5 rounded-full text-xs font-bold ${manageQR.qrStatus === 'يعمل' ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300' : 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300'}`}>
                                    الحالة: {manageQR.qrStatus === 'يعمل' ? 'نشط (متاح للتسجيل)' : 'غير نشط (مغلق)'}
                                </span>
                            </div>

                            {manageQR.qrStatus === 'يعمل' ? (
                                <>
                                    <div className="flex justify-center mb-4">
                                         <div className="bg-white p-4 rounded-3xl shadow-sm border border-gray-100">
                                            <img src={`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(manageQR.qrCode)}`} className="w-56 h-56" />
                                         </div>
                                    </div>
                                    
                                    <div className="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-xl inline-block mb-6 border border-gray-200 dark:border-gray-600 w-full max-w-[250px]">
                                        <p className="text-[10px] text-gray-500 dark:text-gray-400 mb-1 font-bold">الرقم السري للطلاب (للإدخال اليدوي):</p>
                                        <p className="text-2xl font-bold tracking-[0.2em] text-gray-800 dark:text-gray-100">{manageQR.qrCode.split('|separator|').pop()}</p>
                                    </div>

                                    <div className="flex flex-col sm:flex-row gap-3 justify-center">
                                        <Button onClick={()=>handleChangeTime(manageQR)} className="bg-yellow-500 text-white px-8 py-3 rounded-2xl font-bold">تغيير وقت الجلسة</Button>
                                        <Button onClick={()=>handleStopSession(manageQR)} className="bg-red-600 text-white px-8 py-3 rounded-2xl font-bold">إيقاف الحضور يدوياً</Button>
                                    </div>
                                </>
                             ) : (
                                <div className="py-10">
                                    <p className="text-gray-400 mb-8 text-sm">هذا الرمز انتهى أو تم إيقافه. يمكنك تفعيل الحضور مجدداً.</p>
                                    <Button onClick={()=>handleCreateNewQR(manageQR)} className="bg-green-600 text-white px-10 py-4 rounded-3xl font-bold shadow-lg shadow-green-200 dark:shadow-none mx-auto">تفعيل رمز QR جديد للجلسة</Button>
                                </div>
                            )}
                        </div>
                    )}
                </Modal>
            </div>
        );
    };

    const AdminReportCourse = ({ uniData }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);

        const load = async () => {
            if(!course) return;
            setLoading(true);
            const res = await runServer('getCourseReport', { uni, course });
            setLoading(false);
            if(res.status === 'success') setData(res);
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in overflow-x-auto w-full">
                <div className="flex flex-wrap gap-4 mb-8 no-print border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option><option value="أهلية">أهلية</option></select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e=>setCourse(e.target.value)}><option value="">اختر المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}</select>
                    </div>
                    <Button loading={loading} onClick={load} className="bg-blue-600 text-white px-8 rounded-2xl font-bold">عرض البيانات</Button>
                    <button onClick={()=>window.print()} className="bg-gray-800 text-white px-8 rounded-2xl font-bold">طباعة</button>
                </div>
                {data && (
                    <>
                        <div className="print-only text-center mb-6">
                            <h2 className="text-xl font-bold">تقرير مقرر كامل</h2>
                            <p className="text-gray-600">{course} - {uni}</p>
                        </div>
                        <table className="w-full text-xs text-center border-collapse">
                            <thead>
                                <tr className="bg-gray-50 dark:bg-gray-700 text-gray-400">
                                    {data.headers.map((h,i) => <th key={i} className="p-3 border-b dark:border-gray-600 text-center font-bold">{h}</th>)}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                                {data.rows.map((row, i) => (
                                    <tr key={i} className="hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                                        {row.map((cell, j) => {
                                            let className = "p-3 text-center whitespace-pre-wrap";
                                            if (j === 1) className += " font-bold bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded-lg";
                                            else if (j === 2) className += " font-bold bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300 rounded-lg";
                                            else if (j > 3) className += cell === '✓' ? " text-green-600 dark:text-green-400 font-bold text-lg" : " text-red-400 dark:text-red-500 font-bold text-lg";
                                            else className += " text-gray-700 dark:text-gray-200 font-semibold";
                                            return <td key={j} className={className}>{cell}</td>;
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </>
                )}
            </div>
        );
    };

    const AdminIsolatedReport = ({ uniData, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [courseMods, setCourseMods] = useState([]);
        const [selectedMod, setSelectedMod] = useState(user.role === 'moderator' ? user.name : '');
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
            if(course && user.role === 'admin') {
                runServer('adminAction', { type: 'getCourseModerators', uni, course }).then(res => {
                    if(res.status === 'success') {
                        setCourseMods(res.courseModerators);
                        setSelectedMod('');
                    }
                });
            }
        }, [uni, course, user.role]);

        const load = async () => {
            if(!course) return;
            if (user.role === 'admin' && !selectedMod) {
                alert('يرجى اختيار مدير');
                return;
            }
            const targetModerator = user.role === 'admin' ? selectedMod : user.name;
            setLoading(true);
            const res = await runServer('getIsolatedCourseReport', { uni, course, targetModerator });
            setLoading(false);
            if(res.status === 'success') setData(res);
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in overflow-x-auto w-full">
                <div className="flex flex-wrap gap-4 mb-8 no-print border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option><option value="أهلية">أهلية</option></select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e=>setCourse(e.target.value)}><option value="">اختر المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}</select>
                    </div>
                    {user.role === 'admin' && (
                        <div className="flex-1 min-w-0">
                            <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={selectedMod} onChange={e=>setSelectedMod(e.target.value)}>
                                <option value="">اختر المدير...</option>
                                {courseMods.map(m=><option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>
                    )}

                    <Button loading={loading} onClick={load} className="bg-blue-600 text-white px-8 rounded-2xl font-bold">عرض التقرير المنفصل</Button>
                    <button onClick={()=>window.print()} className="bg-gray-800 text-white px-8 rounded-2xl font-bold">طباعة</button>
                </div>
                {data && (
                    <div className="fade-in">
                        <div className="mb-4 text-center print-only">
                            <h2 className="text-xl font-bold">تقرير حضور - {selectedMod || user.name}</h2>
                            <p className="text-gray-500">{course} - {uni}</p>
                        </div>
                        <table className="w-full text-xs text-center border-collapse">
                            <thead>
                                <tr className="bg-gray-50 dark:bg-gray-700 text-gray-400">
                                    {data.headers.map((h,i) => <th key={i} className="p-3 border-b dark:border-gray-600 text-center font-bold">{h}</th>)}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                                {data.rows.map((row, i) => (
                                    <tr key={i} className="hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                                        {row.map((cell, j) => {
                                            let className = "p-3 text-center whitespace-pre-wrap";
                                            if (j === 1) className += " font-bold bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded-lg";
                                            else if (j === 2) className += " font-bold bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300 rounded-lg";
                                            else if (j > 3) className += cell === '✓' ? " text-green-600 dark:text-green-400 font-bold text-lg" : " text-red-400 dark:text-red-500 font-bold text-lg";
                                            else className += " text-gray-700 dark:text-gray-200 font-semibold";
                                            return <td key={j} className={className}>{cell}</td>;
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        );
    };

    const AdminReportSession = ({ uniData, confirm, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [sessions, setSessions] = useState([]);
        const [selSession, setSelSession] = useState('');
        const [report, setReport] = useState(null);
        const [loadingSessions, setLoadingSessions] = useState(false);
        const [loadingReport, setLoadingReport] = useState(false);

        useEffect(() => {
            if(course) {
                setLoadingSessions(true);
                runServer('adminAction', { type: 'getSessionDetails', uni, course, role: user.role, name: user.name }).then(res => { 
                    setLoadingSessions(false);
                    if(res.status==='success') setSessions(res.sessions); 
                });
            }
        }, [course, uni, user.role, user.name]);

        const load = async () => {
             if(!selSession) return;
             setLoadingReport(true);
             const res = await runServer('getSessionReport', { uni, course, session: selSession, role: user.role, name: user.name });
             setLoadingReport(false);
             if(res.status === 'success') setReport(res.report);
        };

        const toggleStatus = async (item) => {
             const newStatus = item.status === 'حضور' ? 'absent' : 'present';
             const ok = await confirm({ title:'تعديل الحالة', message: `تحويل حالة الطالب إلى ${newStatus === 'present' ? 'حضور' : 'غياب'}؟`, type: 'primary' });
             if(ok) {
                const res = await runServer('updateAttendanceCell', { 
                    uni, course, rowIndex: item.rowIndex, colIndex: item.colIndex, status: newStatus, sessionName: selSession, editorName: user.name 
                });
                if(res.status === 'success') {
                    setReport(prev => prev.map(r => r.id === item.id ? { ...r, status: newStatus==='present'?'حضور':'غياب', color: newStatus==='present'?'green':'red', time: res.newValue } : r));
                }
             }
        };

        const uniqueSessionNames = Array.from(new Set(sessions.map(s => s.session)));

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-5xl mx-auto fade-in w-full">
                 <div className="flex flex-wrap gap-4 mb-8 no-print items-center border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option><option value="أهلية">أهلية</option></select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e=>setCourse(e.target.value)}><option value="">اختر المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}</select>
                    </div>
                    <div className="relative flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={selSession} onChange={e=>setSelSession(e.target.value)}>
                            <option value="">اختر الجلسة...</option>
                            {uniqueSessionNames.map((sessionName, idx)=><option key={idx} value={sessionName}>{sessionName}</option>)}
                        </select>
                        {loadingSessions && <div className="absolute left-10 top-4 loader-sm"></div>}
                    </div>
                    <Button loading={loadingReport} onClick={load} className="bg-blue-600 text-white px-8 rounded-2xl font-bold">عرض</Button>
                    <button onClick={()=>window.print()} className="bg-gray-800 text-white px-8 rounded-2xl font-bold">طباعة</button>
                </div>
               
                 {report && (
                    <div className="fade-in">
                        <div className="mb-6 flex justify-between items-center px-4">
                            <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100">{uni} - {course} - {selSession}</h2>
                            <span className="text-xs text-gray-400">إجمالي الطلاب: {report.length}</span>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-center border-collapse">
                                <thead>
                                    <tr className="bg-gray-50 dark:bg-gray-700/50 text-gray-400 font-bold uppercase tracking-wider text-[10px]">
                                        <th className="p-3 border-b dark:border-gray-600">الاسم</th>
                                        <th className="p-3 border-b dark:border-gray-600">الرقم القومي</th>
                                        <th className="p-3 border-b dark:border-gray-600">الحالة</th>
                                        <th className="p-3 border-b dark:border-gray-600">التوقيت / التفاصيل</th>
                                        <th className="p-3 border-b dark:border-gray-600 no-print">تعديل</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {report.map((r,i) => (
                                        <tr key={i} className="hover:bg-gray-50/50 dark:hover:bg-gray-700/30 transition">
                                            <td className="p-3 border-b dark:border-gray-600 font-bold text-gray-700 dark:text-gray-200">{r.name}</td>
                                            <td className="p-3 border-b dark:border-gray-600 text-gray-400">{r.id}</td>
                                            <td className={`p-3 border-b dark:border-gray-600 font-bold ${r.color==='green'?'text-green-600 dark:text-green-400':'text-red-400'}`}>
                                                <span className={`px-3 py-1 rounded-lg ${r.color==='green'?'bg-green-50 dark:bg-green-900/20':'bg-red-50 dark:bg-red-900/20'}`}>{r.status}</span>
                                            </td>
                                            <td className="p-3 border-b dark:border-gray-600 text-[10px] text-gray-400 whitespace-pre-wrap">{r.time}</td>
                                            <td className="p-3 border-b dark:border-gray-600 no-print">
                                                <button onClick={()=>toggleStatus(r)} className="text-blue-500 hover:text-blue-700 dark:hover:text-blue-300 text-xs font-bold transition p-1 bg-blue-50 dark:bg-blue-900/20 rounded-lg">تغيير</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const AdminReportStudent = ({ uniData, confirm, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [query, setQuery] = useState('');
        const [results, setResults] = useState(null);
        const [loading, setLoading] = useState(false);

        const search = async () => {
            if(!course) return;
            setLoading(true);
            const res = await runServer('getStudentSearchReport', { uni, course, query, role: user.role, name: user.name });
            setLoading(false);
            if(res.status === 'success') setResults(res);
        };

        const toggle = async (student, session) => {
            const newStatus = session.val === 'حضور' ? 'absent' : 'present';
            const ok = await confirm({ title: 'تعديل السجل', message: `تغيير حالة الطالب في ${session.name}؟`, type: 'primary' });
            if(ok) {
                await runServer('updateAttendanceCell', { uni, course, rowIndex: student.rowIndex, sessionName: session.name, status: newStatus, editorName: user.name });
                search(); 
            }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-5xl mx-auto fade-in w-full">
                 <div className="flex flex-wrap gap-4 mb-8 no-print border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option><option value="أهلية">أهلية</option></select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e=>setCourse(e.target.value)}><option value="">اختر المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}</select>
                    </div>
                    <input type="text" className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 min-w-0 outline-none focus:border-blue-400" placeholder="الاسم أو الرقم القومي" value={query} onChange={e=>setQuery(e.target.value)} />
                    <Button loading={loading} onClick={search} className="bg-blue-600 text-white px-8 rounded-2xl font-bold">بحث</Button>
                </div>
             
                {results && (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center mb-4">
                             <h3 className="font-bold text-gray-800 dark:text-gray-200">نتائج البحث ({results.results.length})</h3>
                        </div>
                        {results.results.map((stu, i) => (
                            <div key={i} className="bg-gray-50/50 dark:bg-gray-700/20 border border-gray-100 dark:border-gray-700 rounded-3xl p-6 fade-in shadow-sm">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6 border-b border-gray-200/50 dark:border-gray-600 pb-4">
                                    <div>
                                        <h4 className="font-bold text-lg text-gray-800 dark:text-gray-100">{stu.name}</h4>
                                        <p className="text-xs text-gray-400 font-bold tracking-widest">{stu.id}</p>
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="text-center bg-green-50 dark:bg-green-900/20 px-4 py-2 rounded-2xl border border-green-100 dark:border-green-800">
                                            <span className="block text-green-600 dark:text-green-400 font-bold text-lg leading-none">{stu.present}</span>
                                            <span className="text-[10px] text-green-600 dark:text-green-400 font-bold">حضور</span>
                                        </div>
                                        <div className="text-center bg-red-50 dark:bg-red-900/20 px-4 py-2 rounded-2xl border border-red-100 dark:border-red-800">
                                            <span className="block text-red-400 dark:text-red-400 font-bold text-lg leading-none">{stu.absent}</span>
                                            <span className="text-[10px] text-red-400 dark:text-red-400 font-bold">غياب</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                                    {stu.sessions.map((s, idx) => (
                                        <div key={idx} className={`group text-center p-3 rounded-2xl cursor-pointer border-2 transition-all ${s.val==='حضور'?'bg-green-50 dark:bg-green-900/10 border-green-100 dark:border-green-900/30 text-green-700 dark:text-green-300 hover:bg-green-100':'bg-red-50 dark:bg-red-900/10 border-red-100 dark:border-red-900/30 text-red-500 dark:text-red-300 hover:bg-red-100'}`} onClick={()=>toggle(stu, s)}>
                                            <span className="block text-[10px] font-bold mb-1 opacity-60 uppercase">{s.name}</span>
                                            <span className="font-bold text-xs">{s.val}</span>
                                            <span className="block text-[9px] mt-2 opacity-0 group-hover:opacity-100 transition font-bold text-blue-500 uppercase">تعديل</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                        <button onClick={()=>window.print()} className="bg-gray-800 dark:bg-gray-700 text-white px-8 py-3 rounded-2xl font-bold w-full no-print mt-8 shadow-md">طباعة التقرير كاملاً</button>
                    </div>
                )}
            </div>
        );
    };

    const Footer = () => (
        <footer className="bg-white dark:bg-gray-800 text-center p-8 text-xs text-gray-400 dark:text-gray-500 mt-auto border-t border-gray-100 dark:border-gray-700 no-print transition-colors">
            <p className="font-bold mb-4 tracking-widest uppercase text-[10px]">تم التطوير بواسطة د. عبدالله صبري</p>
            <div className="flex justify-center gap-3">
                 <a href="https://wa.me/201113515751" target="_blank" className="flex items-center gap-2 bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-400 px-5 py-2.5 rounded-2xl font-bold hover:bg-green-200 dark:hover:bg-green-900/40 transition shadow-sm border border-green-200 dark:border-green-900/30">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" className="w-5 h-5" /> 
                    <span>واتساب</span>
                </a>
                <a href="https://t.me/Dr_Abdallah_Sabry" target="_blank" className="flex items-center gap-2 bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 px-5 py-2.5 rounded-2xl font-bold hover:bg-blue-200 dark:hover:bg-blue-900/40 transition shadow-sm border border-blue-200 dark:border-blue-900/30">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" className="w-5 h-5" /> 
                    <span>تليجرام</span>
                </a>
            </div>
            <p className="mt-8 opacity-50">&copy; {new Date().getFullYear()} Attendance System. All rights reserved.</p>
        </footer>
    );

    const App = () => {
        const [user, setUser] = useState(null);
        const [checked, setChecked] = useState(false);
        const { theme, toggleTheme } = useTheme();

        useEffect(() => {
            const stored = localStorage.getItem('sys_user');
            if (stored) setUser(JSON.parse(stored));
            setChecked(true);
        }, []);

        if(!checked) return <FullScreenLoader />;

        return (
            <div className="flex flex-col min-h-screen">
                <div className="flex-1 flex flex-col">
                    {!user ? <LoginScreen onLogin={setUser} theme={theme} toggleTheme={toggleTheme} /> : 
                     (user.role === 'admin' || user.role === 'moderator') ? <AdminDashboard user={user} onLogout={()=>setUser(null)} theme={theme} toggleTheme={toggleTheme} /> : 
                     <StudentDashboard user={user} onLogout={()=>setUser(null)} theme={theme} toggleTheme={toggleTheme} />}
                </div>
                <Footer />
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
