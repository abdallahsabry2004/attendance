<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>نظام الحضور</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Cairo', 'sans-serif'] },
          colors: {
            dark: {
              bg: '#0f172a',
              card: '#1e293b',
              input: '#334155'
            }
          }
        }
      }
    }
</script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .loader-sm { border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid #3b82f6; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .dark ::-webkit-scrollbar { width: 8px; height: 8px; }
    .dark ::-webkit-scrollbar-track { background: #1e293b; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background: white; color: black; }
      .dark body { background: white; color: black; }
      aside, nav, button, .mobile-header { display: none !important; }
      main { margin: 0 !important; width: 100% !important; padding: 0 !important; }
      .max-w-6xl { max-width: none !important; }
      .dark .bg-gray-50, .dark .bg-white, .dark .bg-gray-800 { background-color: white !important; color: black !important; }
      td, th { border: 1px solid #ddd !important; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    
    // --- إعدادات Supabase ---
    // لا تنسَ استبدال هذه القيم بمفاتيح مشروعك الحقيقية
    const SUPABASE_URL = "https://peuzohchnkpcesoatjdz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBldXpvaGNobmtwY2Vzb2F0amR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDM2MDYsImV4cCI6MjA4NzY3OTYwNn0.TFkjH9bRs5Rxa6gYvBlFpRXmAU28rri-RzeXH59gxQI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- دالة الاتصال الجديدة (runServer) المطابقة 100% لـ Code.gs ---
    const runServer = async (action, payload = {}) => {
      try {
        switch (action) {
          
          case 'login': {
            const { data, error } = await supabase.from('users_data').select('*').eq('national_id', payload.nationalId).maybeSingle(); 
            if (error || !data) return { status: 'error', message: 'الرقم القومي غير مسجل' };
            if (!payload.password) {
                if (!data.password || data.password.trim() === '') return { status: 'create_password', role: data.role, name: data.full_name };
                return { status: 'require_password', role: data.role, name: data.full_name };
            }
            if (data.password !== payload.password) return { status: 'error', message: 'كلمة المرور غير صحيحة' };
            return { status: 'success', role: data.role, name: data.full_name };
          }

          case 'registerPassword':
          case 'changePassword': {
            const { error } = await supabase.from('users_data').update({ password: payload.newPassword }).eq('national_id', payload.nationalId);
            if (error) return { status: 'error', message: 'حدث خطأ أثناء حفظ كلمة المرور' };
            if(action === 'registerPassword') {
               const { data } = await supabase.from('users_data').select('role, full_name').eq('national_id', payload.nationalId).single();
               return { status: 'success', message: 'تم الحفظ', role: data.role, name: data.full_name };
            }
            return { status: 'success', message: 'تم تحديث كلمة المرور بنجاح' };
          }

          case 'changeModeratorPassword': {
            const { error } = await supabase.from('users_data').update({ password: payload.newPassword }).eq('national_id', payload.nationalId).in('role', ['admin', 'moderator']);
            if (error) return { status: 'error', message: 'المدير غير موجود' };
            return { status: 'success', message: 'تم تحديث كلمة المرور بنجاح' };
          }

          // تسجيل الحضور - تمت مراجعة جميع شروط الحرمان والتكرار ودمج الجلسات
          case 'scanAttendance': {
            const { data: student } = await supabase.from('users_data').select('id, full_name').eq('national_id', payload.nationalId).single();
            if (!student) return { status: 'error', message: 'الطالب غير موجود' };

            const { data: sessionData } = await supabase.from('sessions').select('*, users_data!creator_id(full_name)').or(`qr_code.eq.${payload.qrData},pin_code.eq.${payload.qrData}`).maybeSingle();
            if (!sessionData) return { status: 'error', message: 'الرمز غير صحيح أو الجلسة غير موجودة' };
            if (!sessionData.is_active) return { status: 'error', message: 'تم إغلاق الجلسة' };

            const createdTime = new Date(sessionData.created_at);
            if (((new Date() - createdTime) / 1000 / 60) > sessionData.duration_minutes) {
                 await supabase.from('sessions').update({ is_active: false }).eq('id', sessionData.id);
                 return { status: 'error', message: 'انتهى الوقت المحدد للجلسة' };
            }

            const { data: enroll } = await supabase.from('course_enrollments').select('id').eq('course_id', sessionData.course_id).eq('student_id', student.id).maybeSingle();
            if (!enroll) return { status: 'error', message: 'غير مسجل في هذا المقرر' };

            // فحص الحرمان (4 غيابات في الجلسات التي تسبق هذه الجلسة)
            const { data: prevSessions } = await supabase.from('sessions').select('session_name').eq('course_id', sessionData.course_id).lt('created_at', sessionData.created_at);
            const uniquePrevSessionNames = [...new Set((prevSessions||[]).map(s=>s.session_name))];
            if (uniquePrevSessionNames.length > 0) {
                const { count: attendedPrev } = await supabase.from('attendance_logs').select('*', { count: 'exact', head: true }).eq('student_id', student.id).eq('course_id', sessionData.course_id).in('session_name', uniquePrevSessionNames);
                if ((uniquePrevSessionNames.length - (attendedPrev || 0)) >= 4) {
                     return { status: 'error', message: 'عذراً، لقد تم حرمانك من المقرر لتجاوز نسبة الغياب.' };
                }
            }

            // فحص التسجيل المسبق في نفس "العمود" (مع نفس المدير أو مدير آخر)
            const { data: existingLog } = await supabase.from('attendance_logs').select('scanned_by, users_data!scanned_by(full_name)').eq('course_id', sessionData.course_id).eq('session_name', sessionData.session_name).eq('student_id', student.id).maybeSingle();
            if (existingLog) {
                const creatorName = sessionData.users_data ? sessionData.users_data.full_name : 'غير معروف';
                const scannerName = existingLog.users_data ? existingLog.users_data.full_name : 'مدير آخر';
                if (existingLog.scanned_by === sessionData.creator_id) return { status: 'error', message: `تم تسجيل الحضور مسبقاً مع ${creatorName}` };
                else return { status: 'error', message: `مسجل حضور بالفعل مع ${scannerName}` };
            }

            // تسجيل الحضور
            await supabase.from('attendance_logs').insert({ course_id: sessionData.course_id, session_name: sessionData.session_name, student_id: student.id, scanned_by: sessionData.creator_id });
            return { status: 'success', message: 'تم تسجيل الحضور بنجاح' };
          }

          case 'getStudentData': {
            const { data, error } = await supabase.from('users_data').select('id, course_enrollments(courses(course_name))').eq('national_id', payload.nationalId).single();
            if (error || !data) return { status: 'error', message: 'خطأ في جلب المقررات' };
            const courses = data.course_enrollments.map(e => e.courses.course_name);
            return { status: 'success', courses: courses };
          }

          case 'getStudentHistory': {
            const { data: student } = await supabase.from('users_data').select('id').eq('national_id', payload.nationalId).single();
            const { data: course } = await supabase.from('courses').select('id').eq('university', payload.uni).eq('course_name', payload.course).single();
            if (!student || !course) return { status: 'error', message: 'بيانات غير موجودة' };

            const { data: allSessions } = await supabase.from('sessions').select('session_name, created_at').eq('course_id', course.id).order('created_at', { ascending: true });
            const orderedSessionNames = [...new Set((allSessions||[]).map(s=>s.session_name))]; // استخراج الأعمدة الفريدة

            const { data: attendance } = await supabase.from('attendance_logs').select('session_name, scanned_at, users_data!scanned_by(full_name)').eq('student_id', student.id).eq('course_id', course.id);
            
            let presentCount = 0; let absentCount = 0; let formattedSessions = [];
            orderedSessionNames.forEach(sName => {
                const record = (attendance || []).find(a => a.session_name === sName);
                const isPresent = !!record;
                if (isPresent) presentCount++; else absentCount++;
                
                let timeStr = "-";
                if(isPresent) {
                    const dateObj = new Date(record.scanned_at);
                    const scannerName = record.users_data ? record.users_data.full_name : '';
                    timeStr = `${dateObj.toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' })} - (مع ${scannerName})`;
                } else {
                    const sessionInfo = allSessions.find(s=>s.session_name === sName);
                    if(sessionInfo) timeStr = new Date(sessionInfo.created_at).toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' });
                }
                
                formattedSessions.push({ name: sName, status: isPresent ? 'حضور' : 'غياب', time: timeStr, color: isPresent ? 'green' : 'red' });
            });
            return { status: 'success', data: { sessions: formattedSessions, presentCount, absentCount } };
          }

          case 'getStudentWarnings': {
            const { data: student } = await supabase.from('users_data').select('id').eq('national_id', payload.nationalId).single();
            if(!student) return { status: 'success', warnings: [] };
            const { data: enrollments } = await supabase.from('course_enrollments').select('course_id, courses(course_name)').eq('student_id', student.id);
            if(!enrollments || enrollments.length === 0) return { status: 'success', warnings: [] };

            const courseIds = enrollments.map(e => e.course_id);
            const { data: allSessions } = await supabase.from('sessions').select('course_id, session_name').in('course_id', courseIds);
            const { data: allAttendance } = await supabase.from('attendance_logs').select('course_id, session_name').eq('student_id', student.id).in('course_id', courseIds);
            
            let warnings = [];
            enrollments.forEach(enroll => {
                const cSessions = (allSessions||[]).filter(s => s.course_id === enroll.course_id);
                const uniqueSessionNames = [...new Set(cSessions.map(s=>s.session_name))];
                let absentCount = 0;
                uniqueSessionNames.forEach(sName => {
                    const attended = (allAttendance||[]).some(a => a.course_id === enroll.course_id && a.session_name === sName);
                    if (!attended) absentCount++;
                });
                if (absentCount >= 3) warnings.push({ course: enroll.courses.course_name, absentCount, type: absentCount >= 4 ? 'deprived' : 'warning' });
            });
            return { status: 'success', warnings };
          }

          // أوامر الإدارة الشاملة (التعامل مع المقررات ودمج الجلسات)
          case 'adminAction': {
              const { type, role, name, uni, course, courseName } = payload;
              let adminUuid = null;
              if (name) {
                  const { data: uData } = await supabase.from('users_data').select('id').eq('full_name', name).limit(1).single();
                  if (uData) adminUuid = uData.id;
              }

              if (type === 'getAdminData') {
                  const { data: allCourses } = await supabase.from('courses').select('*');
                  let allowedCourses = allCourses || [];
                  if (role === 'moderator' && adminUuid) {
                      const { data: mySessions } = await supabase.from('sessions').select('course_id').eq('creator_id', adminUuid);
                      const myCourseIds = [...new Set((mySessions||[]).map(s => s.course_id))];
                      allowedCourses = allowedCourses.filter(c => myCourseIds.includes(c.id));
                  }
                  const tree = {};
                  allowedCourses.forEach(c => {
                      if (!tree[c.university]) tree[c.university] = [];
                      tree[c.university].push(c.course_name);
                  });
                  const { data: mods } = await supabase.from('users_data').select('national_id, full_name').eq('role', 'moderator');
                  const moderators = (mods || []).map(m => ({ name: m.full_name, id: m.national_id }));
                  
                  // جلب المقررات المقترحة (الفريدة من قاعدة البيانات)
                  const materials = [...new Set((allCourses || []).map(c => c.course_name))];
                  return { status: 'success', data: tree, materials, moderators };
              }

              if (type === 'getCourseModerators') {
                  const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                  if(!cData) return { status: 'success', courseModerators: [] };
                  const { data: sessions } = await supabase.from('sessions').select('users_data!creator_id(full_name)').eq('course_id', cData.id);
                  const mods = new Set();
                  (sessions||[]).forEach(s => { if(s.users_data && s.users_data.full_name !== 'المدير العام' && s.users_data.full_name !== 'admin') mods.add(s.users_data.full_name); });
                  return { status: 'success', courseModerators: Array.from(mods) };
              }
              if (type === 'addModerator') {
                  const { error } = await supabase.from('users_data').insert({ national_id: payload.id, full_name: name, password: payload.password, role: 'moderator' });
                  return error ? { status: 'error' } : { status: 'success' };
              }
              if (type === 'deleteModerator') {
                  const { error } = await supabase.from('users_data').delete().eq('national_id', payload.id).eq('role', 'moderator');
                  return error ? { status: 'error' } : { status: 'success' };
              }

              // إدارة المقررات 
              if (type === 'addCourse') {
                  const { error } = await supabase.from('courses').insert({ university: uni, course_name: courseName, created_by: adminUuid });
                  if (error) return { status: 'error', message: 'المقرر موجود بالفعل أو حدث خطأ' };
                  return { status: 'success' };
              }
              if (type === 'deleteCourse') {
                  if (role === 'admin') {
                      const { error } = await supabase.from('courses').delete().eq('university', uni).eq('course_name', courseName);
                      if (error) return { status: 'error', message: 'تعذر الحذف' };
                  } else {
                      const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', courseName).single();
                      if (cData && adminUuid) {
                          await supabase.from('sessions').delete().eq('course_id', cData.id).eq('creator_id', adminUuid);
                          const { count } = await supabase.from('sessions').select('*', {count: 'exact', head: true}).eq('course_id', cData.id);
                          if (count === 0) await supabase.from('courses').delete().eq('id', cData.id); // يحذف المقرر نهائياً لو كان هو المدير الوحيد
                      }
                  }
                  return { status: 'success' };
              }

              if (type === 'getCourseStudents') {
                  const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                  if (!cData) return { status: 'error' };
                  const { data: enrollments } = await supabase.from('course_enrollments').select('users_data(full_name, national_id, password)').eq('course_id', cData.id);
                  const students = (enrollments || []).map((e, i) => ({ name: e.users_data.full_name, id: e.users_data.national_id, pass: e.users_data.password, rowIndex: i }));
                  return { status: 'success', students };
              }
              
              if (type === 'manageStudent') {
                  const { actionType, studentData, bulkStudents } = payload;
                  const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                  if(!cData) return { status: 'error' };

                  // إضافة الطلاب دفعة واحدة من الإكسيل
                  if (actionType === 'bulkAdd' && bulkStudents) {
                      for(let stu of bulkStudents) {
                          let { data: uData } = await supabase.from('users_data').select('id').eq('national_id', stu.id).maybeSingle();
                          if (!uData) {
                              const { data: newUser } = await supabase.from('users_data').insert({ national_id: stu.id, full_name: stu.name, password: '', role: 'student' }).select('id').single();
                              uData = newUser;
                          }
                          if(uData) {
                              await supabase.from('course_enrollments').upsert({ course_id: cData.id, student_id: uData.id });
                          }
                      }
                      return { status: 'success', message: 'تم إضافة الدفعة بنجاح' };
                  }

                  if (actionType === 'add' || actionType === 'edit') {
                      let { data: uData } = await supabase.from('users_data').select('id').eq('national_id', studentData.id).maybeSingle();
                      if (!uData) {
                          const { data: newUser, error: insErr } = await supabase.from('users_data').insert({ national_id: studentData.id, full_name: studentData.name, password: studentData.pass || '', role: 'student' }).select('id').single();
                          if(insErr) return { status: 'error', message: 'خطأ في إضافة الطالب' };
                          uData = newUser;
                      } else if (actionType === 'edit') {
                          await supabase.from('users_data').update({ full_name: studentData.name, password: studentData.pass || '' }).eq('id', uData.id);
                      }
                      if (actionType === 'add') {
                          await supabase.from('course_enrollments').upsert({ course_id: cData.id, student_id: uData.id });
                      }
                      return { status: 'success' };
                  }
                  if (actionType === 'delete') {
                      const { data: uData } = await supabase.from('users_data').select('id').eq('national_id', studentData.id).single();
                      if(uData) await supabase.from('course_enrollments').delete().eq('course_id', cData.id).eq('student_id', uData.id);
                      return { status: 'success' };
                  }
              }

              if (type === 'getCourseWarnings') {
                  const { warningType } = payload;
                  const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                  if(!cData) return { status: 'error' };

                  const { data: enrollments } = await supabase.from('course_enrollments').select('users_data(full_name, national_id, id)').eq('course_id', cData.id);
                  const { data: allSessions } = await supabase.from('sessions').select('session_name').eq('course_id', cData.id);
                  const uniqueSessionNames = [...new Set((allSessions||[]).map(s=>s.session_name))];
                  const { data: attendance } = await supabase.from('attendance_logs').select('student_id, session_name').eq('course_id', cData.id);

                  let warnings = [];
                  (enrollments||[]).forEach(e => {
                      const stu = e.users_data;
                      let absentCount = 0;
                      uniqueSessionNames.forEach(sName => {
                          const attended = (attendance||[]).some(a => a.student_id === stu.id && a.session_name === sName);
                          if (!attended) absentCount++;
                      });
                      if (warningType === 'warning' && absentCount === 3) warnings.push({ name: stu.full_name, id: stu.national_id, absentCount });
                      else if (warningType === 'deprived' && absentCount >= 4) warnings.push({ name: stu.full_name, id: stu.national_id, absentCount });
                  });
                  return { status: 'success', warnings };
              }

              if (type === 'getLastSession') {
                  const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                  if(!cData) return { status: 'success', lastSession: 'لا يوجد' };
                  
                  let query = supabase.from('sessions').select('session_name').eq('course_id', cData.id);
                  if (role === 'moderator' && adminUuid) query = query.eq('creator_id', adminUuid); 
                  const { data: mySessions } = await query;
                  const count = new Set((mySessions||[]).map(s=>s.session_name)).size;
                  
                  return { status: 'success', lastSession: count > 0 ? "الجلسة " + count : 'لا يوجد' };
              }

              if (type === 'createSession' || type === 'changeQR') {
                  const { duration, sessionNameOverride } = payload;
                  const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                  if(!cData) return { status: 'error', message: 'المقرر غير موجود' };

                  const pinCode = Math.floor(100000 + Math.random() * 900000).toString();
                  let targetSessionName = sessionNameOverride;

                  if (type === 'createSession') {
                      let query = supabase.from('sessions').select('session_name').eq('course_id', cData.id);
                      if (role === 'moderator' && adminUuid) query = query.eq('creator_id', adminUuid);
                      const { data: mySessions } = await query;
                      const count = new Set((mySessions||[]).map(s=>s.session_name)).size;
                      
                      targetSessionName = "الجلسة " + (count + 1);
                      const qrData = `${uni}|separator|${course}|separator|${targetSessionName}|separator|${pinCode}`;
                      const { error } = await supabase.from('sessions').insert({ course_id: cData.id, session_name: targetSessionName, qr_code: qrData, pin_code: pinCode, duration_minutes: duration, creator_id: adminUuid });
                      if (error) return { status: 'error', message: 'حدث خطأ في إنشاء الجلسة' };
                      return { status: 'success', qrData, sessionName: targetSessionName, pinCode };
                  } 
                  
                  if (type === 'changeQR') {
                      const qrData = `${uni}|separator|${course}|separator|${targetSessionName}|separator|${pinCode}`;
                      let updQuery = supabase.from('sessions').update({ duration_minutes: duration, qr_code: qrData, pin_code: pinCode, is_active: true, created_at: new Date().toISOString() }).eq('course_id', cData.id).eq('session_name', targetSessionName);
                      if(role === 'moderator' && adminUuid) updQuery = updQuery.eq('creator_id', adminUuid);
                      const { error } = await updQuery;
                      if (error) return { status: 'error', message: 'حدث خطأ في تحديث الجلسة' };
                      return { status: 'success', qrData, sessionName: targetSessionName, pinCode };
                  }
              }

              if (type === 'getSessionDetails') {
                  const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                  if(!cData) return { status: 'error' };

                  let query = supabase.from('sessions').select('id, session_name, is_active, qr_code, created_at, creator_id, users_data!creator_id(full_name)').eq('course_id', cData.id);
                  if (role === 'moderator' && adminUuid) query = query.eq('creator_id', adminUuid);
                  const { data: sessions } = await query;
                  
                  const { count: totalStudents } = await supabase.from('course_enrollments').select('*', {count: 'exact', head: true}).eq('course_id', cData.id);
                  
                  let sessionStats = [];
                  for(const s of (sessions || [])) {
                      const { count: present } = await supabase.from('attendance_logs').select('*', {count: 'exact', head: true}).eq('course_id', cData.id).eq('session_name', s.session_name).eq('scanned_by', s.creator_id);
                      
                      const createdTime = new Date(s.created_at);
                      let currentStatus = s.is_active ? 'يعمل' : 'لا يعمل';
                      if(s.is_active && ((new Date() - createdTime) / 1000 / 60) > s.duration_minutes) currentStatus = 'لا يعمل';

                      sessionStats.push({ session: s.session_name, present: present || 0, absent: totalStudents - (present || 0), qrStatus: currentStatus, qrCode: s.qr_code, creationDate: createdTime.toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' }), creator: s.users_data ? s.users_data.full_name : 'غير معروف' });
                  }
                  sessionStats.sort((a, b) => a.session.localeCompare(b.session, 'ar', { numeric: true }));
                  return { status: 'success', sessions: sessionStats };
              }

              if (type === 'toggleQR') {
                  await supabase.from('sessions').update({ is_active: payload.newStatus === 'يعمل' }).eq('qr_code', payload.qrCode);
                  return { status: 'success' };
              }

              if (type === 'deleteSession') {
                  const { sessionName } = payload;
                  const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                  if(cData) {
                      if (role === 'admin') {
                          await supabase.from('sessions').delete().eq('course_id', cData.id).eq('session_name', sessionName);
                          await supabase.from('attendance_logs').delete().eq('course_id', cData.id).eq('session_name', sessionName);
                      } else {
                          // المساعد يمسح حضوره وجلسته فقط
                          await supabase.from('sessions').delete().eq('course_id', cData.id).eq('session_name', sessionName).eq('creator_id', adminUuid);
                          await supabase.from('attendance_logs').delete().eq('course_id', cData.id).eq('session_name', sessionName).eq('scanned_by', adminUuid);
                      }
                  }
                  return { status: 'success' };
              }
              return { status: 'error', message: 'غير مدعوم' };
          }

          // التقارير الشاملة مبنية على نظام دمج الأعمدة (session_name)
          case 'getCourseReport': {
            const { uni, course } = payload;
            const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
            if (!cData) return { status: 'error', message: 'المقرر غير موجود' };

            const { data: allSessions } = await supabase.from('sessions').select('session_name, created_at').eq('course_id', cData.id).order('created_at', { ascending: true });
            const orderedSessionNames = [...new Set((allSessions||[]).map(s=>s.session_name))];

            const { data: enrollments } = await supabase.from('course_enrollments').select('users_data(id, full_name, national_id)').eq('course_id', cData.id);
            const { data: attendance } = await supabase.from('attendance_logs').select('student_id, session_name, scanned_at, users_data!scanned_by(full_name)').eq('course_id', cData.id);

            const headers = ["اسم الطالب", "حضور", "غياب", "الرقم القومي", ...orderedSessionNames];
            const rows = (enrollments || []).map(e => {
                const stu = e.users_data;
                let present = 0; let absent = 0;
                const sessionStatuses = orderedSessionNames.map(sName => {
                    const rec = (attendance||[]).find(a => a.student_id === stu.id && a.session_name === sName);
                    if (rec) { 
                        present++; 
                        const scannerName = rec.users_data ? rec.users_data.full_name : '';
                        return `${new Date(rec.scanned_at).toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' })} - (مع ${scannerName})`; 
                    }
                    else { absent++; return ""; }
                });
                return [stu.full_name, present, absent, stu.national_id, ...sessionStatuses];
            }).sort((a,b) => String(a[0]).localeCompare(String(b[0]), 'ar'));

            return { status: 'success', headers, rows, count: rows.length };
          }

          case 'getIsolatedCourseReport': {
            const { uni, course, targetModerator } = payload;
            const { data: modData } = await supabase.from('users_data').select('id').eq('full_name', targetModerator).limit(1).single();
            const modId = modData ? modData.id : null;

            const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
            if (!cData) return { status: 'error' };

            const { data: allSessions } = await supabase.from('sessions').select('session_name, created_at').eq('course_id', cData.id).order('created_at', { ascending: true });
            const { data: enrollments } = await supabase.from('course_enrollments').select('users_data(id, full_name, national_id)').eq('course_id', cData.id);
            
            let attQuery = supabase.from('attendance_logs').select('student_id, session_name, scanned_at, users_data!scanned_by(full_name)').eq('course_id', cData.id);
            if (modId) attQuery = attQuery.eq('scanned_by', modId);
            const { data: attendance } = await attQuery;

            const sessionIdsWithModAtt = [...new Set((attendance||[]).map(a=>a.session_name))];
            const filteredSessionNames = [...new Set((allSessions||[]).map(s=>s.session_name))].filter(name => sessionIdsWithModAtt.includes(name));
            
            const headers = ["اسم الطالب", "حضور", "غياب", "الرقم القومي", ...filteredSessionNames];
            const rows = (enrollments || []).map(e => {
                const stu = e.users_data;
                let present = 0; let absent = 0;
                const sessionStatuses = filteredSessionNames.map(sName => {
                    const rec = (attendance||[]).find(a => a.student_id === stu.id && a.session_name === sName);
                    if (rec) { 
                        present++; 
                        const scannerName = rec.users_data ? rec.users_data.full_name : '';
                        return `${new Date(rec.scanned_at).toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' })} - (مع ${scannerName})`; 
                    }
                    else { absent++; return ""; }
                });
                return [stu.full_name, present, absent, stu.national_id, ...sessionStatuses];
            }).sort((a,b) => String(a[0]).localeCompare(String(b[0]), 'ar'));

            return { status: 'success', headers, rows, count: rows.length };
          }

          case 'getSessionReport': {
            const { uni, course, session } = payload;
            const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
            if(!cData) return { status: 'error' };

            const { data: enrollments } = await supabase.from('course_enrollments').select('users_data(id, full_name, national_id)').eq('course_id', cData.id);
            const { data: attendance } = await supabase.from('attendance_logs').select('student_id, scanned_at, users_data!scanned_by(full_name)').eq('course_id', cData.id).eq('session_name', session);

            const report = (enrollments || []).map(e => {
                const stu = e.users_data;
                const rec = (attendance||[]).find(a => a.student_id === stu.id);
                const isPresent = !!rec;
                let timeStr = '-';
                if (isPresent) {
                    const scannerName = rec.users_data ? rec.users_data.full_name : 'غير معروف';
                    timeStr = `${new Date(rec.scanned_at).toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' })} - (مع ${scannerName})`;
                }
                return { name: stu.full_name, id: stu.national_id, status: isPresent ? 'حضور' : 'غياب', time: timeStr, color: isPresent ? 'green' : 'red', rowIndex: stu.id, rawVal: isPresent ? 'present' : '' };
            }).sort((a,b) => a.name.localeCompare(b.name, 'ar'));

            return { status: 'success', report };
          }

          case 'getStudentSearchReport': {
            const { uni, course, query } = payload;
            const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
            if(!cData) return { status: 'error' };

            const { data: enrollments } = await supabase.from('course_enrollments').select('users_data!inner(id, full_name, national_id)').eq('course_id', cData.id).or(`full_name.ilike.%${query}%,national_id.ilike.%${query}%`, { foreignTable: 'users_data' });
            
            const { data: allSessions } = await supabase.from('sessions').select('session_name').eq('course_id', cData.id).order('created_at', { ascending: true });
            const orderedSessionNames = [...new Set((allSessions||[]).map(s=>s.session_name))];

            const studentIds = (enrollments||[]).map(e => e.users_data.id);
            const { data: attendance } = await supabase.from('attendance_logs').select('student_id, session_name').eq('course_id', cData.id).in('student_id', studentIds);

            const results = (enrollments || []).map(e => {
                const stu = e.users_data;
                let present = 0; let absent = 0;
                const stuSessions = orderedSessionNames.map(sName => {
                    const isPresent = (attendance||[]).some(a => a.student_id === stu.id && a.session_name === sName);
                    if(isPresent) present++; else absent++;
                    return { name: sName, val: isPresent ? 'حضور' : 'غياب' };
                });
                return { name: stu.full_name, id: stu.national_id, present, absent, sessions: stuSessions, rowIndex: stu.id };
            });
            return { status: 'success', results, sessionHeaders: orderedSessionNames };
          }

          case 'updateAttendanceCell': {
             const { uni, course, rowIndex: studentId, status, sessionName, editorName } = payload;
             const { data: cData } = await supabase.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
             if(!cData) return { status: 'error' };

             let editorId = null;
             if(editorName) {
                 const { data: edData } = await supabase.from('users_data').select('id').eq('full_name', editorName).limit(1).single();
                 if(edData) editorId = edData.id;
             }

             if (status === 'present') {
                 await supabase.from('attendance_logs').insert({ course_id: cData.id, session_name: sessionName, student_id: studentId, scanned_by: editorId || studentId });
                 return { status: 'success', newValue: `${new Date().toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' })} - (مع ${editorName} - تعديل يدوي)` };
             } else {
                 await supabase.from('attendance_logs').delete().eq('course_id', cData.id).eq('session_name', sessionName).eq('student_id', studentId);
                 return { status: 'success', newValue: '' };
             }
          }

          default:
            return { status: 'error', message: 'الإجراء غير مدعوم' };
        }
      } catch (err) {
        console.error('Supabase Error:', err);
        return { status: 'error', message: 'تعذر الاتصال بالخادم السحابي.' };
      }
    };

    // --- مكون إدارة الطلاب المُحدث ليشمل رفع الإكسيل ---
    const AdminManageStudents = ({ uniData, showToast, confirm }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [students, setStudents] = useState([]);
        const [loading, setLoading] = useState(false);
        const [showModal, setShowModal] = useState(false);
        const [showBulkModal, setShowBulkModal] = useState(false); // إضافة نافذة الرفع الجماعي
        const [bulkText, setBulkText] = useState(''); // نص الإكسيل المنسوخ
        const [editMode, setEditMode] = useState(false);
        const [studentForm, setStudentForm] = useState({ name: '', id: '', rowIndex: null });

        const load = useCallback(() => {
            if (course) {
                setLoading(true);
                runServer('adminAction', { type: 'getCourseStudents', uni, course }).then(res => {
                    setLoading(false);
                    if (res.status === 'success') {
                        const sorted = res.students.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                        setStudents(sorted);
                    }
                });
            } else { setStudents([]); }
        }, [uni, course]);

        useEffect(load, [course, load]);

        const handleSubmit = async () => {
            if (!studentForm.name || !studentForm.id) return;
            setLoading(true);
            const res = await runServer('adminAction', { type: 'manageStudent', uni, course, actionType: editMode ? 'edit' : 'add', studentData: studentForm });
            setLoading(false);
            if (res.status === 'success') {
                showToast({ type: 'success', message: editMode ? 'تم التعديل' : 'تمت الإضافة بنجاح' });
                setShowModal(false); load();
            }
        };

        const handleBulkSubmit = async () => {
            if(!bulkText.trim()) return;
            setLoading(true);
            // فصل السطور ومعالجتها (يقبل النسخ من إكسيل حيث يفصل بين الاسم والرقم بـ Tab أو فاصلة)
            const lines = bulkText.split('\n');
            const bulkStudents = lines.map(l => {
                const parts = l.split(/\t|,|-/);
                if(parts.length >= 2) return { name: parts[0].trim(), id: parts[1].trim() };
                return null;
            }).filter(Boolean);

            if(bulkStudents.length === 0) {
                setLoading(false);
                showToast({type: 'error', message: 'لم يتم التعرف على الصيغة. انسخ (الاسم) وبجانبه (الرقم القومي)'});
                return;
            }

            const res = await runServer('adminAction', { type: 'manageStudent', uni, course, actionType: 'bulkAdd', bulkStudents });
            setLoading(false);
            if (res.status === 'success') {
                showToast({ type: 'success', message: `تمت إضافة ${bulkStudents.length} طالب بنجاح` });
                setShowBulkModal(false); setBulkText(''); load();
            }
        };

        const handleDelete = async (stu) => {
            const ok = await confirm({ title: 'تأكيد الحذف', message: `حذف الطالب ${stu.name} من المقرر نهائياً؟` });
            if (ok) {
                const res = await runServer('adminAction', { type: 'manageStudent', uni, course, actionType: 'delete', studentData: stu });
                if (res.status === 'success') { showToast({ type: 'success', message: 'تم الحذف' }); load(); }
            }
        };

        const getGender = (id) => {
            if (!id || String(id).length !== 14) return 'غير محدد';
            const digit = parseInt(String(id).charAt(12));
            return digit % 2 === 0 ? 'أنثى' : 'ذكر';
        };

        const stats = { total: students.length, male: students.filter(s=>getGender(s.id)==='ذكر').length, female: students.filter(s=>getGender(s.id)==='أنثى').length };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in w-full">
                <div className="flex flex-wrap gap-4 mb-6 no-print items-center border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e => { setUni(e.target.value); setCourse(''); }}>
                        <option value="حكومي">حكومي</option><option value="أهلية">أهلية</option>
                    </select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e => setCourse(e.target.value)}>
                            <option value="">اختر المقرر...</option>
                            {(uniData[uni] || []).map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    {course && (
                        <div className="flex flex-wrap gap-2">
                            <Button onClick={() => { setEditMode(false); setStudentForm({ name: '', id: '' }); setShowModal(true); }} className="bg-green-600 text-white px-4 rounded-2xl font-bold">إضافة طالب</Button>
                            <Button onClick={() => setShowBulkModal(true)} className="bg-indigo-600 text-white px-4 rounded-2xl font-bold">إضافة من الإكسيل</Button>
                            <button onClick={() => window.print()} className="bg-gray-800 text-white px-4 rounded-2xl font-bold">طباعة</button>
                        </div>
                    )}
                </div>

                {course && (
                    <div className="fade-in">
                        <div className="print-only text-center mb-6">
                            <h2 className="text-xl font-bold">كشف أسماء الطلاب</h2>
                            <p className="text-gray-600">{course} - {uni}</p>
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-6 text-center no-print">
                            <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800"><span className="block text-2xl font-bold text-blue-600 dark:text-blue-400">{stats.total}</span><span className="text-xs text-blue-500">إجمالي الطلاب</span></div>
                            <div className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800"><span className="block text-2xl font-bold text-indigo-600 dark:text-indigo-400">{stats.male}</span><span className="text-xs text-indigo-500">ذكور</span></div>
                            <div className="bg-pink-50 dark:bg-pink-900/20 p-4 rounded-xl border border-pink-100 dark:border-pink-800"><span className="block text-2xl font-bold text-pink-600 dark:text-pink-400">{stats.female}</span><span className="text-xs text-pink-500">إناث</span></div>
                        </div>

                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-center border-collapse">
                                <thead>
                                    <tr className="bg-gray-50 dark:bg-gray-700/50 text-gray-400 font-bold uppercase tracking-wider text-[10px]">
                                        <th className="p-3 border-b dark:border-gray-600">م</th>
                                        <th className="p-3 border-b dark:border-gray-600 text-right">اسم الطالب</th>
                                        <th className="p-3 border-b dark:border-gray-600">النوع</th>
                                        <th className="p-3 border-b dark:border-gray-600">الرقم القومي</th>
                                        <th className="p-3 border-b dark:border-gray-600 no-print">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {students.map((stu, i) => (
                                        <tr key={i} className="hover:bg-gray-50/50 dark:hover:bg-gray-700/30 transition">
                                            <td className="p-3 border-b dark:border-gray-600 text-gray-400">{i + 1}</td>
                                            <td className="p-3 border-b dark:border-gray-600 font-bold text-gray-700 dark:text-gray-200 text-right">{stu.name}</td>
                                            <td className="p-3 border-b dark:border-gray-600 text-xs font-bold text-gray-500 dark:text-gray-400">{getGender(stu.id)}</td>
                                            <td className="p-3 border-b dark:border-gray-600 text-gray-500 font-mono tracking-widest">{stu.id}</td>
                                            <td className="p-3 border-b dark:border-gray-600 no-print">
                                                <div className="flex justify-center gap-2">
                                                    <button onClick={() => { setEditMode(true); setStudentForm(stu); setShowModal(true); }} className="text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30 p-2 rounded-lg transition"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                                                    <button onClick={() => handleDelete(stu)} className="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-2 rounded-lg transition"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                    {students.length === 0 && <tr><td colSpan="5" className="p-6 text-gray-400">لا يوجد طلاب مسجلين</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                <Modal isOpen={showModal} onClose={() => setShowModal(false)} title={editMode ? "تعديل بيانات الطالب" : "إضافة طالب فردي"}>
                    <input type="text" placeholder="اسم الطالب (رباعي)" value={studentForm.name} onChange={e => setStudentForm({ ...studentForm, name: e.target.value })} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-400" />
                    <input type="number" placeholder="الرقم القومي (14 رقم)" value={studentForm.id} onChange={e => setStudentForm({ ...studentForm, id: e.target.value })} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-400" />
                    <Button loading={loading} onClick={handleSubmit} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">{editMode ? 'حفظ التعديلات' : 'إضافة للقائمة'}</Button>
                </Modal>

                <Modal isOpen={showBulkModal} onClose={() => setShowBulkModal(false)} title="إضافة طلاب دفعة واحدة من الإكسيل">
                    <p className="text-sm text-gray-500 mb-2">انسخ عمود (الاسم) وعمود (الرقم القومي) من ملف الإكسيل والصقهما هنا معاً:</p>
                    <textarea value={bulkText} onChange={e => setBulkText(e.target.value)} placeholder="مثال:&#10;أحمد محمد علي    299102...&#10;سارة محمود حسن    300123..." className="w-full h-48 p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-400 whitespace-pre" />
                    <Button loading={loading} onClick={handleBulkSubmit} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">بدء التسجيل الجماعي</Button>
                </Modal>
            </div>
        );
    };

    const AdminWarningsReport = ({ uniData }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [wType, setWType] = useState('warning');
        const [warnings, setWarnings] = useState([]);
        const [loading, setLoading] = useState(false);
        const [searched, setSearched] = useState(false);

        const load = () => {
            if (!course) return;
            setLoading(true);
            runServer('adminAction', { type: 'getCourseWarnings', uni, course, warningType: wType }).then(res => {
                setLoading(false);
                setSearched(true);
                if (res.status === 'success') setWarnings(res.warnings);
            });
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in w-full">
                <div className="flex flex-wrap gap-4 mb-6 no-print items-center border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e => { setUni(e.target.value); setCourse(''); setSearched(false); }}>
                        <option value="حكومي">حكومي</option><option value="أهلية">أهلية</option>
                    </select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e => {setCourse(e.target.value); setSearched(false);}}>
                            <option value="">اختر المقرر...</option>
                            {(uniData[uni] || []).map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={wType} onChange={e => {setWType(e.target.value); setSearched(false);}}>
                        <option value="warning">إنذار غياب (3 غيابات)</option>
                        <option value="deprived">حرمان (4 غيابات أو أكثر)</option>
                    </select>
                    <Button loading={loading} onClick={load} className="bg-blue-600 text-white px-8 rounded-2xl font-bold">بحث</Button>
                    <button onClick={() => window.print()} className="bg-gray-800 text-white px-6 rounded-2xl font-bold">طباعة</button>
                </div>

                {searched && (
                    <div className="fade-in">
                        <div className="mb-4 text-center print-only">
                            <h2 className="text-xl font-bold">{wType === 'warning' ? 'كشف إنذارات الغياب' : 'كشف المحرومين من المقرر'}</h2>
                            <p className="text-gray-500">{course} - {uni}</p>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-center border-collapse">
                                <thead>
                                    <tr className={`font-bold uppercase tracking-wider text-[10px] text-white ${wType === 'warning' ? 'bg-yellow-500' : 'bg-red-600'}`}>
                                        <th className="p-3 border-b border-white/20">م</th>
                                        <th className="p-3 border-b border-white/20 text-right">اسم الطالب</th>
                                        <th className="p-3 border-b border-white/20">الرقم القومي</th>
                                        <th className="p-3 border-b border-white/20">إجمالي الغياب</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {warnings.map((w, i) => (
                                        <tr key={i} className={`transition ${wType === 'warning' ? 'hover:bg-yellow-50 dark:hover:bg-yellow-900/10' : 'hover:bg-red-50 dark:hover:bg-red-900/10'}`}>
                                            <td className="p-3 border-b dark:border-gray-700 text-gray-400">{i + 1}</td>
                                            <td className="p-3 border-b dark:border-gray-700 font-bold text-gray-700 dark:text-gray-200 text-right">{w.name}</td>
                                            <td className="p-3 border-b dark:border-gray-700 text-gray-500">{w.id}</td>
                                            <td className="p-3 border-b dark:border-gray-700 font-bold text-lg">{w.absentCount}</td>
                                        </tr>
                                    ))}
                                    {warnings.length === 0 && <tr><td colSpan="4" className="p-6 text-gray-400">لا يوجد بيانات لهذه الحالة</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const AdminManageModerators = ({ moderators, refresh, showToast, confirm }) => {
        const [name, setName] = useState('');
        const [id, setId] = useState('');
        const [password, setPassword] = useState('');
        const [loadingAdd, setLoadingAdd] = useState(false);

        const handleAdd = async () => {
             if(!name || !id || !password) return;
             setLoadingAdd(true);
             const res = await runServer('adminAction', { type: 'addModerator', name, id, password });
             setLoadingAdd(false);
             if(res.status === 'success') { showToast({type:'success', message:'تم إضافة المدير بنجاح'}); setName(''); setId(''); setPassword(''); refresh(); }
        };

        const handleDelete = async (m) => {
             if(await confirm({title:'تأكيد الحذف',message:`حذف المدير ${m.name}؟`})){
                 runServer('adminAction',{type:'deleteModerator',id:m.id}).then(()=>refresh())
             }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-4xl mx-auto fade-in">
                 <h2 className="text-2xl font-bold mb-8 text-gray-800 dark:text-gray-100">إدارة المديرين والمساعدين</h2>
                 <div className="flex flex-col sm:flex-row gap-3 mb-8">
                     <input type="text" className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 outline-none focus:border-blue-400" placeholder="الاسم (مثال: د. أحمد)" value={name} onChange={e=>setName(e.target.value)} />
                     <input type="number" className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 outline-none focus:border-blue-400" placeholder="الرقم القومي" value={id} onChange={e=>setId(e.target.value)} />
                     <input type="text" className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 outline-none focus:border-blue-400" placeholder="كلمة المرور الافتراضية" value={password} onChange={e=>setPassword(e.target.value)} />
                     <Button loading={loadingAdd} onClick={handleAdd} className="bg-green-600 text-white px-8 rounded-2xl font-bold">إنشاء مدير</Button>
                 </div>
                 <div className="overflow-x-auto">
                    <table className="w-full text-sm text-center">
                        <thead className="text-gray-400 dark:text-gray-500 font-bold border-b dark:border-gray-700 pb-4">
                            <tr><th className="pb-4">اسم المدير</th><th className="pb-4">الرقم القومي</th><th className="pb-4">إجراءات</th></tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50 dark:divide-gray-700">
                            {moderators.length === 0 && <tr><td colSpan="3" className="py-10 text-gray-400">لا يوجد مديرين مسجلين</td></tr>}
                            {moderators.map(m => (
                                <tr key={m.id} className="hover:bg-gray-50/50 dark:hover:bg-gray-700/30 transition">
                                    <td className="py-4 font-bold text-gray-700 dark:text-gray-200">{m.name}</td>
                                    <td className="py-4 text-gray-400 dark:text-gray-500">{m.id}</td>
                                    <td className="py-4">
                                        <button onClick={()=>handleDelete(m)} className="text-red-400 hover:text-red-600 font-bold">حذف نهائي</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                 </div>
            </div>
        );
    };

    const AdminManageSessions = ({ uniData, showToast, confirm, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [sessions, setSessions] = useState([]);
        const [loading, setLoading] = useState(false);
        const [manageQR, setManageQR] = useState(null);
        
        const load = useCallback(() => {
             if(course) {
                 setLoading(true);
                 runServer('adminAction', { type: 'getSessionDetails', uni, course, role: user.role, name: user.name }).then(res => { 
                     setLoading(false);
                     if(res.status==='success') setSessions(res.sessions); 
                 });
             }
        }, [uni, course, user.role, user.name]);

        useEffect(load, [course, load]);
        
        const handleDelete = async (s) => {
            const msg = user.role === 'admin' 
                ? `هل أنت متأكد من حذف ${s.session} نهائياً للجميع؟`
                : `هل أنت متأكد من حذف ${s.session} الخاصة بك فقط؟ (لن يتم مسح حضور المديرين الآخرين في نفس الجلسة)`;

            const ok = await confirm({ title:'حذف جلسة', message: msg, confirmText:'نعم، حذف' });
            if(ok) {
                 await runServer('adminAction', { type: 'deleteSession', uni, course, sessionName: s.session, role: user.role, name: user.name });
                 showToast({ type:'success', message: 'تم الحذف بنجاح' });
                 load();
            }
        };

        const handleStopSession = async (s) => {
             const ok = await confirm({ title:'إيقاف الجلسة', message: 'هل تريد إيقاف عمل الرمز يدوياً؟', confirmText:'إيقاف' });
             if(ok) {
                await runServer('adminAction', { type: 'toggleQR', qrCode: s.qrCode, newStatus: 'لا يعمل' });
                showToast({ type:'info', message: 'تم إيقاف الجلسة' });
                setManageQR(null);
                load();
             }
        };

        const handleChangeTime = async (s) => {
            const newTime = prompt("أدخل الوقت الجديد بالدقائق:", "30");
            if(!newTime) return;
            await runServer('adminAction', { type: 'changeQR', uni, course, duration: newTime, sessionNameOverride: s.session, creatorName: user.name });
            if(res.status === 'success') {
                showToast({ type: 'success', message: 'تم تحديث وقت الجلسة' });
                setManageQR(null);
                load();
            }
        };

        const handleCreateNewQR = async (s) => {
            const newTime = prompt("أدخل وقت الرمز الجديد بالدقائق:", "30");
            if(!newTime) return;
            const res = await runServer('adminAction', { type: 'changeQR', uni, course, duration: newTime, sessionNameOverride: s.session, creatorName: user.name });
            if(res.status === 'success') {
                showToast({ type: 'success', message: 'تم تفعيل رمز جديد' });
                setManageQR(null);
                load();
            }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in w-full">
                <div className="flex flex-col md:flex-row gap-4 mb-8 items-center border-b dark:border-gray-700 pb-6 w-full">
                     <select className="w-full md:w-auto border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}>
                         <option value="حكومي">حكومي</option>
                         <option value="أهلية">أهلية</option>
                     </select>
                     <select className="w-full md:w-auto border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 min-w-0 truncate outline-none" value={course} onChange={e=>setCourse(e.target.value)}>
                        <option value="">اختر المقرر...</option>
                        {(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}
                    </select>
                    {loading && <div className="loader-sm"></div>}
                </div>
                
                <div className="overflow-x-auto w-full">
                    <table className="w-full text-sm text-center">
                        <thead className="text-gray-400 dark:text-gray-500 font-bold">
                            <tr>
                                <th className="pb-4 min-w-[100px]">الجلسة</th>
                                {user.role === 'admin' && <th className="pb-4 min-w-[100px]">المنشئ</th>}
                                <th className="pb-4 min-w-[120px]">الإنشاء</th>
                                <th className="pb-4">الحضور</th>
                                <th className="pb-4 min-w-[100px]">الحالة</th>
                                <th className="pb-4 min-w-[150px]">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50 dark:divide-gray-700">
                            {sessions.length === 0 && <tr><td colSpan={user.role === 'admin' ? 6 : 5} className="py-10 text-gray-400">لا يوجد بيانات</td></tr>}
                            {sessions.map((s, idx) => (
                                <tr key={idx} className="hover:bg-gray-50/50 dark:hover:bg-gray-700/30 transition">
                                    <td className="py-4 font-bold text-gray-700 dark:text-gray-200">{s.session}</td>
                                    {user.role === 'admin' && <td className="py-4 text-xs font-bold text-blue-500">{s.creator}</td>}
                                    <td className="py-4 text-xs text-gray-400 dark:text-gray-500">{s.creationDate}</td>
                                    <td className="py-4">
                                        <span className="text-green-600 dark:text-green-400 font-bold bg-green-50 dark:bg-green-900/20 px-3 py-1 rounded-lg">{s.present}</span>
                                    </td>
                                    <td className="py-4">
                                        <span className={`px-3 py-1 rounded-lg text-[10px] font-bold ${s.qrStatus === 'يعمل' ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'}`}>
                                            {s.qrStatus}
                                        </span>
                                    </td>
                                    <td className="py-4 flex justify-center gap-2">
                                         <button onClick={()=>setManageQR(s)} className="text-blue-600 dark:text-blue-400 font-bold text-xs bg-blue-50 dark:bg-blue-900/20 px-4 py-2 rounded-xl transition hover:bg-blue-100 dark:hover:bg-blue-900/40 shadow-sm border border-blue-100 dark:border-blue-900/30">إدارة QR</button>
                                         <button onClick={()=>handleDelete(s)} className="text-red-400 hover:text-red-600 p-2 transition">
                                             <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                         </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>

                <Modal isOpen={!!manageQR} onClose={()=>setManageQR(null)} title={`إدارة QR - ${manageQR?.session}`}>
                    {manageQR && (
                        <div className="text-center p-4 fade-in">
                            <div className="mb-6">
                                <span className={`px-4 py-1.5 rounded-full text-xs font-bold ${manageQR.qrStatus === 'يعمل' ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300' : 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300'}`}>
                                    الحالة: {manageQR.qrStatus === 'يعمل' ? 'نشط (متاح للتسجيل)' : 'غير نشط (مغلق)'}
                                </span>
                            </div>

                            {manageQR.qrStatus === 'يعمل' ? (
                                <>
                                    <div className="flex justify-center mb-4">
                                         <div className="bg-white p-4 rounded-3xl shadow-sm border border-gray-100">
                                            <img src={`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(manageQR.qrCode)}`} className="w-56 h-56" />
                                         </div>
                                    </div>
                                    
                                    <div className="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-xl inline-block mb-6 border border-gray-200 dark:border-gray-600 w-full max-w-[250px]">
                                        <p className="text-[10px] text-gray-500 dark:text-gray-400 mb-1 font-bold">الرقم السري للطلاب (للإدخال اليدوي):</p>
                                        <p className="text-2xl font-bold tracking-[0.2em] text-gray-800 dark:text-gray-100">{manageQR.qrCode.split('|separator|').pop()}</p>
                                    </div>

                                    <div className="flex flex-col sm:flex-row gap-3 justify-center">
                                        <Button onClick={()=>handleChangeTime(manageQR)} className="bg-yellow-500 text-white px-8 py-3 rounded-2xl font-bold">تغيير وقت الجلسة</Button>
                                        <Button onClick={()=>handleStopSession(manageQR)} className="bg-red-600 text-white px-8 py-3 rounded-2xl font-bold">إيقاف الحضور يدوياً</Button>
                                    </div>
                                </>
                             ) : (
                                <div className="py-10">
                                    <p className="text-gray-400 mb-8 text-sm">هذا الرمز انتهى أو تم إيقافه. يمكنك تفعيل الحضور مجدداً.</p>
                                    <Button onClick={()=>handleCreateNewQR(manageQR)} className="bg-green-600 text-white px-10 py-4 rounded-3xl font-bold shadow-lg shadow-green-200 dark:shadow-none mx-auto">تفعيل رمز QR جديد للجلسة</Button>
                                </div>
                            )}
                        </div>
                    )}
                </Modal>
            </div>
        );
    };

    const AdminReportCourse = ({ uniData }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);

        const load = async () => {
            if(!course) return;
            setLoading(true);
            const res = await runServer('getCourseReport', { uni, course });
            setLoading(false);
            if(res.status === 'success') setData(res);
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in overflow-x-auto w-full">
                <div className="flex flex-wrap gap-4 mb-8 no-print border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option><option value="أهلية">أهلية</option></select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e=>setCourse(e.target.value)}><option value="">اختر المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}</select>
                    </div>
                    <Button loading={loading} onClick={load} className="bg-blue-600 text-white px-8 rounded-2xl font-bold">عرض البيانات</Button>
                    <button onClick={()=>window.print()} className="bg-gray-800 text-white px-8 rounded-2xl font-bold">طباعة</button>
                </div>
                {data && (
                    <table className="w-full text-xs text-center border-collapse">
                        <thead>
                            <tr className="bg-gray-50 dark:bg-gray-700 text-gray-400">
                                {data.headers.map((h,i) => <th key={i} className="p-3 border-b dark:border-gray-600 text-center font-bold">{h}</th>)}
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                            {data.rows.map((row, i) => (
                                <tr key={i} className="hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                                    {row.map((cell, j) => (
                                        <td key={j} className={`p-3 text-center ${
                                            j > 3 ? (cell ? 'text-green-600 dark:text-green-400 font-bold text-lg' : 'text-red-400 dark:text-red-500 font-bold') :
                                            j === 1 ? 'font-bold bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded-lg' :
                                            j === 2 ? 'font-bold bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300 rounded-lg' :
                                            'text-gray-700 dark:text-gray-200 font-semibold'
                                        }`}>
                                            {j > 3 ? (cell ? '✓' : '✗') : cell}
                                        </td>
                                    ))}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                )}
            </div>
        );
    };

    const AdminIsolatedReport = ({ uniData, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [courseMods, setCourseMods] = useState([]);
        const [selectedMod, setSelectedMod] = useState(user.role === 'moderator' ? user.name : '');
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
            if(course && user.role === 'admin') {
                runServer('adminAction', { type: 'getCourseModerators', uni, course }).then(res => {
                    if(res.status === 'success') {
                        setCourseMods(res.courseModerators);
                        setSelectedMod('');
                    }
                });
            }
        }, [uni, course, user.role]);

        const load = async () => {
            if(!course || !selectedMod) return;
            setLoading(true);
            const res = await runServer('getIsolatedCourseReport', { uni, course, targetModerator: selectedMod });
            setLoading(false);
            if(res.status === 'success') setData(res);
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in overflow-x-auto w-full">
                <div className="flex flex-wrap gap-4 mb-8 no-print border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option><option value="أهلية">أهلية</option></select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e=>setCourse(e.target.value)}><option value="">اختر المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}</select>
                    </div>
                    {user.role === 'admin' && (
                        <div className="flex-1 min-w-0">
                            <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={selectedMod} onChange={e=>setSelectedMod(e.target.value)}>
                                <option value="">اختر المدير...</option>
                                {courseMods.map(m=><option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>
                    )}

                    <Button loading={loading} onClick={load} className="bg-blue-600 text-white px-8 rounded-2xl font-bold">عرض التقرير المنفصل</Button>
                    <button onClick={()=>window.print()} className="bg-gray-800 text-white px-8 rounded-2xl font-bold">طباعة</button>
                </div>
                {data && (
                    <div className="fade-in">
                        <div className="mb-4 text-center print-only">
                            <h2 className="text-xl font-bold">تقرير حضور - {selectedMod}</h2>
                            <p className="text-gray-500">{course} - {uni}</p>
                        </div>
                        <table className="w-full text-xs text-center border-collapse">
                            <thead>
                                <tr className="bg-gray-50 dark:bg-gray-700 text-gray-400">
                                    {data.headers.map((h,i) => <th key={i} className="p-3 border-b dark:border-gray-600 text-center font-bold">{h}</th>)}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                                {data.rows.map((row, i) => (
                                    <tr key={i} className="hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                                        {row.map((cell, j) => (
                                            <td key={j} className={`p-3 text-center ${
                                                j > 3 ? (cell ? 'text-green-600 dark:text-green-400 font-bold text-lg' : 'text-red-400 dark:text-red-500 font-bold') :
                                                j === 1 ? 'font-bold bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded-lg' :
                                                j === 2 ? 'font-bold bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300 rounded-lg' :
                                                'text-gray-700 dark:text-gray-200 font-semibold'
                                            }`}>
                                                {j > 3 ? (cell ? '✓' : '✗') : cell}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        );
    };

    const AdminReportSession = ({ uniData, confirm, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [sessions, setSessions] = useState([]);
        const [selSession, setSelSession] = useState('');
        const [report, setReport] = useState(null);
        const [loadingSessions, setLoadingSessions] = useState(false);
        const [loadingReport, setLoadingReport] = useState(false);

        useEffect(() => {
            if(course) {
                setLoadingSessions(true);
                runServer('adminAction', { type: 'getSessionDetails', uni, course, role: user.role, name: user.name }).then(res => { 
                    setLoadingSessions(false);
                    if(res.status==='success') setSessions(res.sessions); 
                });
            }
        }, [course, uni, user.role, user.name]);

        const load = async () => {
             if(!selSession) return;
             setLoadingReport(true);
             const res = await runServer('getSessionReport', { uni, course, session: selSession, role: user.role, name: user.name });
             setLoadingReport(false);
             if(res.status === 'success') setReport(res.report);
        };

        const toggleStatus = async (item) => {
             const newStatus = item.status === 'حضور' ? 'absent' : 'present';
             const ok = await confirm({ title:'تعديل الحالة', message: `تحويل حالة الطالب إلى ${newStatus === 'present' ? 'حضور' : 'غياب'}؟`, type: 'primary' });
             if(ok) {
                const res = await runServer('updateAttendanceCell', { 
                    uni, course, rowIndex: item.rowIndex, colIndex: item.colIndex, status: newStatus, sessionName: selSession, editorName: user.name 
                });
                if(res.status === 'success') {
                    setReport(prev => prev.map(r => r.id === item.id ? { ...r, status: newStatus==='present'?'حضور':'غياب', color: newStatus==='present'?'green':'red', time: res.newValue } : r));
                }
             }
        };

        const uniqueSessionNames = Array.from(new Set(sessions.map(s => s.session)));

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-5xl mx-auto fade-in w-full">
                 <div className="flex flex-wrap gap-4 mb-8 no-print items-center border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option><option value="أهلية">أهلية</option></select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e=>setCourse(e.target.value)}><option value="">اختر المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}</select>
                    </div>
                    <div className="relative flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={selSession} onChange={e=>setSelSession(e.target.value)}>
                            <option value="">اختر الجلسة...</option>
                            {uniqueSessionNames.map((sessionName, idx)=><option key={idx} value={sessionName}>{sessionName}</option>)}
                        </select>
                        {loadingSessions && <div className="absolute left-10 top-4 loader-sm"></div>}
                    </div>
                    <Button loading={loadingReport} onClick={load} className="bg-blue-600 text-white px-8 rounded-2xl font-bold">عرض</Button>
                    <button onClick={()=>window.print()} className="bg-gray-800 text-white px-8 rounded-2xl font-bold">طباعة</button>
                </div>
               
                 {report && (
                    <div className="fade-in">
                        <div className="mb-6 flex justify-between items-center px-4">
                            <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100">{uni} - {course} - {selSession}</h2>
                            <span className="text-xs text-gray-400">إجمالي الطلاب: {report.length}</span>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-center border-collapse">
                                <thead>
                                    <tr className="bg-gray-50 dark:bg-gray-700/50 text-gray-400 font-bold uppercase tracking-wider text-[10px]">
                                        <th className="p-3 border-b dark:border-gray-600">الاسم</th>
                                        <th className="p-3 border-b dark:border-gray-600">الرقم القومي</th>
                                        <th className="p-3 border-b dark:border-gray-600">الحالة</th>
                                        <th className="p-3 border-b dark:border-gray-600">التوقيت / التفاصيل</th>
                                        <th className="p-3 border-b dark:border-gray-600 no-print">تعديل</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {report.map((r,i) => (
                                        <tr key={i} className="hover:bg-gray-50/50 dark:hover:bg-gray-700/30 transition">
                                            <td className="p-3 border-b dark:border-gray-600 font-bold text-gray-700 dark:text-gray-200">{r.name}</td>
                                            <td className="p-3 border-b dark:border-gray-600 text-gray-400">{r.id}</td>
                                            <td className={`p-3 border-b dark:border-gray-600 font-bold ${r.color==='green'?'text-green-600 dark:text-green-400':'text-red-400'}`}>
                                                <span className={`px-3 py-1 rounded-lg ${r.color==='green'?'bg-green-50 dark:bg-green-900/20':'bg-red-50 dark:bg-red-900/20'}`}>{r.status}</span>
                                            </td>
                                            <td className="p-3 border-b dark:border-gray-600 text-[10px] text-gray-400 whitespace-pre-wrap">{r.time}</td>
                                            <td className="p-3 border-b dark:border-gray-600 no-print">
                                                <button onClick={()=>toggleStatus(r)} className="text-blue-500 hover:text-blue-700 dark:hover:text-blue-300 text-xs font-bold transition p-1 bg-blue-50 dark:bg-blue-900/20 rounded-lg">تغيير</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const AdminReportStudent = ({ uniData, confirm, user }) => {
        const [uni, setUni] = useState('حكومي');
        const [course, setCourse] = useState('');
        const [query, setQuery] = useState('');
        const [results, setResults] = useState(null);
        const [loading, setLoading] = useState(false);

        const search = async () => {
            if(!course) return;
            setLoading(true);
            const res = await runServer('getStudentSearchReport', { uni, course, query, role: user.role, name: user.name });
            setLoading(false);
            if(res.status === 'success') setResults(res);
        };

        const toggle = async (student, session) => {
            const newStatus = session.val === 'حضور' ? 'absent' : 'present';
            const ok = await confirm({ title: 'تعديل السجل', message: `تغيير حالة الطالب في ${session.name}؟`, type: 'primary' });
            if(ok) {
                await runServer('updateAttendanceCell', { uni, course, rowIndex: student.rowIndex, sessionName: session.name, status: newStatus, editorName: user.name });
                search(); 
            }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-5xl mx-auto fade-in w-full">
                 <div className="flex flex-wrap gap-4 mb-8 no-print border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option><option value="أهلية">أهلية</option></select>
                    <div className="flex-1 min-w-0">
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate" value={course} onChange={e=>setCourse(e.target.value)}><option value="">اختر المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}</select>
                    </div>
                    <input type="text" className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 min-w-0 outline-none focus:border-blue-400" placeholder="الاسم أو الرقم القومي" value={query} onChange={e=>setQuery(e.target.value)} />
                    <Button loading={loading} onClick={search} className="bg-blue-600 text-white px-8 rounded-2xl font-bold">بحث</Button>
                </div>
             
                {results && (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center mb-4">
                             <h3 className="font-bold text-gray-800 dark:text-gray-200">نتائج البحث ({results.results.length})</h3>
                        </div>
                        {results.results.map((stu, i) => (
                            <div key={i} className="bg-gray-50/50 dark:bg-gray-700/20 border border-gray-100 dark:border-gray-700 rounded-3xl p-6 fade-in shadow-sm">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6 border-b border-gray-200/50 dark:border-gray-600 pb-4">
                                    <div>
                                        <h4 className="font-bold text-lg text-gray-800 dark:text-gray-100">{stu.name}</h4>
                                        <p className="text-xs text-gray-400 font-bold tracking-widest">{stu.id}</p>
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="text-center bg-green-50 dark:bg-green-900/20 px-4 py-2 rounded-2xl border border-green-100 dark:border-green-800">
                                            <span className="block text-green-600 dark:text-green-400 font-bold text-lg leading-none">{stu.present}</span>
                                            <span className="text-[10px] text-green-600 dark:text-green-400 font-bold">حضور</span>
                                        </div>
                                        <div className="text-center bg-red-50 dark:bg-red-900/20 px-4 py-2 rounded-2xl border border-red-100 dark:border-red-800">
                                            <span className="block text-red-400 dark:text-red-400 font-bold text-lg leading-none">{stu.absent}</span>
                                            <span className="text-[10px] text-red-400 dark:text-red-400 font-bold">غياب</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                                    {stu.sessions.map((s, idx) => (
                                        <div key={idx} className={`group text-center p-3 rounded-2xl cursor-pointer border-2 transition-all ${s.val==='حضور'?'bg-green-50 dark:bg-green-900/10 border-green-100 dark:border-green-900/30 text-green-700 dark:text-green-300 hover:bg-green-100':'bg-red-50 dark:bg-red-900/10 border-red-100 dark:border-red-900/30 text-red-500 dark:text-red-300 hover:bg-red-100'}`} onClick={()=>toggle(stu, s)}>
                                            <span className="block text-[10px] font-bold mb-1 opacity-60 uppercase">{s.name}</span>
                                            <span className="font-bold text-xs">{s.val}</span>
                                            <span className="block text-[9px] mt-2 opacity-0 group-hover:opacity-100 transition font-bold text-blue-500 uppercase">تعديل</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                        <button onClick={()=>window.print()} className="bg-gray-800 dark:bg-gray-700 text-white px-8 py-3 rounded-2xl font-bold w-full no-print mt-8 shadow-md">طباعة التقرير كاملاً</button>
                    </div>
                )}
            </div>
        );
    };

    // --- Global Components ---
    const Footer = () => (
        <footer className="bg-white dark:bg-gray-800 text-center p-8 text-xs text-gray-400 dark:text-gray-500 mt-auto border-t border-gray-100 dark:border-gray-700 no-print transition-colors">
            <p className="font-bold mb-4 tracking-widest uppercase text-[10px]">تم التطوير بواسطة د. عبدالله صبري</p>
            <div className="flex justify-center gap-3">
                 <a href="https://wa.me/201113515751" target="_blank" className="flex items-center gap-2 bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-400 px-5 py-2.5 rounded-2xl font-bold hover:bg-green-200 dark:hover:bg-green-900/40 transition shadow-sm border border-green-200 dark:border-green-900/30">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" className="w-5 h-5" /> 
                    <span>واتساب</span>
                </a>
                <a href="https://t.me/Dr_Abdallah_Sabry" target="_blank" className="flex items-center gap-2 bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 px-5 py-2.5 rounded-2xl font-bold hover:bg-blue-200 dark:hover:bg-blue-900/40 transition shadow-sm border border-blue-200 dark:border-blue-900/30">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" className="w-5 h-5" /> 
                    <span>تليجرام</span>
                </a>
            </div>
            <p className="mt-8 opacity-50">&copy; {new Date().getFullYear()} Attendance System. All rights reserved.</p>
        </footer>
    );

    const App = () => {
        const [user, setUser] = useState(null);
        const [checked, setChecked] = useState(false);
        const { theme, toggleTheme } = useTheme();

        useEffect(() => {
            const stored = localStorage.getItem('sys_user');
            if (stored) setUser(JSON.parse(stored));
            setChecked(true);
        }, []);

        if(!checked) return <FullScreenLoader />;

        return (
            <div className="flex flex-col min-h-screen">
                <div className="flex-1 flex flex-col">
                    {!user ? <LoginScreen onLogin={setUser} theme={theme} toggleTheme={toggleTheme} /> : 
                     (user.role === 'admin' || user.role === 'moderator') ? <AdminDashboard user={user} onLogout={()=>setUser(null)} theme={theme} toggleTheme={toggleTheme} /> : 
                     <StudentDashboard user={user} onLogout={()=>setUser(null)} theme={theme} toggleTheme={toggleTheme} />}
                </div>
                <Footer />
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
