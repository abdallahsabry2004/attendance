<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Cairo', 'sans-serif'] },
          colors: {
            dark: {
              bg: '#0f172a',
              card: '#1e293b',
              input: '#334155'
            }
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .loader-sm { border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid #3b82f6; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .dark ::-webkit-scrollbar { width: 8px; height: 8px; }
    .dark ::-webkit-scrollbar-track { background: #1e293b; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background: white; color: black; }
      .dark body { background: white; color: black; }
      aside, nav, button, .mobile-header { display: none !important; }
      main { margin: 0 !important; width: 100% !important; padding: 0 !important; }
      .max-w-6xl { max-width: none !important; }
      .dark .bg-gray-50, .dark .bg-white, .dark .bg-gray-800 { background-color: white !important; color: black !important; }
      td, th { border: 1px solid #ddd !important; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    
    // ---------------------------------------------------------
    // Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…Ù† Supabase
    // ---------------------------------------------------------
    const SUPABASE_URL = "https://peuzohchnkpcesoatjdz.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBldXpvaGNobmtwY2Vzb2F0amR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDM2MDYsImV4cCI6MjA4NzY3OTYwNn0.TFkjH9bRs5Rxa6gYvBlFpRXmAU28rri-RzeXH59gxQI"; 

    const runServer = async (action, payload = {}) => {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/run_server`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ action, payload })
        });
        
        if (!response.ok) {
            console.error("Server Error:", await response.text());
            throw "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…";
        }
        
        return await response.json();
      } catch (error) {
        console.error('Error contacting server:', error);
        throw "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
      }
    };

    // --- Hooks ---
    const useTheme = () => {
        const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'light');
        useEffect(() => {
            const root = window.document.documentElement;
            if (theme === 'dark') root.classList.add('dark');
            else root.classList.remove('dark');
            localStorage.setItem('theme', theme);
        }, [theme]);
        const toggleTheme = () => setTheme(prev => prev === 'dark' ? 'light' : 'dark');
        return { theme, toggleTheme };
    };

    // --- Components ---
    const ThemeToggle = ({ theme, toggleTheme, className }) => (
        <button onClick={toggleTheme} className={`p-2 rounded-full transition-colors ${theme==='dark' ? 'bg-gray-700 text-yellow-400 hover:bg-gray-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'} ${className}`}>
            {theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸'}
        </button>
    );

    const FullScreenLoader = ({ text }) => (
      <div className="fixed inset-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm flex flex-col justify-center items-center z-[100] fade-in">
        <div className="loader-sm border-t-blue-600 w-12 h-12 mb-4"></div>
        <span className="text-gray-700 dark:text-gray-200 font-bold">{text || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'}</span>
      </div>
    );

    const Button = ({ children, onClick, loading, className, disabled, ...props }) => (
        <button onClick={onClick} disabled={loading || disabled} className={`${className} ${loading || disabled ? 'opacity-70 cursor-not-allowed' : ''} flex items-center justify-center gap-2 transition-transform active:scale-95`} {...props}>
            {loading && <div className="loader-sm border-t-white"></div>}
            {children}
        </button>
    );

    const Modal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm fade-in overflow-y-auto">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden my-8 border border-gray-100 dark:border-gray-700">
            <div className="flex justify-between items-center p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
              <h3 className="text-lg font-bold text-gray-800 dark:text-gray-100">{title}</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 text-2xl font-bold">&times;</button>
            </div>
            <div className="p-6 max-h-[75vh] overflow-y-auto text-gray-800 dark:text-gray-200">{children}</div>
          </div>
        </div>
      );
    };

    const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, confirmText, cancelText, type = 'danger', loading }) => {
      if (!isOpen) return null;
      const btnColor = type === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700';
      return (
        <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm fade-in">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden p-6 text-center border border-gray-100 dark:border-gray-700">
            <h3 className="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">{title}</h3>
            <p className="text-gray-600 dark:text-gray-300 mb-6 whitespace-pre-wrap">{message}</p>
            <div className="flex gap-3 justify-center">
              <Button loading={loading} onClick={onConfirm} className={`${btnColor} text-white px-6 py-2 rounded-xl font-bold min-w-[100px]`}>{confirmText || 'ØªØ£ÙƒÙŠØ¯'}</Button>
              <button onClick={onClose} disabled={loading} className="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 px-6 py-2 rounded-xl font-bold hover:bg-gray-200 dark:hover:bg-gray-600 min-w-[100px]">{cancelText || 'Ø¥Ù„ØºØ§Ø¡'}</button>
            </div>
          </div>
        </div>
      );
    };

    const Toast = ({ type, message, onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, [onClose]);
      const colors = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
      return (
        <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[110] ${colors} text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 fade-in`}>
          <span className="font-bold text-sm">{message}</span>
          <button onClick={onClose} className="opacity-80 hover:opacity-100">&times;</button>
        </div>
      );
    };

    const useConfirm = () => {
        const [config, setConfig] = useState(null);
        const confirm = (props) => { return new Promise((resolve) => { setConfig({ ...props, resolve }); }); };
        const handleConfirm = () => { config.resolve(true); setConfig(null); };
        const handleCancel = () => { config.resolve(false); setConfig(null); };
        return { confirm, config, handleConfirm, handleCancel };
    };

    // --- Screens ---
    const LoginScreen = ({ onLogin, theme, toggleTheme }) => {
        const [id, setId] = useState('');
        const [password, setPassword] = useState('');
        const [step, setStep] = useState(1);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [userName, setUserName] = useState('');
        const [role, setRole] = useState('');

        const handleCheckId = async (e) => {
            e.preventDefault();
            if(id.length < 5) { setError('Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­'); return; }
            setLoading(true); setError('');
            try {
                const res = await runServer('login', { nationalId: id });
                if(res.status === 'success' && (res.role === 'admin' || res.role === 'moderator')) onLogin(res);
                else if(res.status !== 'error') {
                    setUserName(res.name); setRole(res.role);
                    setStep(res.status === 'create_password' ? 3 : 2);
                } else setError(res.message);
            } catch(e) { setError('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„'); }
            setLoading(false);
        };

        const handleSubmit = async () => {
            setLoading(true);
            const action = step === 3 ? 'registerPassword' : 'login';
            const payload = step === 3 ? { nationalId: id, newPassword: password } : { nationalId: id, password };
            try {
                const res = await runServer(action, payload);
                if(res.status === 'success') {
                    const user = { role: res.role || role || 'student', name: res.name || userName, id };
                    localStorage.setItem('sys_user', JSON.stringify(user));
                    onLogin(user);
                } else setError(res.message);
            } catch(e) { setError('Ø­Ø¯Ø« Ø®Ø·Ø£'); }
            setLoading(false);
        };

        return (
            <div className="min-h-screen bg-gray-100 dark:bg-gray-950 flex items-center justify-center p-4 relative">
                <div className="absolute top-4 left-4"><ThemeToggle theme={theme} toggleTheme={toggleTheme} /></div>
                <div className="bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl shadow-xl overflow-hidden border border-gray-100 dark:border-gray-700">
                    <div className="bg-blue-600 dark:bg-blue-700 p-8 text-center text-white"><h1 className="text-2xl font-bold mb-2">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</h1></div>
                    <div className="p-8">
                        {error && <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm font-bold text-center">{error}</div>}
                        {step === 1 ? (
                            <form onSubmit={handleCheckId}>
                                <label className="block text-gray-700 dark:text-gray-300 font-bold mb-2 text-sm">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</label>
                                <input type="number" value={id} onChange={e=>setId(e.target.value)} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none" required />
                                <Button loading={loading} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">Ø§Ù„ØªØ§Ù„ÙŠ</Button>
                            </form>
                        ) : (
                            <div>
                                <div className="text-center mb-6"><h2 className="text-xl font-bold text-gray-800 dark:text-white">{userName}</h2></div>
                                <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
                                <Button loading={loading} onClick={handleSubmit} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition mb-3">{step === 3 ? 'Ø­ÙØ¸ ÙˆØ¯Ø®ÙˆÙ„' : 'Ø¯Ø®ÙˆÙ„'}</Button>
                                <button onClick={()=>setStep(1)} className="w-full text-gray-400 text-sm">Ø±Ø¬ÙˆØ¹</button>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const StudentDashboard = ({ user, onLogout, theme, toggleTheme }) => {
        const [view, setView] = useState('home');
        const [showScanner, setShowScanner] = useState(false);
        const [toast, setToast] = useState(null);
        const { confirm, config: confirmConfig, handleConfirm, handleCancel } = useConfirm();
        const [courses, setCourses] = useState([]);
        const [selCourse, setSelCourse] = useState('');
        const [history, setHistory] = useState(null);
        const [warningsList, setWarningsList] = useState([]);
        const [loadingHistory, setLoadingHistory] = useState(false);
        const [loadingWarnings, setLoadingWarnings] = useState(false);
        
        const [isScanningFile, setIsScanningFile] = useState(false);
        const fileInputRef = useRef(null);

        useEffect(() => {
            runServer('getStudentData', { nationalId: user.id }).then(res => {
                if(res.status === 'success') setCourses(res.courses);
            });
            fetchWarnings();
        }, []);

        const fetchWarnings = () => {
            setLoadingWarnings(true);
            runServer('getStudentWarnings', { nationalId: user.id }).then(res => {
                setLoadingWarnings(false);
                if (res.status === 'success') setWarningsList(res.warnings);
            });
        };

        const handleScan = (decodedText) => {
            setShowScanner(false);
            setToast({ type: 'info', message: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...' });
            runServer('scanAttendance', { nationalId: user.id, qrData: decodedText }).then(res => {
                setToast({ type: res.status, message: res.message });
                fetchWarnings(); 
            });
        };

        const handleFileUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            setIsScanningFile(true);
            try {
                const html5QrCode = new Html5Qrcode("file-reader-main");
                const decodedText = await html5QrCode.scanFile(file, true);
                handleScan(decodedText);
            } catch (err) {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² QR ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©.");
            } finally {
                setIsScanningFile(false);
                if (fileInputRef.current) fileInputRef.current.value = "";
            }
        };
        
        const fetchHistory = () => {
             if(!selCourse) return;
             setLoadingHistory(true);
             const [uni, ...rest] = selCourse.split(" ");
             runServer('getStudentHistory', { nationalId: user.id, uni, course: rest.join(" ") }).then(res => {
                 setLoadingHistory(false);
                 if(res.status === 'success') setHistory(res.data);
             });
        };

        return (
            <div className="min-h-screen pb-24 bg-gray-50 dark:bg-gray-950 transition-colors">
                {toast && <Toast {...toast} onClose={()=>setToast(null)} />}
                <ConfirmationModal isOpen={!!confirmConfig} onClose={handleCancel} onConfirm={handleConfirm} {...confirmConfig} />
                
                <header className="bg-blue-700 dark:bg-blue-900 text-white p-6 rounded-b-3xl shadow-lg mb-6 transition-colors">
                    <div className="flex justify-between items-start">
                        <div><h1 className="text-2xl font-bold">{user.name}</h1><p className="text-blue-200 text-sm">Ø·Ø§Ù„Ø¨ - {user.id}</p></div>
                        <div className="flex gap-2">
                             <ThemeToggle theme={theme} toggleTheme={toggleTheme} className="bg-white/10 text-white hover:bg-white/20" />
                            <button onClick={()=>{localStorage.removeItem('sys_user'); onLogout()}} className="bg-white/20 p-2 rounded-full hover:bg-white/30 transition">ğŸšª</button>
                        </div>
                    </div>
                </header>

                <main className="px-4 max-w-lg mx-auto">
                    {view === 'home' && (
                        <div className="space-y-4 fade-in">
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                                <h3 className="font-bold text-lg mb-2 text-gray-800 dark:text-gray-100">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
                                <button onClick={()=>setShowScanner(true)} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg mb-3">ğŸ“· ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                                
                                <input type="file" accept="image/*" ref={fileInputRef} style={{ display: 'none' }} onChange={handleFileUpload} />
                                <div id="file-reader-main" style={{display: 'none'}}></div>
                                <button onClick={() => fileInputRef.current && fileInputRef.current.click()} disabled={isScanningFile} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md">
                                    {isScanningFile ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­..." : "ğŸ–¼ï¸ Ø±ÙØ¹ ØµÙˆØ±Ø© QR"}
                                </button>
                            </div>

                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                                <h3 className="font-bold text-gray-800 dark:text-gray-100 mb-3">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</h3>
                                <div className="flex gap-2">
                                    <input type="number" id="homeManualPinInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„Ø³Ø©" className="flex-1 bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-white border border-gray-300 dark:border-gray-600 rounded-xl p-3 text-center font-bold outline-none" />
                                    <button onClick={() => {
                                        const pin = document.getElementById('homeManualPinInput').value;
                                        if(pin && pin.length >= 4) handleScan(pin);
                                        else alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                                    }} className="bg-blue-600 text-white px-6 rounded-xl font-bold">ØªØ³Ø¬ÙŠÙ„</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'history' && (
                        <div className="fade-in space-y-4">
                             <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700">
                                <label className="block text-sm font-bold mb-2 text-gray-700 dark:text-gray-300">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø±Ø±</label>
                                <div className="flex gap-2 w-full">
                                    <select value={selCourse} onChange={e=>setSelCourse(e.target.value)} className="flex-1 min-w-0 w-full truncate border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white p-2 rounded-lg outline-none">
                                        <option value="">...</option>
                                        {courses.map(c=><option key={c} value={c}>{c}</option>)}
                                    </select>
                                    <Button loading={loadingHistory} onClick={fetchHistory} className="bg-blue-600 text-white px-6 rounded-lg font-bold">Ø¹Ø±Ø¶</Button>
                                </div>
                             </div>
                             
                              {history && (
                                 <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700">
                                     <div className="flex justify-between mb-4 bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border dark:border-gray-600">
                                         <div className="text-center"><span className="block text-xl font-bold text-green-600 dark:text-green-400">{history.presentCount}</span><span className="text-xs text-gray-500 dark:text-gray-400 font-bold">Ø­Ø¶ÙˆØ±</span></div>
                                         <div className="text-center"><span className="block text-xl font-bold text-red-600 dark:text-red-400">{history.absentCount}</span><span className="text-xs text-gray-500 dark:text-gray-400 font-bold">ØºÙŠØ§Ø¨</span></div>
                                     </div>
                                     <div className="space-y-2">
                                         {history.sessions.map((s,i) => (
                                             <div key={i} className={`flex justify-between p-3 rounded-lg border-r-4 ${s.color==='green'?'border-green-500 bg-green-50 dark:bg-green-900/10':'border-red-500 bg-red-50 dark:bg-red-900/10'}`}>
                                                 <div><p className="font-bold text-sm text-gray-800 dark:text-gray-200">{s.name}</p><p className="text-[10px] text-gray-500 dark:text-gray-400">{s.time}</p></div>
                                                 <span className={`text-[10px] font-bold px-2 py-1 rounded h-fit ${s.color==='green'?'bg-green-200 text-green-800 dark:bg-green-900 dark:text-green-200':'bg-red-200 text-red-800 dark:bg-red-900 dark:text-red-200'}`}>{s.status}</span>
                                             </div>
                                         ))}
                                     </div>
                                 </div>
                             )}
                        </div>
                    )}

                    {view === 'warnings' && (
                        <div className="fade-in space-y-4">
                            {loadingWarnings && <div className="text-center p-4"><span className="loader-sm border-t-blue-600"></span></div>}
                            {!loadingWarnings && warningsList.length === 0 && (
                                <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                                    <h3 className="font-bold text-lg text-gray-800 dark:text-gray-100">Ø³Ø¬Ù„Ùƒ Ù…Ù…ØªØ§Ø²</h3>
                                    <p className="text-sm text-gray-500 dark:text-gray-400 mt-2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø¥Ù†Ø°Ø§Ø±Ø§Øª ØºÙŠØ§Ø¨ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                                </div>
                            )}
                            {warningsList.map((w, i) => (
                                <div key={i} className={`p-6 rounded-2xl shadow-sm border ${w.type === 'warning' ? 'bg-yellow-50 border-yellow-200 dark:bg-yellow-900/20 dark:border-yellow-700/50' : 'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-700/50'}`}>
                                    <h3 className={`font-bold text-lg ${w.type === 'warning' ? 'text-yellow-800 dark:text-yellow-400' : 'text-red-800 dark:text-red-400'}`}>{w.type === 'warning' ? 'Ø¥Ù†Ø°Ø§Ø± ØºÙŠØ§Ø¨' : 'Ø­Ø±Ù…Ø§Ù† Ù…Ù† Ø§Ù„Ù…Ù‚Ø±Ø±'}</h3>
                                    <p className="font-bold text-gray-800 dark:text-gray-200 mb-1">{w.course}</p>
                                    <p className="text-sm font-bold opacity-80 mb-3 text-gray-600 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºÙŠØ§Ø¨: {w.absentCount} Ø¬Ù„Ø³Ø§Øª</p>
                                </div>
                            ))}
                        </div>
                    )}
                </main>
                
                {showScanner && (
                     <div className="fixed inset-0 z-[120] bg-black flex flex-col items-center justify-center p-4">
                         <div id="reader" className="w-full max-w-sm bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-white/30 min-h-[250px] relative mb-4"></div>
                         <ScannerController onScan={handleScan} />
                         <button onClick={()=>setShowScanner(false)} className="mt-8 bg-red-600/90 text-white px-10 py-3 rounded-full font-bold shadow-lg hover:bg-red-700 transition z-[130]">Ø¥ØºÙ„Ø§Ù‚</button>
                     </div>
                )}

                <nav className="fixed bottom-0 w-full bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex justify-around p-2 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                    <button onClick={()=>setView('home')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${view==='home'?'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20':'text-gray-400'}`}><span className="text-[10px] font-bold">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
                    <button onClick={()=>setView('history')} className={`flex flex-col items-center p-2 rounded-xl transition-colors ${view==='history'?'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20':'text-gray-400'}`}><span className="text-[10px] font-bold">Ø§Ù„Ø³Ø¬Ù„</span></button>
                    <button onClick={()=>{setView('warnings'); fetchWarnings();}} className={`flex flex-col items-center p-2 rounded-xl transition-colors relative ${view==='warnings'?'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20':'text-gray-400'}`}><span className="text-[10px] font-bold">Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</span></button>
                </nav>
            </div>
        );
    };

    const ScannerController = ({ onScan }) => {
        useEffect(() => {
            let scanner;
            const startCamera = async () => {
                try {
                    scanner = new Html5Qrcode("reader");
                    await scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: { width: 250, height: 250 } }, (txt) => { scanner.stop().then(() => onScan(txt)).catch(e => console.log(e)); }, (err) => {});
                } catch (err) { console.warn("Camera blocked", err); }
            };
            setTimeout(startCamera, 500);
            return () => { try { if(scanner && scanner.isScanning) scanner.stop(); } catch(e){} };
        }, [onScan]);
        return null;
    };

    const AdminDashboard = ({ user, onLogout, theme, toggleTheme }) => {
        const [view, setView] = useState('createSession');
        const [uniData, setUniData] = useState({});
        const [materials, setMaterials] = useState([]);
        const [moderators, setModerators] = useState([]);
        const [toast, setToast] = useState(null);
        const [isSidebarOpen, setSidebarOpen] = useState(false);
        const { confirm, config: confirmConfig, handleConfirm, handleCancel } = useConfirm();

        const refreshData = () => {
             runServer('adminAction', { type: 'getAdminData', role: user.role, name: user.name }).then(res => { 
                 if(res.status==='success') { setUniData(res.data); setMaterials(res.materials); setModerators(res.moderators); } 
             });
        };

        useEffect(() => { refreshData(); }, []);

        const renderContent = () => {
            const props = { uniData, materials, moderators, showToast: setToast, confirm, refresh: refreshData, user };
            switch(view) {
                case 'createSession': return <AdminCreateSession {...props} />;
                case 'manageCourses': return <AdminManageCourses {...props} />;
                case 'manageSessions': return <AdminManageSessions {...props} />;
                case 'manageStudents': return <AdminManageStudents {...props} />;
                case 'warningsReport': return <AdminWarningsReport {...props} />;
                case 'reportCourse': return <AdminReportCourse {...props} />;
                case 'isolatedReport': return <AdminIsolatedReport {...props} />;
                case 'reportSession': return <AdminReportSession {...props} />;
                case 'reportStudent': return <AdminReportStudent {...props} />;
                case 'manageModerators': return <AdminManageModerators {...props} />;
                default: return <div>ØªØ­Ù…ÙŠÙ„...</div>;
            }
        };

        return (
            <div className="min-h-screen bg-gray-50 dark:bg-gray-950 flex flex-col md:flex-row transition-colors">
                {toast && <Toast {...toast} onClose={()=>setToast(null)} />}
                <ConfirmationModal isOpen={!!confirmConfig} onClose={handleCancel} onConfirm={handleConfirm} {...confirmConfig} />
                
                <div className="md:hidden bg-gray-900 text-white p-4 flex justify-between items-center shadow-md sticky top-0 z-30 mobile-header">
                    <button onClick={() => setSidebarOpen(true)} className="p-1 rounded hover:bg-white/10">â˜°</button>
                    <span className="font-bold text-lg">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
                    <ThemeToggle theme={theme} toggleTheme={toggleTheme} className="bg-white/10 text-white hover:bg-white/20" />
                </div>

                {isSidebarOpen && <div className="fixed inset-0 bg-black/60 z-40 md:hidden backdrop-blur-sm fade-in" onClick={() => setSidebarOpen(false)}></div>}

                <aside className={`bg-gray-900 text-white w-64 flex-shrink-0 h-screen fixed md:sticky top-0 right-0 z-50 transition-transform duration-300 ease-in-out shadow-2xl overflow-y-auto ${isSidebarOpen ? 'translate-x-0' : 'translate-x-full md:translate-x-0'}`}>
                    <div className="p-6 border-b border-gray-800 flex justify-between items-center">
                        <div><h1 className="font-bold text-xl tracking-wide">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h1><p className="text-[10px] text-blue-400 font-bold mt-1">{user.name}</p></div>
                        <button onClick={()=>setSidebarOpen(false)} className="md:hidden text-gray-400 hover:text-white">âœ•</button>
                    </div>
                   
                    <nav className="p-3 space-y-2">
                        <div className="md:block hidden px-3 mb-2"><ThemeToggle theme={theme} toggleTheme={toggleTheme} className="w-full justify-center bg-gray-800 hover:bg-gray-700" /></div>
                        <MenuItem label="Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø©" active={view==='createSession'} onClick={()=>{setView('createSession'); setSidebarOpen(false);}} />
                        <MenuItem label="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ùˆ QR" active={view==='manageSessions'} onClick={()=>{setView('manageSessions'); setSidebarOpen(false);}} />
                        <MenuItem label="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª" active={view==='manageCourses'} onClick={()=>{setView('manageCourses'); setSidebarOpen(false);}} />
                        <MenuItem label="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨" active={view==='manageStudents'} onClick={()=>{setView('manageStudents'); setSidebarOpen(false);}} />
                        <MenuItem label="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª" active={view==='warningsReport'} onClick={()=>{setView('warningsReport'); setSidebarOpen(false);}} />
                        <div className="pt-6 pb-2 px-3 text-[10px] text-gray-500 font-bold uppercase tracking-widest">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
                        <MenuItem label="ØªÙ‚Ø±ÙŠØ± Ù…Ù‚Ø±Ø± ÙƒØ§Ù…Ù„" active={view==='reportCourse'} onClick={()=>{setView('reportCourse'); setSidebarOpen(false);}} />
                        <MenuItem label="ØªÙ‚Ø±ÙŠØ± Ù…Ù†ÙØµÙ„" active={view==='isolatedReport'} onClick={()=>{setView('isolatedReport'); setSidebarOpen(false);}} />
                        <MenuItem label="ØªÙ‚Ø±ÙŠØ± Ø¬Ù„Ø³Ø©" active={view==='reportSession'} onClick={()=>{setView('reportSession'); setSidebarOpen(false);}} />
                        <MenuItem label="Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨" active={view==='reportStudent'} onClick={()=>{setView('reportStudent'); setSidebarOpen(false);}} />
                        {user.role === 'admin' && (
                            <>
                                <div className="pt-6 pb-2 px-3 text-[10px] text-orange-500 font-bold uppercase tracking-widest">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</div>
                                <MenuItem label="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†" active={view==='manageModerators'} onClick={()=>{setView('manageModerators'); setSidebarOpen(false);}} />
                            </>
                        )}
                    </nav>
                    <div className="p-4 mt-auto border-t border-gray-800 space-y-2">
                        <button onClick={async ()=>{ const ok = await confirm({title:'ØªÙ†Ø¨ÙŠÙ‡', message:'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ', confirmText:'Ø®Ø±ÙˆØ¬'}); if(ok) { localStorage.removeItem('sys_user'); onLogout() }}} className="w-full bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white py-2.5 rounded-xl font-bold text-sm transition-all duration-300">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                    </div>
                </aside>

                <main className="flex-1 p-4 md:p-8 overflow-x-hidden w-full">
                    <div className="max-w-6xl mx-auto">{renderContent()}</div>
                </main>
            </div>
        );
    };

    const MenuItem = ({ label, active, onClick }) => (
        <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/40' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}>
            <span className="font-bold text-sm">{label}</span>
        </button>
    );

    // --- Admin Sub-Components ---
    const AdminCreateSession = ({ uniData, showToast, user }) => {
        const [uni, setUni] = useState('Ø­ÙƒÙˆÙ…ÙŠ');
        const [course, setCourse] = useState('');
        const [duration, setDuration] = useState(30);
        const [qrData, setQrData] = useState(null);
        const [creating, setCreating] = useState(false);

        const handleCreate = async () => {
             if(!course) return;
             setCreating(true);
             const res = await runServer('adminAction', { type: 'createSession', uni, course, duration, creatorName: user.name });
             setCreating(false);
             if(res.status === 'success') {
                 setQrData({ ...res, uni, course });
                 showToast({ type: 'success', message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­' });
             }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-2xl mx-auto fade-in">
                <h2 className="text-2xl font-bold mb-8 text-gray-800 dark:text-gray-100">Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label className="block font-bold text-sm mb-2 text-gray-700 dark:text-gray-300">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</label>
                        <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}>
                            <option value="Ø­ÙƒÙˆÙ…ÙŠ">Ø¬Ø§Ù…Ø¹Ø© Ø­ÙƒÙˆÙ…ÙŠØ©</option><option value="Ø£Ù‡Ù„ÙŠØ©">Ø¬Ø§Ù…Ø¹Ø© Ø£Ù‡Ù„ÙŠØ©</option>
                        </select>
                    </div>
                    <div>
                         <label className="block font-bold text-sm mb-2 text-gray-700 dark:text-gray-300">Ø§Ù„Ù…Ù‚Ø±Ø±</label>
                         <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={course} onChange={e=>setCourse(e.target.value)}>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø±Ø±...</option>
                            {(uniData[uni]||[]).map(c=><option key={c} value={c}>{c}</option>)}
                         </select>
                    </div>
                </div>
                <div className="mb-8">
                    <label className="block font-bold text-sm mb-2 text-gray-700 dark:text-gray-300">Ù…Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                    <input type="number" className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={duration} onChange={e=>setDuration(e.target.value)} />
                </div>
                
                {!qrData ? (
                    <Button loading={creating} onClick={handleCreate} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 shadow-lg">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ù…Ø²</Button>
                ) : (
                    <div className="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-3xl text-center fade-in">
                        <h3 className="text-xl font-bold text-blue-900 dark:text-blue-100 mb-4">{qrData.sessionName}</h3>
                        <div className="flex justify-center mb-4">
                             <div className="bg-white p-4 rounded-2xl shadow-sm border-2 border-blue-100">
                                <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrData.qrData)}`} className="w-48 h-48" alt="QR" />
                             </div>
                        </div>
                        <div className="bg-white dark:bg-gray-800 p-3 rounded-xl inline-block mb-6 border-2 border-dashed border-blue-300 dark:border-blue-700">
                            <p className="text-xs text-gray-500 dark:text-gray-400 mb-1 font-bold">Ø±Ù‚Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±:</p>
                            <p className="text-3xl font-bold tracking-[0.3em] text-blue-600 dark:text-blue-400">{qrData.pinCode}</p>
                        </div>
                        <button onClick={()=>setQrData(null)} className="bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-200 border border-gray-200 dark:border-gray-600 px-6 py-2.5 rounded-xl font-bold text-sm shadow-sm transition hover:bg-gray-50 dark:hover:bg-gray-600">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                )}
            </div>
        );
    };

    const AdminManageCourses = ({ uniData, refresh, showToast, confirm, user }) => {
        const [newCourse, setNewCourse] = useState('');
        const [uni, setUni] = useState('Ø­ÙƒÙˆÙ…ÙŠ');
        const [loadingAdd, setLoadingAdd] = useState(false);

        const handleAdd = async () => {
             if(!newCourse) return;
             setLoadingAdd(true);
             const res = await runServer('adminAction', { type: 'addCourse', uni, courseName: newCourse, name: user.name });
             setLoadingAdd(false);
             if(res.status === 'success') { showToast({type:'success', message:'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø±Ø± Ø¨Ù†Ø¬Ø§Ø­'}); setNewCourse(''); refresh(); }
        };

        const handleDelete = async (courseName) => {
             const ok = await confirm({ title:'Ø­Ø°Ù Ù…Ù‚Ø±Ø±', message: `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${courseName}ØŸ` });
             if(ok) {
                 const res = await runServer('adminAction', { type: 'deleteCourse', uni, courseName, role: user.role, name: user.name });
                 if(res.status==='success') { showToast({type:'success', message:'ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­'}); refresh(); }
             }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-3xl mx-auto fade-in">
                 <h2 className="text-2xl font-bold mb-8 text-gray-800 dark:text-gray-100">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
                 <div className="flex flex-col sm:flex-row gap-3 mb-8 w-full">
                     <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none w-full sm:w-auto" value={uni} onChange={e=>setUni(e.target.value)}><option value="Ø­ÙƒÙˆÙ…ÙŠ">Ø­ÙƒÙˆÙ…ÙŠ</option><option value="Ø£Ù‡Ù„ÙŠØ©">Ø£Ù‡Ù„ÙŠØ©</option></select>
                     <input type="text" className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl flex-1 min-w-0 w-full outline-none" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø±Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯" value={newCourse} onChange={e=>setNewCourse(e.target.value)} />
                     <Button loading={loadingAdd} onClick={handleAdd} className="bg-green-600 text-white px-8 rounded-2xl font-bold w-full sm:w-auto">Ø¥Ø¶Ø§ÙØ©</Button>
                 </div>
                 <div className="space-y-3">
                     {(uniData[uni]||[]).map(c => (
                         <div key={c} className="group flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-700/30 rounded-2xl border border-transparent hover:border-gray-200 dark:hover:border-gray-600 transition">
                             <span className="font-bold text-gray-700 dark:text-gray-200">{c}</span>
                             <button onClick={()=>handleDelete(c)} className="text-red-400 hover:text-red-600 transition p-2 bg-white dark:bg-gray-700 rounded-xl shadow-sm">ğŸ—‘ï¸</button>
                         </div>
                     ))}
                 </div>
            </div>
        );
    };

    const AdminManageStudents = ({ uniData, showToast, confirm }) => {
        const [uni, setUni] = useState('Ø­ÙƒÙˆÙ…ÙŠ');
        const [course, setCourse] = useState('');
        const [students, setStudents] = useState([]);
        const [loading, setLoading] = useState(false);
        const [showModal, setShowModal] = useState(false);
        const [studentForm, setStudentForm] = useState({ name: '', id: '' });

        const load = useCallback(() => {
            if (course) {
                setLoading(true);
                runServer('adminAction', { type: 'getCourseStudents', uni, course }).then(res => {
                    setLoading(false);
                    if (res.status === 'success') setStudents(res.students.sort((a, b) => a.name.localeCompare(b.name, 'ar')));
                });
            } else setStudents([]);
        }, [uni, course]);

        useEffect(load, [course, load]);

        const handleSubmit = async () => {
            if (!studentForm.name || !studentForm.id) return;
            setLoading(true);
            const res = await runServer('adminAction', { type: 'manageStudent', uni, course, actionType: 'add', studentData: studentForm });
            setLoading(false);
            if (res.status === 'success') { showToast({ type: 'success', message: 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­' }); setShowModal(false); load(); }
        };

        const handleDelete = async (stu) => {
            if (await confirm({ title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', message: `Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ${stu.name}ØŸ` })) {
                const res = await runServer('adminAction', { type: 'manageStudent', uni, course, actionType: 'delete', studentData: stu });
                if (res.status === 'success') { showToast({ type: 'success', message: 'ØªÙ… Ø§Ù„Ø­Ø°Ù' }); load(); }
            }
        };

        return (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 fade-in w-full">
                <div className="flex flex-wrap gap-4 mb-6 items-center border-b dark:border-gray-700 pb-6 w-full">
                    <select className="border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none" value={uni} onChange={e => { setUni(e.target.value); setCourse(''); }}>
                        <option value="Ø­ÙƒÙˆÙ…ÙŠ">Ø­ÙƒÙˆÙ…ÙŠ</option><option value="Ø£Ù‡Ù„ÙŠØ©">Ø£Ù‡Ù„ÙŠØ©</option>
                    </select>
                    <select className="w-full border-2 border-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-white p-3 rounded-2xl outline-none truncate flex-1" value={course} onChange={e => setCourse(e.target.value)}>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø±Ø±...</option>
                        {(uniData[uni] || []).map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                    {course && <Button onClick={() => { setStudentForm({ name: '', id: '' }); setShowModal(true); }} className="bg-green-600 text-white px-6 rounded-2xl font-bold">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</Button>}
                </div>

                {course && (
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-center border-collapse">
                            <thead><tr className="bg-gray-50 dark:bg-gray-700/50 text-gray-400 font-bold uppercase tracking-wider text-[10px]"><th className="p-3">Ù…</th><th className="p-3 text-right">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th className="p-3">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th><th className="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                            <tbody>
                                {students.map((stu, i) => (
                                    <tr key={i} className="hover:bg-gray-50/50 dark:hover:bg-gray-700/30 transition">
                                        <td className="p-3 text-gray-400">{i + 1}</td>
                                        <td className="p-3 font-bold text-gray-700 dark:text-gray-200 text-right">{stu.name}</td>
                                        <td className="p-3 text-gray-500 font-mono tracking-widest">{stu.id}</td>
                                        <td className="p-3"><button onClick={() => handleDelete(stu)} className="text-red-500 hover:bg-red-50 p-2 rounded-lg transition">ğŸ—‘ï¸</button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}

                <Modal isOpen={showModal} onClose={() => setShowModal(false)} title="Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯">
                    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø±Ø¨Ø§Ø¹ÙŠ)" value={studentForm.name} onChange={e => setStudentForm({ ...studentForm, name: e.target.value })} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none" />
                    <input type="number" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (14 Ø±Ù‚Ù…)" value={studentForm.id} onChange={e => setStudentForm({ ...studentForm, id: e.target.value })} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none" />
                    <Button loading={loading} onClick={handleSubmit} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</Button>
                </Modal>
            </div>
        );
    };

    // ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ø«Ù„ AdminManageSessions, AdminReportCourse, Ø§Ù„Ø® Ø¨Ù†ÙØ³ Ø§Ù„Ù†Ù…Ø·) ...
    // ØªÙ… Ø§Ø®ØªØµØ§Ø± Ø§Ù„ÙƒÙˆØ¯ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø­Ø¬Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…ÙˆØ¬ÙˆØ¯.
    // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… runServer Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©.

    const App = () => {
        const [user, setUser] = useState(null);
        const [checked, setChecked] = useState(false);
        const { theme, toggleTheme } = useTheme();

        useEffect(() => {
            const stored = localStorage.getItem('sys_user');
            if (stored) setUser(JSON.parse(stored));
            setChecked(true);
        }, []);

        if(!checked) return <FullScreenLoader />;

        return (
            <div className="flex flex-col min-h-screen">
                <div className="flex-1 flex flex-col">
                    {!user ? <LoginScreen onLogin={setUser} theme={theme} toggleTheme={toggleTheme} /> : 
                     (user.role === 'admin' || user.role === 'moderator') ? <AdminDashboard user={user} onLogout={()=>setUser(null)} theme={theme} toggleTheme={toggleTheme} /> : 
                     <StudentDashboard user={user} onLogout={()=>setUser(null)} theme={theme} toggleTheme={toggleTheme} />}
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
