<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>نظام الحضور</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { fontFamily: { sans: ['Cairo', 'sans-serif'] }, colors: { dark: { bg: '#0f172a', card: '#1e293b', input: '#334155' } } } }
    }
  </script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .loader-sm { border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid #3b82f6; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .dark ::-webkit-scrollbar { width: 8px; height: 8px; }
    .dark ::-webkit-scrollbar-track { background: #1e293b; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background: white; color: black; }
      .dark body { background: white; color: black; }
      aside, nav, button, .mobile-header { display: none !important; }
      main { margin: 0 !important; width: 100% !important; padding: 0 !important; }
      .max-w-6xl { max-width: none !important; }
      .dark .bg-gray-50, .dark .bg-white, .dark .bg-gray-800 { background-color: white !important; color: black !important; }
      td, th { border: 1px solid #ddd !important; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    
    // ==========================================
    // 1. إعدادات قاعدة البيانات
    // ==========================================
    const SUPABASE_URL = "https://peuzohchnkpcesoatjdz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBldXpvaGNobmtwY2Vzb2F0amR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDM2MDYsImV4cCI6MjA4NzY3OTYwNn0.TFkjH9bRs5Rxa6gYvBlFpRXmAU28rri-RzeXH59gxQI";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==========================================
    // 2. محرك الاتصال (Backend Logic)
    // ==========================================
    const runServer = async (action, payload = {}) => {
      try {
        if (action === 'login') {
            const res = await supabaseClient.from('users_data').select('*').eq('national_id', payload.nationalId).maybeSingle();
            if (res.error || !res.data) return { status: 'error', message: 'الرقم القومي غير مسجل' };
            if (!payload.password) {
                if (!res.data.password || res.data.password.trim() === '') return { status: 'create_password', role: res.data.role, name: res.data.full_name };
                return { status: 'require_password', role: res.data.role, name: res.data.full_name };
            }
            if (res.data.password !== payload.password) return { status: 'error', message: 'كلمة المرور غير صحيحة' };
            return { status: 'success', role: res.data.role, name: res.data.full_name };
        }

        if (action === 'registerPassword' || action === 'changePassword') {
            const res = await supabaseClient.from('users_data').update({ password: payload.newPassword }).eq('national_id', payload.nationalId);
            if (res.error) return { status: 'error', message: 'الطالب غير موجود' };
            if (action === 'registerPassword') {
                const userRes = await supabaseClient.from('users_data').select('role, full_name').eq('national_id', payload.nationalId).single();
                return { status: 'success', message: 'تم الحفظ', role: userRes.data.role, name: userRes.data.full_name };
            }
            return { status: 'success', message: 'تم تحديث كلمة المرور' };
        }

        if (action === 'changeModeratorPassword') {
            await supabaseClient.from('users_data').update({ password: payload.newPassword }).eq('national_id', payload.nationalId).in('role', ['admin', 'moderator']);
            return { status: 'success', message: 'تم التحديث بنجاح' };
        }

        if (action === 'getStudentData') {
            const res = await supabaseClient.from('users_data').select('id, course_enrollments(courses(university, course_name))').eq('national_id', payload.nationalId).single();
            if (res.error || !res.data) return { status: 'error', courses: [] };
            const coursesList = res.data.course_enrollments.map(e => e.courses.university + " " + e.courses.course_name);
            return { status: 'success', courses: coursesList };
        }

        // تسجيل الحضور للطالب (شامل قوانين الحرمان والدمج)
        if (action === 'scanAttendance') {
            let stuRes = await supabaseClient.from('users_data').select('id, full_name').eq('national_id', payload.nationalId).single();
            if (!stuRes.data) return { status: 'error', message: 'الطالب غير موجود' };
            let student = stuRes.data;

            let sessRes = await supabaseClient.from('sessions').select('*, users_data!creator_id(full_name)').or(`qr_code.eq.${payload.qrData},pin_code.eq.${payload.qrData}`).maybeSingle();
            if (!sessRes.data) return { status: 'error', message: 'الرمز غير صحيح أو الجلسة غير موجودة' };
            let sessionData = sessRes.data;

            if (!sessionData.is_active) return { status: 'error', message: 'تم إغلاق الجلسة' };
            let createdTime = new Date(sessionData.created_at);
            if (((new Date() - createdTime) / 1000 / 60) > sessionData.duration_minutes) {
                await supabaseClient.from('sessions').update({ is_active: false }).eq('id', sessionData.id);
                return { status: 'error', message: 'انتهى الوقت المحدد للجلسة' };
            }

            let enrollRes = await supabaseClient.from('course_enrollments').select('id').eq('course_id', sessionData.course_id).eq('student_id', student.id).maybeSingle();
            if (!enrollRes.data) return { status: 'error', message: 'غير مسجل في هذا المقرر' };

            // قانون الحرمان: يُحرم في الغياب رقم 5. (اذا غاب 4 مرات سابقة يُحرم)
            let prevSessRes = await supabaseClient.from('sessions').select('session_name').eq('course_id', sessionData.course_id).lt('created_at', sessionData.created_at);
            let prevSessions = prevSessRes.data || [];
            let uniquePrevNames = [...new Set(prevSessions.map(s => s.session_name))];
            
            if (uniquePrevNames.length > 0) {
                let attRes = await supabaseClient.from('attendance_logs').select('session_name').eq('student_id', student.id).eq('course_id', sessionData.course_id).in('session_name', uniquePrevNames);
                let attendedNames = new Set((attRes.data || []).map(a => a.session_name));
                let absences = uniquePrevNames.length - attendedNames.size;
                if (absences >= 4) {
                    return { status: 'error', message: 'لقد تم حرمانك من هذا المقرر لتجاوز نسبة الغياب المسموح بها، ولن يقبل النظام تسجيلك في الجلسات القادمة.' };
                }
            }

            // منع التكرار في الجلسات المدمجة
            let existRes = await supabaseClient.from('attendance_logs').select('scanned_by, users_data!scanned_by(full_name)').eq('course_id', sessionData.course_id).eq('session_name', sessionData.session_name).eq('student_id', student.id).maybeSingle();
            if (existRes.data) {
                let creatorName = sessionData.users_data ? sessionData.users_data.full_name : 'غير معروف';
                let scannerName = existRes.data.users_data ? existRes.data.users_data.full_name : 'مدير آخر';
                if (existRes.data.scanned_by === sessionData.creator_id) return { status: 'error', message: `تم تسجيل الحضور مسبقاً مع ${creatorName}` };
                else return { status: 'error', message: `مسجل حضور بالفعل مع ${scannerName}` };
            }

            await supabaseClient.from('attendance_logs').insert({ course_id: sessionData.course_id, session_name: sessionData.session_name, student_id: student.id, scanned_by: sessionData.creator_id });
            return { status: 'success', message: 'تم تسجيل الحضور بنجاح' };
        }

        if (action === 'getStudentHistory') {
            const cRes = await supabaseClient.from('courses').select('id').eq('university', payload.uni).eq('course_name', payload.course).single();
            const sRes = await supabaseClient.from('users_data').select('id').eq('national_id', payload.nationalId).single();
            if (!cRes.data || !sRes.data) return { status: 'error' };

            const allSess = await supabaseClient.from('sessions').select('session_name, created_at').eq('course_id', cRes.data.id).order('created_at', { ascending: true });
            const orderedNames = [...new Set((allSess.data || []).map(s => s.session_name))];

            const attRes = await supabaseClient.from('attendance_logs').select('session_name, scanned_at, users_data!scanned_by(full_name)').eq('student_id', sRes.data.id).eq('course_id', cRes.data.id);
            const attendance = attRes.data || [];

            let presentCount = 0; let absentCount = 0; let formattedSessions = [];
            orderedNames.forEach(sName => {
                const record = attendance.find(a => a.session_name === sName);
                if (record) {
                    presentCount++;
                    const manager = record.users_data ? record.users_data.full_name : '';
                    formattedSessions.push({ name: sName, status: 'حضور', time: `${new Date(record.scanned_at).toLocaleString('ar-EG', {timeZone: 'Africa/Cairo'})} - (مع ${manager})`, color: 'green' });
                } else {
                    absentCount++;
                    const sInfo = allSess.data.find(x => x.session_name === sName);
                    formattedSessions.push({ name: sName, status: 'غياب', time: sInfo ? new Date(sInfo.created_at).toLocaleString('ar-EG', {timeZone: 'Africa/Cairo'}) : '-', color: 'red' });
                }
            });
            return { status: 'success', data: { sessions: formattedSessions, presentCount, absentCount } };
        }

        if (action === 'getStudentWarnings') {
            const sRes = await supabaseClient.from('users_data').select('id').eq('national_id', payload.nationalId).single();
            if (!sRes.data) return { status: 'success', warnings: [] };
            
            const eRes = await supabaseClient.from('course_enrollments').select('course_id, courses(university, course_name)').eq('student_id', sRes.data.id);
            const enrollments = eRes.data || [];
            if (enrollments.length === 0) return { status: 'success', warnings: [] };

            const cIds = enrollments.map(e => e.course_id);
            const allSessRes = await supabaseClient.from('sessions').select('course_id, session_name').in('course_id', cIds);
            const attRes = await supabaseClient.from('attendance_logs').select('course_id, session_name').eq('student_id', sRes.data.id).in('course_id', cIds);

            let warnings = [];
            enrollments.forEach(en => {
                const cName = en.courses.university + " " + en.courses.course_name;
                const cSessions = (allSessRes.data || []).filter(s => s.course_id === en.course_id);
                const uniqueNames = [...new Set(cSessions.map(s => s.session_name))];
                let absCount = 0;
                uniqueNames.forEach(sName => {
                    if (!(attRes.data || []).some(a => a.course_id === en.course_id && a.session_name === sName)) absCount++;
                });

                if (absCount >= 3) {
                    warnings.push({ course: cName, absentCount: absCount, type: absCount >= 4 ? 'deprived' : 'warning' });
                }
            });
            return { status: 'success', warnings };
        }

        if (action === 'adminAction') {
            const { type, role, name, uni, course, courseName } = payload;
            let uRes = await supabaseClient.from('users_data').select('id').eq('full_name', name).maybeSingle();
            let adminUuid = uRes.data ? uRes.data.id : null;

            if (type === 'getAdminData') {
                const cRes = await supabaseClient.from('courses').select('id, university, course_name');
                let allowed = cRes.data || [];
                
                // المدير المساعد يرى فقط المقررات المرتبطة به في course_managers
                if (role === 'moderator' && adminUuid) {
                    const cmRes = await supabaseClient.from('course_managers').select('course_id').eq('user_id', adminUuid);
                    const myIds = (cmRes.data || []).map(cm => cm.course_id);
                    allowed = allowed.filter(c => myIds.includes(c.id));
                }

                const tree = {};
                allowed.forEach(c => {
                    if (!tree[c.university]) tree[c.university] = [];
                    tree[c.university].push(c.course_name);
                });

                const modRes = await supabaseClient.from('users_data').select('national_id, full_name').eq('role', 'moderator');
                const materials = [...new Set((cRes.data || []).map(c => c.course_name))];
                return { status: 'success', data: tree, materials, moderators: modRes.data || [] };
            }

            if (type === 'getCourseModerators') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (!cRes.data) return { status: 'success', courseModerators: [] };
                
                const sRes = await supabaseClient.from('sessions').select('users_data!creator_id(full_name)').eq('course_id', cRes.data.id);
                let mods = new Set();
                (sRes.data || []).forEach(s => {
                    if (s.users_data && s.users_data.full_name !== 'المدير العام' && s.users_data.full_name !== 'admin') mods.add(s.users_data.full_name);
                });
                return { status: 'success', courseModerators: Array.from(mods) };
            }

            if (type === 'addModerator') {
                await supabaseClient.from('users_data').insert({ national_id: payload.id, full_name: name, password: payload.password, role: 'moderator' });
                return { status: 'success' };
            }

            if (type === 'deleteModerator') {
                await supabaseClient.from('users_data').delete().eq('national_id', payload.id).eq('role', 'moderator');
                return { status: 'success' };
            }

            if (type === 'addCourse') {
                let cId;
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', courseName).maybeSingle();
                if (!cRes.data) {
                    const ins = await supabaseClient.from('courses').insert({ university: uni, course_name: courseName, created_by: adminUuid }).select('id').single();
                    cId = ins.data.id;
                } else {
                    cId = cRes.data.id;
                }
                // دمج المادة للمدير
                await supabaseClient.from('course_managers').upsert({ course_id: cId, user_id: adminUuid });
                return { status: 'success' };
            }

            if (type === 'deleteCourse') {
                if (role === 'admin') {
                    await supabaseClient.from('courses').delete().eq('university', uni).eq('course_name', courseName);
                } else if (adminUuid) {
                    const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', courseName).single();
                    if (cRes.data) {
                        const cId = cRes.data.id;
                        // حذف ارتباط هذا المدير والمحتوى التابع له فقط
                        await supabaseClient.from('course_managers').delete().eq('course_id', cId).eq('user_id', adminUuid);
                        await supabaseClient.from('sessions').delete().eq('course_id', cId).eq('creator_id', adminUuid);
                        await supabaseClient.from('attendance_logs').delete().eq('course_id', cId).eq('scanned_by', adminUuid);
                        
                        // إن لم يتبق مدراء يتم حذف الكورس بالكامل
                        const countRes = await supabaseClient.from('course_managers').select('*', {count: 'exact', head: true}).eq('course_id', cId);
                        if (countRes.count === 0) await supabaseClient.from('courses').delete().eq('id', cId);
                    }
                }
                return { status: 'success' };
            }

            if (type === 'getLastSession') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (!cRes.data) return { status: 'success', lastSession: 'لا يوجد' };
                
                let q = supabaseClient.from('sessions').select('session_name').eq('course_id', cRes.data.id);
                if (role === 'moderator' && adminUuid) q = q.eq('creator_id', adminUuid);
                
                const sRes = await q;
                const count = new Set((sRes.data || []).map(s => s.session_name)).size;
                return { status: 'success', lastSession: count > 0 ? "الجلسة " + count : 'لا يوجد' };
            }

            if (type === 'createSession' || type === 'changeQR') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (!cRes.data) return { status: 'error', message: 'المقرر غير موجود' };
                let cId = cRes.data.id;

                const pinCode = Math.floor(100000 + Math.random() * 900000).toString();
                let targetSessionName = payload.sessionNameOverride;

                if (type === 'createSession') {
                    let q = supabaseClient.from('sessions').select('session_name').eq('course_id', cId);
                    if (role === 'moderator' && adminUuid) q = q.eq('creator_id', adminUuid);
                    
                    const sRes = await q;
                    const count = new Set((sRes.data || []).map(s => s.session_name)).size;
                    targetSessionName = "الجلسة " + (count + 1);
                    
                    const qrData = `${uni}|separator|${course}|separator|${targetSessionName}|separator|${pinCode}`;
                    await supabaseClient.from('sessions').insert({ course_id: cId, session_name: targetSessionName, qr_code: qrData, pin_code: pinCode, duration_minutes: payload.duration, creator_id: adminUuid });
                    return { status: 'success', qrData, sessionName: targetSessionName, pinCode };
                }

                if (type === 'changeQR') {
                    const qrData = `${uni}|separator|${course}|separator|${targetSessionName}|separator|${pinCode}`;
                    let updQ = supabaseClient.from('sessions').update({ duration_minutes: payload.duration, qr_code: qrData, pin_code: pinCode, is_active: true, created_at: new Date().toISOString() }).eq('course_id', cId).eq('session_name', targetSessionName);
                    if (role === 'moderator' && adminUuid) updQ = updQ.eq('creator_id', adminUuid);
                    await updQ;
                    return { status: 'success', qrData, sessionName: targetSessionName, pinCode };
                }
            }

            if (type === 'getSessionDetails') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (!cRes.data) return { status: 'error' };
                
                let q = supabaseClient.from('sessions').select('id, session_name, is_active, qr_code, created_at, duration_minutes, creator_id, users_data!creator_id(full_name)').eq('course_id', cRes.data.id);
                if (role === 'moderator' && adminUuid) q = q.eq('creator_id', adminUuid);
                const sRes = await q;
                
                const countRes = await supabaseClient.from('course_enrollments').select('*', {count: 'exact', head: true}).eq('course_id', cRes.data.id);
                let totalStu = countRes.count || 0;

                let stats = [];
                for(let s of (sRes.data || [])) {
                    let attRes = await supabaseClient.from('attendance_logs').select('*', {count: 'exact', head: true}).eq('course_id', cRes.data.id).eq('session_name', s.session_name).eq('scanned_by', s.creator_id);
                    let present = attRes.count || 0;
                    
                    // نرسل التاريخ للواجهة لكي تقوم الواجهة بتحديث الحالة ديناميكياً
                    stats.push({
                        session: s.session_name, present, absent: totalStu - present,
                        isActiveDb: s.is_active, duration: s.duration_minutes, creationDateISO: s.created_at,
                        qrCode: s.qr_code, creationDate: new Date(s.created_at).toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' }),
                        creator: s.users_data ? s.users_data.full_name : 'غير معروف'
                    });
                }
                stats.sort((a,b) => a.session.localeCompare(b.session, 'ar', {numeric: true}));
                return { status: 'success', sessions: stats };
            }

            if (type === 'toggleQR') {
                await supabaseClient.from('sessions').update({ is_active: payload.newStatus === 'يعمل' }).eq('qr_code', payload.qrCode);
                return { status: 'success' };
            }

            if (type === 'deleteSession') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (cRes.data) {
                    if (role === 'admin') {
                        await supabaseClient.from('sessions').delete().eq('course_id', cRes.data.id).eq('session_name', payload.sessionName);
                        await supabaseClient.from('attendance_logs').delete().eq('course_id', cRes.data.id).eq('session_name', payload.sessionName);
                    } else if (adminUuid) {
                        await supabaseClient.from('sessions').delete().eq('course_id', cRes.data.id).eq('session_name', payload.sessionName).eq('creator_id', adminUuid);
                        await supabaseClient.from('attendance_logs').delete().eq('course_id', cRes.data.id).eq('session_name', payload.sessionName).eq('scanned_by', adminUuid);
                    }
                }
                return { status: 'success' };
            }

            if (type === 'getCourseStudents') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (!cRes.data) return { status: 'error' };
                const eRes = await supabaseClient.from('course_enrollments').select('users_data(full_name, national_id, password)').eq('course_id', cRes.data.id);
                const students = (eRes.data || []).map((e, idx) => ({ name: e.users_data.full_name, id: e.users_data.national_id, pass: e.users_data.password, rowIndex: idx }));
                return { status: 'success', students };
            }

            if (type === 'manageStudent') {
                const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
                if (!cRes.data) return { status: 'error' };
                const cId = cRes.data.id;
                
                const { actionType, studentData, bulkStudents } = payload;
                
                if (actionType === 'bulkAdd' && bulkStudents) {
                    for(let stu of bulkStudents) {
                        let uRes = await supabaseClient.from('users_data').select('id').eq('national_id', stu.id).maybeSingle();
                        let uId = uRes.data ? uRes.data.id : null;
                        if (!uId) {
                            let ins = await supabaseClient.from('users_data').insert({ national_id: stu.id, full_name: stu.name, password: '', role: 'student' }).select('id').single();
                            uId = ins.data?.id;
                        }
                        if(uId) await supabaseClient.from('course_enrollments').upsert({ course_id: cId, student_id: uId });
                    }
                    return { status: 'success', message: 'تم الإضافة للجميع بنجاح' };
                }

                if (actionType === 'add' || actionType === 'edit') {
                    let uRes = await supabaseClient.from('users_data').select('id').eq('national_id', studentData.id).maybeSingle();
                    let uId;
                    if (!uRes.data) {
                        let ins = await supabaseClient.from('users_data').insert({ national_id: studentData.id, full_name: studentData.name, password: studentData.pass || '', role: 'student' }).select('id').single();
                        uId = ins.data.id;
                    } else {
                        uId = uRes.data.id;
                        if (actionType === 'edit') await supabaseClient.from('users_data').update({ full_name: studentData.name, password: studentData.pass || '' }).eq('id', uId);
                    }
                    if (actionType === 'add') await supabaseClient.from('course_enrollments').upsert({ course_id: cId, student_id: uId });
                } else if (actionType === 'delete') {
                    let uRes = await supabaseClient.from('users_data').select('id').eq('national_id', studentData.id).single();
                    if (uRes.data) await supabaseClient.from('course_enrollments').delete().eq('course_id', cId).eq('student_id', uRes.data.id);
                }
                return { status: 'success' };
            }
        }

        if (action === 'getCourseReport') {
            const cRes = await supabaseClient.from('courses').select('id').eq('university', payload.uni).eq('course_name', payload.course).single();
            if (!cRes.data) return { status: 'error' };
            const sRes = await supabaseClient.from('sessions').select('session_name').eq('course_id', cRes.data.id).order('created_at', {ascending: true});
            const uniqueNames = [...new Set((sRes.data || []).map(s=>s.session_name))];
            
            const eRes = await supabaseClient.from('course_enrollments').select('users_data(id, full_name, national_id)').eq('course_id', cRes.data.id);
            const attRes = await supabaseClient.from('attendance_logs').select('student_id, session_name, scanned_at, users_data!scanned_by(full_name)').eq('course_id', cRes.data.id);
            
            const headers = ["اسم الطالب", "حضور", "غياب", "الرقم القومي", ...uniqueNames];
            const rows = (eRes.data || []).map(e => {
                let p = 0, a = 0;
                const stu = e.users_data;
                const statusCols = uniqueNames.map(sn => {
                    if ((attRes.data || []).some(x => x.student_id === stu.id && x.session_name === sn)) { p++; return "✔️"; }
                    a++; return "";
                });
                return [stu.full_name, p, a, stu.national_id, ...statusCols];
            }).sort((a,b) => String(a[0]).localeCompare(String(b[0]), 'ar'));
            
            return { status: 'success', headers, rows, count: rows.length };
        }

        if (action === 'getIsolatedCourseReport') {
            const { uni, course, targetModerator } = payload;
            const uRes = await supabaseClient.from('users_data').select('id').eq('full_name', targetModerator).maybeSingle();
            const modId = uRes.data ? uRes.data.id : null;

            const cRes = await supabaseClient.from('courses').select('id').eq('university', uni).eq('course_name', course).single();
            if (!cRes.data) return { status: 'error' };

            const sRes = await supabaseClient.from('sessions').select('session_name').eq('course_id', cRes.data.id).order('created_at', {ascending: true});
            const eRes = await supabaseClient.from('course_enrollments').select('users_data(id, full_name, national_id)').eq('course_id', cRes.data.id);
            
            let q = supabaseClient.from('attendance_logs').select('student_id, session_name').eq('course_id', cRes.data.id);
            if (modId) q = q.eq('scanned_by', modId);
            const attRes = await q;

            const modSessionNames = [...new Set((attRes.data || []).map(a => a.session_name))];
            const orderedNames = [...new Set((sRes.data||[]).map(s=>s.session_name))].filter(n => modSessionNames.includes(n));
            
            const headers = ["اسم الطالب", "حضور", "غياب", "الرقم القومي", ...orderedNames];
            const rows = (eRes.data || []).map(e => {
                let p = 0, a = 0;
                const stu = e.users_data;
                const statusCols = orderedNames.map(sn => {
                    if ((attRes.data || []).some(x => x.student_id === stu.id && x.session_name === sn)) { p++; return "✔️"; }
                    a++; return "";
                });
                return [stu.full_name, p, a, stu.national_id, ...statusCols];
            }).sort((a,b) => String(a[0]).localeCompare(String(b[0]), 'ar'));
            
            return { status: 'success', headers, rows, count: rows.length };
        }

        return { status: 'error', message: 'الإجراء غير مدعوم' };
      } catch (err) {
        console.error('Database Error:', err);
        return { status: 'error', message: 'تعذر الاتصال بالخادم السحابي' };
      }
    };

    // ==========================================
    // 3. Components
    // ==========================================
    const useTheme = () => {
        const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'light');
        useEffect(() => {
            const root = window.document.documentElement;
            if (theme === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
            localStorage.setItem('theme', theme);
        }, [theme]);
        const toggleTheme = () => setTheme(prev => prev === 'dark' ? 'light' : 'dark');
        return { theme, toggleTheme };
    };

    const ThemeToggle = ({ theme, toggleTheme, className }) => (
        <button onClick={toggleTheme} className={`p-2 rounded-full transition-colors ${theme==='dark' ? 'bg-gray-700 text-yellow-400 hover:bg-gray-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'} ${className}`}>
            {theme === 'dark' ? 
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg> 
                : <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>}
        </button>
    );

    const FullScreenLoader = ({ text }) => (
      <div className="fixed inset-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm flex flex-col justify-center items-center z-[100] fade-in">
        <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <span className="text-gray-700 dark:text-gray-200 font-bold">{text || 'جاري التحميل...'}</span>
      </div>
    );

    const Button = ({ children, onClick, loading, className, disabled, ...props }) => (
        <button onClick={onClick} disabled={loading || disabled} className={`${className} ${loading || disabled ? 'opacity-70 cursor-not-allowed' : ''} flex items-center justify-center gap-2 transition-transform active:scale-95`} {...props} >
            {loading && <div className="loader-sm border-t-white"></div>} {children}
        </button>
    );

    const Modal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm fade-in overflow-y-auto">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden my-8 border border-gray-100 dark:border-gray-700">
            <div className="flex justify-between items-center p-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
              <h3 className="text-lg font-bold text-gray-800 dark:text-gray-100">{title}</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-red-600 dark:text-gray-400 text-2xl font-bold">&times;</button>
            </div>
            <div className="p-6 max-h-[75vh] overflow-y-auto text-gray-800 dark:text-gray-200">{children}</div>
          </div>
        </div>
      );
    };

    const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, confirmText, cancelText, type = 'danger', loading }) => {
      if (!isOpen) return null;
      const btnColor = type === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700';
      return (
        <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm fade-in">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden p-6 text-center border border-gray-100 dark:border-gray-700">
            <h3 className="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">{title}</h3>
            <p className="text-gray-600 dark:text-gray-300 mb-6 whitespace-pre-wrap">{message}</p>
            <div className="flex gap-3 justify-center">
              <Button loading={loading} onClick={onConfirm} className={`${btnColor} text-white px-6 py-2 rounded-xl font-bold min-w-[100px]`}>{confirmText || 'تأكيد'}</Button>
              <button onClick={onClose} disabled={loading} className="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 px-6 py-2 rounded-xl font-bold hover:bg-gray-200 min-w-[100px]">{cancelText || 'إلغاء'}</button>
            </div>
          </div>
        </div>
      );
    };

    const Toast = ({ type, message, onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, [onClose]);
      const colors = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
      return (
        <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[110] ${colors} text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 fade-in`}>
          <span className="font-bold text-sm">{message}</span><button onClick={onClose} className="opacity-80 hover:opacity-100">&times;</button>
        </div>
      );
    };

    const useConfirm = () => {
        const [config, setConfig] = useState(null);
        const confirm = (props) => { return new Promise((resolve) => { setConfig({ ...props, resolve }); }); };
        const handleConfirm = () => { config.resolve(true); setConfig(null); };
        const handleCancel = () => { config.resolve(false); setConfig(null); };
        return { confirm, config, handleConfirm, handleCancel };
    };

    // ==========================================
    // واجهات النظام 
    // ==========================================
    const LoginScreen = ({ onLogin, theme, toggleTheme }) => {
        const [id, setId] = useState(''); const [password, setPassword] = useState(''); const [step, setStep] = useState(1); const [showPass, setShowPass] = useState(false); const [loading, setLoading] = useState(false); const [error, setError] = useState(''); const [userName, setUserName] = useState(''); const [role, setRole] = useState('');
        const handleCheckId = async (e) => { e.preventDefault(); if(id.length < 5) { setError('الرقم غير صحيح'); return; } setLoading(true); setError(''); try { const res = await runServer('login', { nationalId: id }); if(res.status === 'success' && (res.role === 'admin' || res.role === 'moderator')) onLogin(res); else if(res.status !== 'error') { setUserName(res.name); setRole(res.role); setStep(res.status === 'create_password' ? 3 : 2); } else setError(res.message); } catch(e) { setError('فشل الاتصال'); } setLoading(false); };
        const handleSubmit = async () => { setLoading(true); const action = step === 3 ? 'registerPassword' : 'login'; try { const res = await runServer(action, { nationalId: id, password, newPassword: password }); if(res.status === 'success') { const user = { role: res.role || role || 'student', name: res.name || userName, id, password }; localStorage.setItem('sys_user', JSON.stringify(user)); onLogin(user); } else setError(res.message); } catch(e) { setError('حدث خطأ'); } setLoading(false); };
        return (
            <div className="min-h-screen bg-gray-100 dark:bg-gray-950 flex items-center justify-center p-4 relative">
                <div className="absolute top-4 left-4"><ThemeToggle theme={theme} toggleTheme={toggleTheme} /></div>
                {loading && <FullScreenLoader />}
                <div className="bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl shadow-xl overflow-hidden border border-gray-100 dark:border-gray-700">
                    <div className="bg-blue-600 p-8 text-center text-white"><h1 className="text-2xl font-bold mb-2">نظام الحضور</h1></div>
                    <div className="p-8">
                        {error && <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm font-bold text-center">{error}</div>}
                        {step === 1 ? (
                            <form onSubmit={handleCheckId}>
                                <label className="block text-gray-700 dark:text-gray-300 font-bold mb-2 text-sm">الرقم القومي</label>
                                <input type="number" value={id} onChange={e=>setId(e.target.value)} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl mb-4 outline-none" required />
                                <Button loading={loading} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">التالي</Button>
                            </form>
                        ) : (
                            <div>
                                <div className="text-center mb-6"><p className="text-gray-500 text-sm">مرحباً</p><h2 className="text-xl font-bold dark:text-white">{userName}</h2>{step === 3 && <span className="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded">تعيين كلمة مرور جديدة</span>}</div>
                                <div className="relative mb-4"><input type={showPass ? "text" : "password"} value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-xl outline-none" placeholder="كلمة المرور" /><button onClick={()=>setShowPass(!showPass)} className="absolute left-3 top-3 text-gray-400 text-sm font-bold">{showPass ? 'إخفاء' : 'إظهار'}</button></div>
                                <Button loading={loading} onClick={handleSubmit} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mb-3">{step === 3 ? 'حفظ ودخول' : 'دخول'}</Button><button onClick={()=>setStep(1)} className="w-full text-gray-400 hover:text-gray-600 text-sm">رجوع</button>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const StudentDashboard = ({ user, onLogout, theme, toggleTheme }) => {
        const [view, setView] = useState('home'); const [showScanner, setShowScanner] = useState(false); const [toast, setToast] = useState(null); const { confirm, config: confirmConfig, handleConfirm, handleCancel } = useConfirm(); const [courses, setCourses] = useState([]); const [selCourse, setSelCourse] = useState(''); const [history, setHistory] = useState(null); const [warningsList, setWarningsList] = useState([]); const [loadingHistory, setLoadingHistory] = useState(false); const [showEditPass, setShowEditPass] = useState(false); const [newPass, setNewPass] = useState('');

        useEffect(() => { runServer('getStudentData', { nationalId: user.id }).then(res => { if(res.status === 'success') setCourses(res.courses); }); fetchWarnings(); }, []);
        const fetchWarnings = () => { runServer('getStudentWarnings', { nationalId: user.id }).then(res => { if (res.status === 'success') setWarningsList(res.warnings); }); };
        const handleScan = (decodedText) => { setShowScanner(false); setToast({ type: 'info', message: 'جاري التسجيل...' }); runServer('scanAttendance', { nationalId: user.id, qrData: decodedText }).then(res => { setToast({ type: res.status, message: res.message }); fetchWarnings(); }); };
        const fetchHistory = () => { if(!selCourse) return; setLoadingHistory(true); const [uni, ...rest] = selCourse.split(" "); runServer('getStudentHistory', { nationalId: user.id, uni, course: rest.join(" ") }).then(res => { setLoadingHistory(false); if(res.status === 'success') setHistory(res.data); }); };
        const handleChangePassword = async () => { if(await confirm({ title: 'تأكيد التعديل', message: 'تغيير كلمة المرور؟' })) { runServer('changePassword', { nationalId: user.id, newPassword: newPass }).then(res => { setToast({ type: res.status, message: res.message }); if(res.status==='success') setShowEditPass(false); }); } };

        return (
            <div className="min-h-screen pb-24 bg-gray-50 dark:bg-gray-950 transition-colors">
                {toast && <Toast {...toast} onClose={()=>setToast(null)} />}
                <ConfirmationModal isOpen={!!confirmConfig} onClose={handleCancel} onConfirm={handleConfirm} {...confirmConfig} />
                
                <header className="bg-blue-700 text-white p-6 rounded-b-3xl shadow-lg mb-6 no-print">
                    <div className="flex justify-between items-start">
                        <div><h1 className="text-2xl font-bold">{user.name}</h1><p className="text-blue-200 text-sm">طالب - {user.id}</p></div>
                        <div className="flex gap-2"><ThemeToggle theme={theme} toggleTheme={toggleTheme} className="bg-white/10" /><button onClick={onLogout} className="bg-white/20 p-2 rounded-full"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg></button></div>
                    </div>
                </header>

                <main className="px-4 max-w-lg mx-auto">
                    {view === 'home' && (
                        <div className="space-y-4 fade-in">
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm text-center border dark:border-gray-700">
                                <h3 className="font-bold text-lg mb-2 dark:text-white">تسجيل الحضور بالكاميرا</h3>
                                <button onClick={()=>setShowScanner(true)} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">فتح الكاميرا المباشرة</button>
                            </div>
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm text-center border dark:border-gray-700">
                                <h3 className="font-bold dark:text-white mb-3">إدخال الرقم السري يدوياً</h3>
                                <div className="flex gap-2">
                                    <input type="number" id="homeManualPinInput" placeholder="الرقم السري" className="flex-1 bg-gray-50 border p-3 text-center outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                    <button onClick={() => handleScan(document.getElementById('homeManualPinInput').value)} className="bg-blue-600 text-white px-6 rounded-xl font-bold">تسجيل</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'history' && (
                        <div className="fade-in space-y-4">
                             <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm no-print border dark:border-gray-700">
                                <label className="block text-sm font-bold mb-2 dark:text-white">اختر المقرر</label>
                                <div className="flex gap-2 w-full"><select value={selCourse} onChange={e=>setSelCourse(e.target.value)} className="flex-1 border p-2 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">...</option>{courses.map(c=><option key={c} value={c}>{c}</option>)}</select><Button loading={loadingHistory} onClick={fetchHistory} className="bg-blue-600 text-white px-6 rounded-lg font-bold">عرض</Button></div>
                             </div>
                             
                              {history && (
                                 <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 print-only-container">
                                     <div className="flex justify-between mb-4 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg border dark:border-gray-600">
                                         <div className="text-center"><span className="block text-xl font-bold text-green-600">{history.presentCount}</span><span className="text-xs font-bold dark:text-gray-300">حضور</span></div>
                                         <div className="text-center"><span className="block text-xl font-bold text-red-600">{history.absentCount}</span><span className="text-xs font-bold dark:text-gray-300">غياب</span></div>
                                     </div>
                                     <div className="space-y-2">
                                         {history.sessions.map((s,i) => (
                                             <div key={i} className={`flex justify-between p-3 rounded-lg border-r-4 ${s.color==='green'?'border-green-500 bg-green-50 dark:bg-green-900/10':'border-red-500 bg-red-50 dark:bg-red-900/10'}`}>
                                                 <div><p className="font-bold text-sm dark:text-gray-200">{s.name}</p><p className="text-[10px] text-gray-500 dark:text-gray-400">{s.time}</p></div>
                                                 <span className={`text-[10px] font-bold px-2 py-1 rounded h-fit ${s.color==='green'?'bg-green-200 text-green-800':'bg-red-200 text-red-800'}`}>{s.status}</span>
                                             </div>
                                         ))}
                                     </div>
                                     <button onClick={() => window.print()} className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold mt-4 shadow-md no-print">طباعة السجل</button>
                                 </div>
                             )}
                        </div>
                    )}

                    {view === 'warnings' && (
                        <div className="fade-in space-y-4">
                            {warningsList.length === 0 && <div className="bg-white p-8 rounded-2xl text-center dark:bg-gray-800 dark:border-gray-700 border"><h3 className="font-bold text-green-500">سجلك ممتاز</h3></div>}
                            {warningsList.map((w, i) => (
                                <div key={i} className={`p-6 rounded-2xl border shadow-sm ${w.type === 'warning' ? 'bg-yellow-50 border-yellow-200' : 'bg-red-50 border-red-200'}`}>
                                    <h3 className={`font-bold text-lg mb-1 ${w.type === 'warning' ? 'text-yellow-800' : 'text-red-800'}`}>{w.type === 'warning' ? 'إنذار غياب' : 'حرمان من المقرر'}</h3>
                                    <p className="font-bold mb-1 dark:text-gray-800">{w.course}</p>
                                    <p className="text-sm font-bold opacity-80 text-gray-700">إجمالي الغياب: {w.absentCount} جلسات</p>
                                    {w.type === 'warning' && <p className="text-xs font-bold text-yellow-700 mt-2">يرجى الانتباه! غياب جلسة أخرى سيؤدي إلى حرمانك نهائياً من هذا المقرر.</p>}
                                    {w.type === 'deprived' && <p className="text-xs font-bold text-red-700 mt-2">لقد تم حرمانك من هذا المقرر لتجاوز نسبة الغياب المسموح بها، ولن يقبل النظام تسجيلك في الجلسات القادمة.</p>}
                                </div>
                            ))}
                        </div>
                    )}
                </main>
                
                {showScanner && (
                     <div className="fixed inset-0 z-[120] bg-black flex flex-col items-center justify-center p-4">
                         <div className="text-white font-bold mb-6 bg-white/20 px-6 py-2 rounded-full">وجه الكاميرا نحو الرمز</div>
                         <div id="reader" className="w-full max-w-sm bg-black rounded-2xl border-4 border-white/30 min-h-[250px] mb-4"></div>
                         <button onClick={()=>setShowScanner(false)} className="mt-8 bg-red-600 text-white px-10 py-3 rounded-full font-bold z-[130]">إلغاء و إغلاق</button>
                     </div>
                )}

                <nav className="fixed bottom-0 w-full bg-white border-t flex justify-around p-2 z-50 no-print dark:bg-gray-800 dark:border-gray-700">
                    <button onClick={()=>setView('home')} className={`flex flex-col items-center p-2 rounded-xl ${view==='home'?'text-blue-600 bg-blue-50 dark:bg-blue-900/20':'text-gray-400'}`}><span className="text-[10px] font-bold">الرئيسية</span></button>
                    <button onClick={()=>setView('history')} className={`flex flex-col items-center p-2 rounded-xl ${view==='history'?'text-blue-600 bg-blue-50 dark:bg-blue-900/20':'text-gray-400'}`}><span className="text-[10px] font-bold">السجل</span></button>
                    <button onClick={()=>setView('warnings')} className={`flex flex-col items-center p-2 rounded-xl ${view==='warnings'?'text-blue-600 bg-blue-50 dark:bg-blue-900/20':'text-gray-400'}`}><span className="text-[10px] font-bold">الإنذارات</span></button>
                </nav>
            </div>
        );
    };

    const AdminDashboard = ({ user, onLogout, theme, toggleTheme }) => {
        const [view, setView] = useState('createSession');
        const [uniData, setUniData] = useState({}); const [materials, setMaterials] = useState([]); const [moderators, setModerators] = useState([]);
        const [toast, setToast] = useState(null); const [isSidebarOpen, setSidebarOpen] = useState(false);
        const { confirm, config: confirmConfig, handleConfirm, handleCancel } = useConfirm();

        const refreshData = () => { runServer('adminAction', { type: 'getAdminData', role: user.role, name: user.name }).then(res => { if(res.status==='success') { setUniData(res.data); setMaterials(res.materials); setModerators(res.moderators); } }); };
        useEffect(() => { refreshData(); }, []);

        const renderContent = () => {
            const props = { uniData, materials, moderators, showToast: setToast, confirm, refresh: refreshData, user };
            switch(view) {
                case 'createSession': return <AdminCreateSession {...props} />; case 'manageCourses': return <AdminManageCourses {...props} />; case 'manageSessions': return <AdminManageSessions {...props} />; case 'manageStudents': return <AdminManageStudents {...props} />; case 'reportCourse': return <AdminReportCourse {...props} />; case 'isolatedReport': return <AdminIsolatedReport {...props} />; case 'reportSession': return <AdminReportSession {...props} />; default: return <div>...</div>;
            }
        };

        return (
            <div className="min-h-screen bg-gray-50 flex flex-col md:flex-row dark:bg-gray-950">
                {toast && <Toast {...toast} onClose={()=>setToast(null)} />}
                <ConfirmationModal isOpen={!!confirmConfig} onClose={handleCancel} onConfirm={handleConfirm} {...confirmConfig} />
                
                <div className="md:hidden bg-gray-900 text-white p-4 flex justify-between items-center shadow-md sticky top-0 z-30 mobile-header">
                    <button onClick={() => setSidebarOpen(true)} className="p-1 rounded font-bold">لوحة الإدارة ☰</button>
                    <ThemeToggle theme={theme} toggleTheme={toggleTheme} className="bg-white/10" />
                </div>

                <aside className={`bg-gray-900 text-white w-64 flex-shrink-0 h-screen fixed md:sticky top-0 right-0 z-50 transition-transform overflow-y-auto ${isSidebarOpen ? 'translate-x-0' : 'translate-x-full md:translate-x-0'}`}>
                    <div className="p-6 border-b border-gray-800"><h1 className="font-bold text-xl">الإدارة الذكية</h1><p className="text-[10px] text-blue-400 mt-1">{user.name}</p></div>
                    <nav className="p-3 space-y-2">
                        <MenuItem label="إنشاء جلسة" active={view==='createSession'} onClick={()=>{setView('createSession'); setSidebarOpen(false);}} />
                        <MenuItem label="إدارة الجلسات" active={view==='manageSessions'} onClick={()=>{setView('manageSessions'); setSidebarOpen(false);}} />
                        <MenuItem label="إدارة المقررات" active={view==='manageCourses'} onClick={()=>{setView('manageCourses'); setSidebarOpen(false);}} />
                        <MenuItem label="إدارة الطلاب (إكسيل)" active={view==='manageStudents'} onClick={()=>{setView('manageStudents'); setSidebarOpen(false);}} />
                        <div className="pt-6 pb-2 px-3 text-[10px] text-gray-500 font-bold uppercase">التقارير</div>
                        <MenuItem label="تقرير مقرر كامل" active={view==='reportCourse'} onClick={()=>{setView('reportCourse'); setSidebarOpen(false);}} />
                        <MenuItem label="تقرير منفصل" active={view==='isolatedReport'} onClick={()=>{setView('isolatedReport'); setSidebarOpen(false);}} />
                    </nav>
                    <div className="p-4 mt-auto border-t border-gray-800"><button onClick={onLogout} className="w-full bg-red-600/20 text-red-400 py-2 rounded font-bold">تسجيل خروج</button></div>
                </aside>
                <main className="flex-1 p-4 md:p-8 overflow-x-hidden"><div className="max-w-6xl mx-auto">{renderContent()}</div></main>
            </div>
        );
    };

    const MenuItem = ({ label, active, onClick }) => ( <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${active ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:bg-gray-800'}`}><span className="font-bold text-sm">{label}</span></button> );

    const AdminCreateSession = ({ uniData, showToast, user }) => {
        const [uni, setUni] = useState('حكومي'); const [course, setCourse] = useState(''); const [duration, setDuration] = useState(30); const [qrData, setQrData] = useState(null); const [creating, setCreating] = useState(false);
        const handleCreate = async () => { if(!course) return; setCreating(true); const res = await runServer('adminAction', { type: 'createSession', uni, course, duration, name: user.name, role: user.role }); setCreating(false); if(res.status === 'success') { setQrData({ ...res, uni, course }); showToast({ type: 'success', message: 'تم إنشاء الجلسة بنجاح' }); } };
        return (
            <div className="bg-white p-6 rounded-3xl border fade-in dark:bg-gray-800 dark:border-gray-700">
                <h2 className="text-2xl font-bold mb-8 dark:text-white">إنشاء جلسة جديدة</h2>
                <div className="flex gap-6 mb-6">
                    <select className="border-2 p-3 rounded-2xl w-1/2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومية</option><option value="أهلية">أهلية</option></select>
                    <select className="border-2 p-3 rounded-2xl w-1/2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={course} onChange={e=>setCourse(e.target.value)}><option value="">المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c}>{c}</option>)}</select>
                </div>
                {!qrData ? <Button loading={creating} onClick={handleCreate} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold">إنشاء وتوليد الرمز</Button> : <div className="text-center fade-in"><div className="bg-green-100 text-green-700 py-1 px-4 rounded-full text-xs font-bold inline-block mb-4">تم الإنشاء</div><h3 className="text-xl font-bold mb-4 dark:text-white">{qrData.sessionName}</h3><div className="flex justify-center mb-4"><div className="bg-white p-4 border-2"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrData.qrData)}`} className="w-48 h-48" /></div></div><p className="text-3xl font-bold tracking-[0.3em] text-blue-600 mb-6">{qrData.pinCode || qrData.qrData.split('|separator|').pop()}</p><button onClick={()=>setQrData(null)} className="bg-gray-800 text-white px-6 py-2 rounded-xl">إغلاق</button></div>}
            </div>
        );
    };

    const AdminManageCourses = ({ uniData, materials, refresh, showToast, confirm, user }) => {
        const [newCourse, setNewCourse] = useState(''); const [uni, setUni] = useState('حكومي'); const [loadingAdd, setLoadingAdd] = useState(false);
        const handleAdd = async () => { if(!newCourse) return; setLoadingAdd(true); const res = await runServer('adminAction', { type: 'addCourse', uni, courseName: newCourse, name: user.name, role: user.role }); setLoadingAdd(false); if(res.status === 'success') { showToast({type:'success', message:'تم إضافة المقرر'}); setNewCourse(''); refresh(); } };
        const handleDelete = async (courseName) => { if(await confirm({ title:'حذف مقرر', message: `هل تريد حذف المقرر؟ ${user.role==='admin'?'سيحذف للجميع':'سيحذف من عندك فقط'}` })) { await runServer('adminAction', { type: 'deleteCourse', uni, courseName, role: user.role, name: user.name }); showToast({type:'success', message:'تم الحذف'}); refresh(); } };
        return (
            <div className="bg-white p-6 rounded-3xl border fade-in dark:bg-gray-800 dark:border-gray-700">
                 <h2 className="text-2xl font-bold mb-8 dark:text-white">إدارة المقررات (مدمجة)</h2>
                 <div className="flex gap-3 mb-8">
                     <select className="border-2 p-3 rounded-2xl dark:bg-gray-700 dark:text-white dark:border-gray-600" value={uni} onChange={e=>setUni(e.target.value)}><option value="حكومي">حكومي</option></select>
                     <input type="text" list="materials-list" className="border-2 p-3 rounded-2xl flex-1 dark:bg-gray-700 dark:text-white dark:border-gray-600" placeholder="أدخل مقرر جديد أو اختر من القائمة" value={newCourse} onChange={e=>setNewCourse(e.target.value)} />
                     <datalist id="materials-list">{materials.map(m=><option key={m} value={m} />)}</datalist>
                     <Button loading={loadingAdd} onClick={handleAdd} className="bg-green-600 text-white px-8 rounded-2xl font-bold">إضافة المقرر لك</Button>
                 </div>
                 <div className="space-y-3">
                     {(uniData[uni]||[]).map(c => <div key={c} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border dark:bg-gray-700 dark:border-gray-600"><span className="font-bold dark:text-white">{c}</span><button onClick={()=>handleDelete(c)} className="text-red-500 font-bold">حذف</button></div>)}
                 </div>
            </div>
        );
    };

    const AdminManageStudents = ({ uniData, showToast, confirm, user }) => {
        const [uni, setUni] = useState('حكومي'); const [course, setCourse] = useState(''); const [bulkText, setBulkText] = useState(''); const [loading, setLoading] = useState(false);
        const handleBulkSubmit = async () => {
            if(!bulkText.trim()) return; setLoading(true);
            const lines = bulkText.split('\n'); const bulkStudents = lines.map(l => { const parts = l.split(/\t|,|-/); if(parts.length >= 2) return { name: parts[0].trim(), id: parts[1].trim() }; return null; }).filter(Boolean);
            if(bulkStudents.length === 0) { setLoading(false); showToast({type: 'error', message: 'صيغة خاطئة'}); return; }
            const res = await runServer('adminAction', { type: 'manageStudent', uni, course, actionType: 'bulkAdd', bulkStudents });
            setLoading(false); if (res.status === 'success') { showToast({ type: 'success', message: res.message }); setBulkText(''); }
        };
        return (
            <div className="bg-white p-6 rounded-3xl border fade-in dark:bg-gray-800 dark:border-gray-700">
                <div className="flex gap-4 mb-6"><select className="border-2 p-3 rounded-2xl dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={uni} onChange={e => { setUni(e.target.value); setCourse(''); }}><option value="حكومي">حكومي</option></select><select className="flex-1 border-2 p-3 rounded-2xl dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={course} onChange={e => setCourse(e.target.value)}><option value="">اختر المقرر لإضافة الطلاب للجميع...</option>{(uniData[uni] || []).map(c => <option key={c}>{c}</option>)}</select></div>
                {course && (
                    <div className="fade-in">
                        <p className="text-sm font-bold mb-2 dark:text-white">انسخ عمود (الاسم) وبجانبه عمود (الرقم القومي) من الإكسيل والصقه هنا:</p>
                        <textarea value={bulkText} onChange={e => setBulkText(e.target.value)} className="w-full h-48 p-3 border rounded-xl mb-4 dark:bg-gray-700 dark:text-white dark:border-gray-600 whitespace-pre" placeholder="أحمد محمد     12345678901234"></textarea>
                        <Button loading={loading} onClick={handleBulkSubmit} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">تسجيل الأسماء دفعة واحدة</Button>
                    </div>
                )}
            </div>
        );
    };

    const AdminManageSessions = ({ uniData, showToast, confirm, user }) => {
        const [uni, setUni] = useState('حكومي'); const [course, setCourse] = useState(''); const [sessions, setSessions] = useState([]); const [nowTick, setNowTick] = useState(Date.now());
        const load = useCallback(() => { if(course) runServer('adminAction', { type: 'getSessionDetails', uni, course, role: user.role, name: user.name }).then(res => { if(res.status==='success') setSessions(res.sessions); }); }, [course, uni, user.role, user.name]);
        useEffect(load, [course, load]);
        useEffect(() => { const timer = setInterval(() => setNowTick(Date.now()), 10000); return () => clearInterval(timer); }, []);
        const handleDelete = async (s) => { if(await confirm({title:'حذف',message: user.role==='admin' ? 'حذف الجلسة نهائياً؟' : 'حذف حضورك فقط؟'})) { await runServer('adminAction', { type: 'deleteSession', uni, course, sessionName: s.session, role: user.role, name: user.name }); load(); } };

        return (
            <div className="bg-white p-6 rounded-3xl border fade-in dark:bg-gray-800 dark:border-gray-700">
                <div className="flex gap-4 mb-8"><select className="border-2 p-3 rounded-2xl dark:bg-gray-700 dark:text-white" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option></select><select className="flex-1 border-2 p-3 rounded-2xl dark:bg-gray-700 dark:text-white" value={course} onChange={e=>setCourse(e.target.value)}><option value="">المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c}>{c}</option>)}</select></div>
                <table className="w-full text-center text-sm dark:text-white">
                    <thead><tr><th>الجلسة</th><th>الحضور</th><th>المنشئ</th><th>الحالة المباشرة</th><th>حذف</th></tr></thead>
                    <tbody>
                        {sessions.map((s, idx) => {
                            let isWorking = s.isActiveDb;
                            if (isWorking) { const diffMins = (nowTick - new Date(s.creationDateISO).getTime()) / 1000 / 60; if (diffMins > s.duration) isWorking = false; }
                            return (
                                <tr key={idx} className="border-b dark:border-gray-700">
                                    <td className="py-4">{s.session}</td><td className="font-bold text-green-500">{s.present}</td><td className="text-xs">{s.creator}</td>
                                    <td><span className={`px-2 py-1 rounded ${isWorking?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{isWorking ? 'يعمل' : 'لا يعمل'}</span></td>
                                    <td><button onClick={()=>handleDelete(s)} className="text-red-500 font-bold">حذف</button></td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        );
    };

    const AdminReportCourse = ({ uniData }) => {
        const [uni, setUni] = useState('حكومي'); const [course, setCourse] = useState(''); const [data, setData] = useState(null); const [loading, setLoading] = useState(false);
        const load = async () => { if(!course) return; setLoading(true); const res = await runServer('getCourseReport', { uni, course }); setLoading(false); if(res.status === 'success') setData(res); };
        return (
            <div className="bg-white p-6 rounded-3xl border fade-in overflow-x-auto dark:bg-gray-800 dark:border-gray-700">
                <div className="flex gap-4 mb-8 no-print"><select className="border-2 p-3 rounded-2xl dark:bg-gray-700 dark:text-white" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option></select><select className="flex-1 border-2 p-3 rounded-2xl dark:bg-gray-700 dark:text-white" value={course} onChange={e=>setCourse(e.target.value)}><option value="">المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c}>{c}</option>)}</select><Button loading={loading} onClick={load} className="bg-blue-600 text-white px-8 rounded-2xl">عرض</Button><button onClick={()=>window.print()} className="bg-gray-800 text-white px-8 rounded-2xl">طباعة</button></div>
                {data && (
                    <div className="fade-in">
                        <div className="mb-4 text-center print-only"><h2 className="text-xl font-bold">تقرير شامل للمقرر (لجميع المديرين)</h2><p className="text-gray-500 font-bold text-lg">{course} - {uni}</p></div>
                        <table className="w-full text-xs text-center border-collapse dark:text-white">
                            <thead><tr className="bg-gray-50 dark:bg-gray-700">{data.headers.map((h,i) => <th key={i} className="p-3 border-b dark:border-gray-600">{h}</th>)}</tr></thead>
                            <tbody>{data.rows.map((row, i) => <tr key={i} className="border-b dark:border-gray-700">{row.map((cell, j) => <td key={j} className={`p-3 ${j>3&&cell?'text-green-500 font-bold':''}`}>{cell}</td>)}</tr>)}</tbody>
                        </table>
                    </div>
                )}
            </div>
        );
    };

    const AdminIsolatedReport = ({ uniData, user }) => {
        const [uni, setUni] = useState('حكومي'); const [course, setCourse] = useState(''); const [courseMods, setCourseMods] = useState([]); const [selectedMod, setSelectedMod] = useState(user.role === 'moderator' ? user.name : ''); const [data, setData] = useState(null); const [loading, setLoading] = useState(false);
        useEffect(() => { if(course && user.role === 'admin') runServer('adminAction', { type: 'getCourseModerators', uni, course }).then(res => { if(res.status === 'success') setCourseMods(res.courseModerators); }); }, [uni, course, user.role]);
        const load = async () => { if(!course || !selectedMod) return; setLoading(true); const res = await runServer('getIsolatedCourseReport', { uni, course, targetModerator: selectedMod }); setLoading(false); if(res.status === 'success') setData(res); };
        return (
            <div className="bg-white p-6 rounded-3xl border fade-in overflow-x-auto dark:bg-gray-800 dark:border-gray-700">
                <div className="flex gap-4 mb-8 no-print"><select className="border-2 p-3 rounded-2xl dark:bg-gray-700 dark:text-white" value={uni} onChange={e=>{setUni(e.target.value); setCourse('');}}><option value="حكومي">حكومي</option></select><select className="flex-1 border-2 p-3 rounded-2xl dark:bg-gray-700 dark:text-white" value={course} onChange={e=>setCourse(e.target.value)}><option value="">المقرر...</option>{(uniData[uni]||[]).map(c=><option key={c}>{c}</option>)}</select>{user.role === 'admin' && <select className="flex-1 border-2 p-3 rounded-2xl dark:bg-gray-700 dark:text-white" value={selectedMod} onChange={e=>setSelectedMod(e.target.value)}><option value="">اختر المدير...</option>{courseMods.map(m=><option key={m}>{m}</option>)}</select>}<Button loading={loading} onClick={load} className="bg-blue-600 text-white px-8 rounded-2xl">عرض</Button><button onClick={()=>window.print()} className="bg-gray-800 text-white px-8 rounded-2xl">طباعة</button></div>
                {data && (
                    <div className="fade-in">
                        <div className="mb-4 text-center print-only"><h2 className="text-xl font-bold">تقرير الحضور الخاص بـ ({selectedMod})</h2><p className="text-gray-500 font-bold text-lg">{course} - {uni}</p></div>
                        <table className="w-full text-xs text-center border-collapse dark:text-white">
                            <thead><tr className="bg-gray-50 dark:bg-gray-700">{data.headers.map((h,i) => <th key={i} className="p-3 border-b dark:border-gray-600">{h}</th>)}</tr></thead>
                            <tbody>{data.rows.map((row, i) => <tr key={i} className="border-b dark:border-gray-700">{row.map((cell, j) => <td key={j} className={`p-3 ${j>3&&cell?'text-green-500 font-bold':''}`}>{cell}</td>)}</tr>)}</tbody>
                        </table>
                    </div>
                )}
            </div>
        );
    };

    const App = () => {
        const [user, setUser] = useState(null); const [checked, setChecked] = useState(false); const { theme, toggleTheme } = useTheme();
        useEffect(() => { const stored = localStorage.getItem('sys_user'); if (stored) setUser(JSON.parse(stored)); setChecked(true); }, []);
        if(!checked) return <FullScreenLoader />;
        return ( <div className="flex flex-col min-h-screen"><div className="flex-1 flex flex-col">{!user ? <LoginScreen onLogin={setUser} theme={theme} toggleTheme={toggleTheme} /> : (user.role === 'admin' || user.role === 'moderator') ? <AdminDashboard user={user} onLogout={()=>setUser(null)} theme={theme} toggleTheme={toggleTheme} /> : <StudentDashboard user={user} onLogout={()=>setUser(null)} theme={theme} toggleTheme={toggleTheme} />}</div></div> );
    };

    const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
  </script>
</body>
</html>
